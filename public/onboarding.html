<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix - Onboarding</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', 'Consolas', monospace;
            background: #000;
            color: #00ffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background effects */
        .background {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 50% 50%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(0, 255, 255, 0.05) 0%, transparent 40%);
            pointer-events: none;
        }

        .grid-overlay {
            position: fixed;
            inset: 0;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            opacity: 0.2;
        }

        /* Container */
        .onboarding-container {
            position: relative;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .onboarding-header {
            text-align: center;
            padding: 40px 0 20px;
        }

        .phoenix-logo {
            font-size: 48px;
            margin-bottom: 12px;
            animation: float 3s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .phoenix-title {
            font-size: 32px;
            font-weight: 700;
            color: #00ffff;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
            margin-bottom: 8px;
            letter-spacing: 8px;
        }

        .phoenix-subtitle {
            color: rgba(0, 255, 255, 0.6);
            font-size: 14px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Progress Bar */
        .progress-container {
            margin: 40px 0;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 12px;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .progress-step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid rgba(0, 255, 255, 0.3);
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .progress-step.active .progress-step-circle {
            background: rgba(0, 255, 255, 0.3);
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
        }

        .progress-step.completed .progress-step-circle {
            background: rgba(0, 255, 255, 0.2);
            border-color: #00ffff;
        }

        .progress-step-label {
            font-size: 11px;
            color: rgba(0, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-step.active .progress-step-label {
            color: #00ffff;
            font-weight: 600;
        }

        .progress-line {
            position: absolute;
            top: 16px;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(0, 255, 255, 0.1);
            z-index: 0;
        }

        .progress-line-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(0, 255, 255, 0.5), #00ffff);
            transition: width 0.5s ease;
            width: 0%;
        }

        /* Phase Container */
        .phase {
            display: none;
            flex: 1;
        }

        .phase.active {
            display: block;
            animation: fadeInUp 0.4s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .phase-content {
            background: rgba(0, 10, 20, 0.9);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 16px;
            padding: 40px;
            backdrop-filter: blur(10px);
        }

        .phase-header {
            margin-bottom: 32px;
        }

        .phase-number {
            color: #00ffff;
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .phase-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 12px;
            line-height: 1.2;
            color: #00ffff;
        }

        .phase-description {
            color: rgba(0, 255, 255, 0.7);
            font-size: 15px;
            line-height: 1.6;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 24px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: rgba(0, 255, 255, 0.9);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        label .required {
            color: #00ffff;
        }

        input[type="text"],
        input[type="email"],
        input[type="date"],
        input[type="number"],
        select {
            width: 100%;
            padding: 14px 16px;
            background: rgba(0, 10, 20, 0.8);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            color: #00ffff;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #00ffff;
            background: rgba(0, 10, 20, 0.9);
            box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.2);
        }

        input.error,
        select.error {
            border-color: #ff4444;
        }

        .error-message {
            color: #ff4444;
            font-size: 12px;
            margin-top: 6px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .help-text {
            font-size: 12px;
            color: rgba(0, 255, 255, 0.5);
            margin-top: 6px;
        }

        /* Selection Cards */
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }

        .selection-card {
            background: rgba(0, 10, 20, 0.8);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            position: relative;
        }

        .selection-card:hover {
            border-color: rgba(0, 255, 255, 0.6);
            background: rgba(0, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .selection-card.selected {
            border-color: #00ffff;
            background: rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .selection-card-icon {
            font-size: 36px;
            margin-bottom: 12px;
        }

        .selection-card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #00ffff;
        }

        .selection-card-description {
            font-size: 12px;
            color: rgba(0, 255, 255, 0.6);
        }

        /* Device Cards */
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin: 24px 0;
        }

        .device-card {
            background: rgba(0, 10, 20, 0.8);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .device-card:hover {
            border-color: rgba(0, 255, 255, 0.6);
            background: rgba(0, 255, 255, 0.1);
        }

        .device-card.connected {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .device-logo {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .device-name {
            font-size: 13px;
            font-weight: 600;
            color: #00ffff;
        }

        .device-status {
            font-size: 11px;
            color: rgba(0, 255, 255, 0.5);
            margin-top: 4px;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 40px;
        }

        button {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            flex: 1;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(0, 255, 255, 0.5));
            border: 2px solid #00ffff;
            color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.5), rgba(0, 255, 255, 0.7));
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.6);
        }

        .btn-primary:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(0, 10, 20, 0.8);
            color: #00ffff;
            border: 1px solid rgba(0, 255, 255, 0.5);
        }

        .btn-secondary:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: #00ffff;
        }

        .btn-skip {
            background: transparent;
            color: rgba(0, 255, 255, 0.5);
            padding: 14px 24px;
        }

        .btn-skip:hover {
            color: rgba(0, 255, 255, 0.8);
        }

        /* Data Status */
        .data-status {
            background: rgba(0, 10, 20, 0.8);
            border: 2px dashed rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            color: rgba(0, 255, 255, 0.5);
            font-size: 14px;
            margin: 20px 0;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid rgba(0, 255, 255, 0.2);
            border-top: 3px solid #00ffff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success Animation */
        .success-animation {
            text-align: center;
            padding: 60px 20px;
        }

        .success-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.5), #00ffff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 32px;
            animation: scaleIn 0.5s ease, pulse 2s ease-in-out infinite;
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.8);
        }

        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 40px rgba(0, 255, 255, 0.8); }
            50% { box-shadow: 0 0 60px rgba(0, 255, 255, 1); }
        }

        .success-icon svg {
            width: 50px;
            height: 50px;
            stroke: #000;
            stroke-width: 3;
            fill: none;
        }

        /* Subscription Plans */
        .plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }

        .plan-card {
            background: rgba(0, 10, 20, 0.8);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            padding: 28px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .plan-card:hover {
            border-color: rgba(0, 255, 255, 0.6);
            transform: translateY(-4px);
        }

        .plan-card.recommended {
            border-color: #00ffff;
            background: rgba(0, 255, 255, 0.15);
        }

        .plan-badge {
            position: absolute;
            top: -12px;
            right: 20px;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.5), #00ffff);
            color: #000;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .plan-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #00ffff;
        }

        .plan-price {
            font-size: 32px;
            font-weight: 700;
            color: #00ffff;
            margin-bottom: 16px;
        }

        .plan-price span {
            font-size: 16px;
            color: rgba(0, 255, 255, 0.6);
        }

        .plan-features {
            list-style: none;
            margin-bottom: 20px;
        }

        .plan-features li {
            padding: 8px 0;
            font-size: 14px;
            color: rgba(0, 255, 255, 0.8);
        }

        .plan-features li::before {
            content: "âœ“";
            color: #00ff88;
            margin-right: 8px;
            font-weight: bold;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .onboarding-container {
                padding: 12px;
            }

            .phase-content {
                padding: 24px 20px;
            }

            .phoenix-title {
                font-size: 24px;
            }

            .phase-title {
                font-size: 22px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .selection-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .btn-secondary {
                order: 2;
            }

            .btn-primary {
                order: 1;
            }

            .btn-skip {
                order: 3;
            }
        }
    </style>
</head>
<body>
    <div class="background"></div>
    <div class="grid-overlay"></div>

    <div class="onboarding-container">
        <!-- Header -->
        <div class="onboarding-header">
            <div class="phoenix-logo">ðŸ”¥</div>
            <h1 class="phoenix-title">PHOENIX</h1>
            <p class="phoenix-subtitle">Autonomous Life Operating System</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-line">
                    <div class="progress-line-fill" id="progressLineFill"></div>
                </div>
                <div class="progress-step active" data-phase="1">
                    <div class="progress-step-circle">1</div>
                    <div class="progress-step-label">Voice</div>
                </div>
                <div class="progress-step" data-phase="2">
                    <div class="progress-step-circle">2</div>
                    <div class="progress-step-label">Profile</div>
                </div>
                <div class="progress-step" data-phase="3">
                    <div class="progress-step-circle">3</div>
                    <div class="progress-step-label">Devices</div>
                </div>
                <div class="progress-step" data-phase="4">
                    <div class="progress-step-circle">4</div>
                    <div class="progress-step-label">Goals</div>
                </div>
                <div class="progress-step" data-phase="5">
                    <div class="progress-step-circle">5</div>
                    <div class="progress-step-label">Calendar</div>
                </div>
                <div class="progress-step" data-phase="6">
                    <div class="progress-step-circle">6</div>
                    <div class="progress-step-label">Finance</div>
                </div>
                <div class="progress-step" data-phase="7">
                    <div class="progress-step-circle">7</div>
                    <div class="progress-step-label">Plan</div>
                </div>
                <div class="progress-step" data-phase="8">
                    <div class="progress-step-circle">8</div>
                    <div class="progress-step-label">Complete</div>
                </div>
            </div>
        </div>

        <!-- Phase 1: Voice & Language Selection -->
        <div class="phase active" id="phase1">
            <div class="phase-content">
                <div class="phase-header">
                    <div class="phase-number">Phase 1 of 8</div>
                    <h2 class="phase-title">Choose Your AI Companion</h2>
                    <p class="phase-description">Select your AI mode and voice personality for your Phoenix companion.</p>
                </div>

                <div class="form-group">
                    <label>AI Mode</label>
                    <div class="selection-grid" id="modeGrid">
                        <div class="selection-card selected" data-mode="phoenix" onclick="selectMode('phoenix')">
                            <div class="selection-card-icon">ðŸ”¥</div>
                            <div class="selection-card-title">Phoenix</div>
                            <div class="selection-card-description">Balanced Companion (JARVIS + Alfred)</div>
                        </div>
                        <div class="selection-card" data-mode="alfred" onclick="selectMode('alfred')">
                            <div class="selection-card-icon">ðŸ‡¬ðŸ‡§</div>
                            <div class="selection-card-title">Alfred</div>
                            <div class="selection-card-description">Proactive Butler</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Voice Personality</label>
                    <div class="selection-grid" id="voiceGrid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                        <div class="selection-card" data-voice="echo" onclick="selectVoice('echo')">
                            <div class="selection-card-icon">ðŸ‡¬ðŸ‡§</div>
                            <div class="selection-card-title">Echo</div>
                            <div class="selection-card-description">British Butler</div>
                        </div>
                        <div class="selection-card selected" data-voice="nova" onclick="selectVoice('nova')">
                            <div class="selection-card-icon">ðŸ˜Š</div>
                            <div class="selection-card-title">Nova</div>
                            <div class="selection-card-description">Friendly Helper</div>
                        </div>
                        <div class="selection-card" data-voice="onyx" onclick="selectVoice('onyx')">
                            <div class="selection-card-icon">ðŸ‘”</div>
                            <div class="selection-card-title">Onyx</div>
                            <div class="selection-card-description">Professional</div>
                        </div>
                        <div class="selection-card" data-voice="fable" onclick="selectVoice('fable')">
                            <div class="selection-card-icon">âœ¨</div>
                            <div class="selection-card-title">Fable</div>
                            <div class="selection-card-description">Storyteller</div>
                        </div>
                        <div class="selection-card" data-voice="shimmer" onclick="selectVoice('shimmer')">
                            <div class="selection-card-icon">ðŸŒ¸</div>
                            <div class="selection-card-title">Shimmer</div>
                            <div class="selection-card-description">Gentle Guide</div>
                        </div>
                        <div class="selection-card" data-voice="alloy" onclick="selectVoice('alloy')">
                            <div class="selection-card-icon">âš¡</div>
                            <div class="selection-card-title">Alloy</div>
                            <div class="selection-card-description">Efficient</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Language</label>
                    <div class="selection-grid" id="languageGrid">
                        <div class="data-status">Loading languages...</div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="nextPhase()">Continue</button>
                </div>
            </div>
        </div>

        <!-- Phase 2: Basic Profile -->
        <div class="phase" id="phase2">
            <div class="phase-content">
                <div class="phase-header">
                    <div class="phase-number">Phase 2 of 8</div>
                    <h2 class="phase-title">Create Your Profile</h2>
                    <p class="phase-description">Tell us about yourself to personalize your Phoenix experience.</p>
                </div>

                <form id="profileForm">
                    <div class="form-group">
                        <label for="name">Full Name <span class="required">*</span></label>
                        <input type="text" id="name" required>
                        <div class="error-message" id="nameError">Please enter your name</div>
                    </div>

                    <div class="form-group">
                        <label for="email">Email <span class="required">*</span></label>
                        <input type="email" id="email" required>
                        <div class="error-message" id="emailError">Please enter a valid email</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="timezone">Timezone <span class="required">*</span></label>
                            <select id="timezone" required>
                                <option value="">Select timezone</option>
                                <option value="America/New_York">Eastern Time (ET)</option>
                                <option value="America/Chicago">Central Time (CT)</option>
                                <option value="America/Denver">Mountain Time (MT)</option>
                                <option value="America/Los_Angeles">Pacific Time (PT)</option>
                            </select>
                            <div class="error-message" id="timezoneError">Please select a timezone</div>
                        </div>

                        <div class="form-group">
                            <label for="dateOfBirth">Date of Birth</label>
                            <input type="date" id="dateOfBirth">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="gender">Gender</label>
                            <select id="gender">
                                <option value="">Select gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                                <option value="prefer_not_to_say">Prefer not to say</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="height">Height (cm)</label>
                            <input type="number" id="height" placeholder="170">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="weight">Weight (kg)</label>
                        <input type="number" id="weight" placeholder="70">
                    </div>
                </form>

                <div class="button-group">
                    <button class="btn-secondary" onclick="previousPhase()">Back</button>
                    <button class="btn-primary" onclick="validateAndNext(2)">Continue</button>
                </div>
            </div>
        </div>

        <!-- Phase 3: Wearables -->
        <div class="phase" id="phase3">
            <div class="phase-content">
                <div class="phase-header">
                    <div class="phase-number">Phase 3 of 8</div>
                    <h2 class="phase-title">Connect Your Devices</h2>
                    <p class="phase-description">Connect wearables and health devices to automatically track your biometrics.</p>
                </div>

                <div class="device-grid" id="deviceGrid">
                    <div class="data-status">No current data</div>
                </div>

                <div class="button-group">
                    <button class="btn-secondary" onclick="previousPhase()">Back</button>
                    <button class="btn-primary" onclick="nextPhase()">Continue</button>
                    <button class="btn-skip" onclick="skipPhase(3)">Skip for now</button>
                </div>
            </div>
        </div>

        <!-- Phase 4: Goals -->
        <div class="phase" id="phase4">
            <div class="phase-content">
                <div class="phase-header">
                    <div class="phase-number">Phase 4 of 8</div>
                    <h2 class="phase-title">Set Your Goals</h2>
                    <p class="phase-description">Define your initial goals and nutrition targets.</p>
                </div>

                <div class="form-group">
                    <label>Choose a Goal Template</label>
                    <div class="selection-grid" id="goalTemplates">
                        <div class="data-status">No current data</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Nutrition Targets (Auto-calculated based on your profile)</label>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="calories">Daily Calories</label>
                            <input type="number" id="calories" placeholder="2000">
                        </div>
                        <div class="form-group">
                            <label for="protein">Protein (g)</label>
                            <input type="number" id="protein" placeholder="150">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="carbs">Carbs (g)</label>
                            <input type="number" id="carbs" placeholder="200">
                        </div>
                        <div class="form-group">
                            <label for="fats">Fats (g)</label>
                            <input type="number" id="fats" placeholder="65">
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-secondary" onclick="previousPhase()">Back</button>
                    <button class="btn-primary" onclick="saveGoals()">Continue</button>
                    <button class="btn-skip" onclick="skipPhase(4)">Skip for now</button>
                </div>
            </div>
        </div>

        <!-- Phase 5: Calendar -->
        <div class="phase" id="phase5">
            <div class="phase-content">
                <div class="phase-header">
                    <div class="phase-number">Phase 5 of 8</div>
                    <h2 class="phase-title">Connect Your Calendar</h2>
                    <p class="phase-description">Sync your calendar to enable energy-based scheduling and conflict detection.</p>
                </div>

                <div class="selection-grid">
                    <div class="selection-card" onclick="connectCalendar('google')">
                        <div class="selection-card-icon">ðŸ“…</div>
                        <div class="selection-card-title">Google Calendar</div>
                        <div class="selection-card-description">Connect Google account</div>
                    </div>
                    <div class="selection-card" onclick="connectCalendar('outlook')">
                        <div class="selection-card-icon">ðŸ“†</div>
                        <div class="selection-card-title">Outlook Calendar</div>
                        <div class="selection-card-description">Connect Microsoft account</div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-secondary" onclick="previousPhase()">Back</button>
                    <button class="btn-primary" onclick="nextPhase()">Continue</button>
                    <button class="btn-skip" onclick="skipPhase(5)">Skip for now</button>
                </div>
            </div>
        </div>

        <!-- Phase 6: Finance -->
        <div class="phase" id="phase6">
            <div class="phase-content">
                <div class="phase-header">
                    <div class="phase-number">Phase 6 of 8</div>
                    <h2 class="phase-title">Connect Your Finances</h2>
                    <p class="phase-description">Link your bank accounts to track spending and detect stress-spending patterns.</p>
                </div>

                <div class="data-status" style="margin: 40px 0;">
                    <p style="margin-bottom: 20px;">Secure connection via Plaid</p>
                    <button class="btn-primary" onclick="connectPlaid()" style="max-width: 300px; margin: 0 auto;">
                        ðŸ”’ Connect Bank Account
                    </button>
                </div>

                <div class="button-group">
                    <button class="btn-secondary" onclick="previousPhase()">Back</button>
                    <button class="btn-primary" onclick="nextPhase()">Continue</button>
                    <button class="btn-skip" onclick="skipPhase(6)">Skip for now</button>
                </div>
            </div>
        </div>

        <!-- Phase 7: Subscription -->
        <div class="phase" id="phase7">
            <div class="phase-content">
                <div class="phase-header">
                    <div class="phase-number">Phase 7 of 8</div>
                    <h2 class="phase-title">Choose Your Plan</h2>
                    <p class="phase-description">Select a subscription plan that fits your needs. Start with a 14-day free trial.</p>
                </div>

                <div class="plans-grid">
                    <div class="plan-card" onclick="selectPlan('trial')">
                        <div class="plan-badge">Start Here</div>
                        <div class="plan-name">Free Trial</div>
                        <div class="plan-price">$0 <span>/14 days</span></div>
                        <ul class="plan-features">
                            <li>Full access to all features</li>
                            <li>No credit card required</li>
                            <li>Cancel anytime</li>
                        </ul>
                    </div>

                    <div class="plan-card recommended">
                        <div class="plan-badge">Recommended</div>
                        <div class="plan-name">Phoenix Pro</div>
                        <div class="plan-price">$29 <span>/month</span></div>
                        <ul class="plan-features">
                            <li>Unlimited AI analysis</li>
                            <li>Real-time predictions</li>
                            <li>Autonomous butler actions</li>
                            <li>All integrations</li>
                        </ul>
                    </div>

                    <div class="plan-card" onclick="selectPlan('elite')">
                        <div class="plan-name">Phoenix Elite</div>
                        <div class="plan-price">$99 <span>/month</span></div>
                        <ul class="plan-features">
                            <li>Everything in Pro</li>
                            <li>Priority support</li>
                            <li>Custom AI training</li>
                            <li>API access</li>
                        </ul>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-secondary" onclick="previousPhase()">Back</button>
                    <button class="btn-primary" onclick="startTrial()">Start Free Trial</button>
                </div>
            </div>
        </div>

        <!-- Phase 8: Complete -->
        <div class="phase" id="phase8">
            <div class="phase-content">
                <div class="success-animation">
                    <div class="success-icon">
                        <svg viewBox="0 0 24 24">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <h2 class="phase-title">Welcome to Phoenix!</h2>
                    <p class="phase-description">Your autonomous life operating system is ready. Let's begin your transformation.</p>

                    <div class="loading" id="finalLoading">
                        <div class="spinner"></div>
                        <p style="color: rgba(255, 255, 255, 0.6); margin-top: 12px;">Initializing your Phoenix system...</p>
                    </div>

                    <div class="button-group" id="launchButton" style="margin-top: 40px;">
                        <button class="btn-primary" onclick="launchApp()">ðŸš€ Launch Phoenix</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // PHOENIX ONBOARDING - REAL API INTEGRATION
        // ============================================================================
        // This onboarding connects to your REAL backend with REAL developer keys:
        //
        // âœ… Backend: https://pal-backend-production.up.railway.app
        // âœ… MongoDB: Connected to your production database
        // âœ… OpenAI: GPT-4 & Whisper (your key)
        // âœ… Google: Calendar & OAuth (your keys)
        // âœ… Fitbit: Real device connection (Client ID: 23TFV7)
        // âœ… Plaid: Banking integration (Client ID: 68f089934e024f0021857ce6)
        // âœ… Stripe: Payments (Test mode keys configured)
        // âœ… Twilio: SMS & Voice (Account SID configured)
        //
        // WHAT THIS DOES:
        // - Phase 1: Saves voice personality & language to database
        // - Phase 2: Creates/updates user profile with real data
        // - Phase 3: Opens OAuth windows for Fitbit, Oura, Whoop, etc.
        // - Phase 4: Creates goals and nutrition targets in Mars & Venus
        // - Phase 5: Connects Google/Outlook Calendar via OAuth
        // - Phase 6: Opens Plaid Link with your sandbox keys
        // - Phase 7: Creates Stripe checkout session for subscriptions
        // - Phase 8: Marks onboarding complete and redirects to main app
        //
        // All data is PERSISTED to your MongoDB database.
        // All OAuth tokens are STORED securely in the backend.
        // ============================================================================

        // API Configuration - Using Real Backend
        const API_BASE = 'https://pal-backend-production.up.railway.app/api';
        const FRONTEND_URL = 'https://phoenix-fe-kappa.vercel.app';
        
        const ENDPOINTS = {
            // Phase 1: Voice & Language
            getPersonalities: `${API_BASE}/phoenix/companion/personalities`,
            getLanguages: `${API_BASE}/users/language-preferences`,
            setPersonality: `${API_BASE}/phoenix/companion/personality`,
            setLanguage: `${API_BASE}/users/language`,

            // Phase 2: Profile
            createProfile: `${API_BASE}/users/profile`,
            updateProfile: `${API_BASE}/users/profile`,
            updateSettings: `${API_BASE}/users/settings`,

            // Phase 3: Wearables (Mercury routes)
            fitbitAuth: `${API_BASE}/mercury/devices/fitbit/connect`,
            ouraAuth: `${API_BASE}/mercury/devices/oura/connect`,
            whoopAuth: `${API_BASE}/mercury/devices/whoop/connect`,
            garminAuth: `${API_BASE}/mercury/devices/garmin/connect`,
            appleHealthAuth: `${API_BASE}/mercury/devices/apple-health/connect`,
            polarAuth: `${API_BASE}/mercury/devices/polar/connect`,

            // Phase 4: Goals & Nutrition (Mars & Venus)
            createGoal: `${API_BASE}/mars/goals`,
            getGoalTemplates: `${API_BASE}/mars/goals/templates`,
            setNutritionTargets: `${API_BASE}/venus/nutrition/targets`,
            calculateMacros: `${API_BASE}/venus/nutrition/targets/calculate`,

            // Phase 5: Calendar (Earth routes)
            connectGoogle: `${API_BASE}/earth/calendar/connect/google`,
            connectOutlook: `${API_BASE}/earth/calendar/connect/outlook`,

            // Phase 6: Finance (Jupiter routes)
            plaidLinkToken: `${API_BASE}/jupiter/plaid/link-token`,
            plaidExchange: `${API_BASE}/jupiter/plaid/exchange-token`,
            connectAccount: `${API_BASE}/jupiter/accounts`,

            // Phase 7: Subscription (Stripe)
            subscriptionStatus: `${API_BASE}/subscriptions/status`,
            createCheckout: `${API_BASE}/subscriptions/checkout`,

            // Phase 8: Complete
            completeOnboarding: `${API_BASE}/users/onboarding/complete`
        };

        // Get auth token from localStorage or URL
        function getAuthToken() {
            // Check localStorage first
            let token = localStorage.getItem('phoenixToken');
            
            // If no token, check URL params (for OAuth redirects)
            if (!token) {
                const urlParams = new URLSearchParams(window.location.search);
                token = urlParams.get('token');
                if (token) {
                    localStorage.setItem('phoenixToken', token);
                }
            }
            
            return token;
        }

        // API helper with authentication
        async function apiCall(endpoint, options = {}) {
            const token = getAuthToken();
            
            const config = {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` }),
                    ...options.headers
                }
            };

            try {
                const response = await fetch(endpoint, config);
                
                // Handle 401 - redirect to login
                if (response.status === 401) {
                    localStorage.removeItem('phoenixToken');
                    window.location.href = '/login.html';
                    return null;
                }

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'API request failed');
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // State
        let currentPhase = 1;
        const totalPhases = 8;
        let onboardingData = {
            mode: 'phoenix', // Default: phoenix (JARVIS + Alfred)
            voice: 'nova', // Default: Nova
            language: 'en', // Default: English
            profile: {},
            devices: [],
            goals: [],
            nutritionTargets: {},
            selectedGoalTemplate: null,
            calendar: null,
            finance: null,
            subscription: null
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadLanguages();
            await loadDevices();
            await loadGoalTemplates();
        });

        // Navigation
        function nextPhase() {
            if (currentPhase < totalPhases) {
                document.getElementById(`phase${currentPhase}`).classList.remove('active');
                currentPhase++;
                document.getElementById(`phase${currentPhase}`).classList.add('active');
                updateProgress();
            }
        }

        function previousPhase() {
            if (currentPhase > 1) {
                document.getElementById(`phase${currentPhase}`).classList.remove('active');
                currentPhase--;
                document.getElementById(`phase${currentPhase}`).classList.add('active');
                updateProgress();
            }
        }

        function skipPhase(phase) {
            console.log(`Skipping phase ${phase}`);
            nextPhase();
        }

        function updateProgress() {
            const progress = (currentPhase / totalPhases) * 100;
            document.getElementById('progressLineFill').style.width = `${progress}%`;

            // Update step indicators
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                const phaseNum = index + 1;
                if (phaseNum < currentPhase) {
                    step.classList.add('completed');
                    step.classList.remove('active');
                } else if (phaseNum === currentPhase) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                } else {
                    step.classList.remove('active', 'completed');
                }
            });
        }

        // Phase 1: Mode, Voice & Language Selection
        
        // Mode selection (Phoenix vs Alfred)
        function selectMode(mode) {
            onboardingData.mode = mode;
            document.querySelectorAll('#modeGrid .selection-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.selection-card').classList.add('selected');
            
            console.log(`Mode selected: ${mode}`);
        }

        // Voice selection (Echo, Nova, Onyx, Fable, Shimmer, Alloy)
        function selectVoice(voice) {
            onboardingData.voice = voice;
            document.querySelectorAll('#voiceGrid .selection-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.selection-card').classList.add('selected');
            
            console.log(`Voice selected: ${voice}`);
        }

        async function loadLanguages() {
            try {
                const data = await apiCall(ENDPOINTS.getLanguages);
                
                const grid = document.getElementById('languageGrid');
                if (data && data.languages && data.languages.length > 0) {
                    grid.innerHTML = data.languages.map(l => `
                        <div class="selection-card ${l.code === 'en' ? 'selected' : ''}" onclick="selectLanguage('${l.code}')">
                            <div class="selection-card-icon">${l.flag}</div>
                            <div class="selection-card-title">${l.name}</div>
                        </div>
                    `).join('');
                } else {
                    // Fallback default languages
                    grid.innerHTML = `
                        <div class="selection-card selected" onclick="selectLanguage('en')">
                            <div class="selection-card-icon">ðŸ‡ºðŸ‡¸</div>
                            <div class="selection-card-title">English</div>
                        </div>
                        <div class="selection-card" onclick="selectLanguage('es')">
                            <div class="selection-card-icon">ðŸ‡ªðŸ‡¸</div>
                            <div class="selection-card-title">EspaÃ±ol</div>
                        </div>
                        <div class="selection-card" onclick="selectLanguage('fr')">
                            <div class="selection-card-icon">ðŸ‡«ðŸ‡·</div>
                            <div class="selection-card-title">FranÃ§ais</div>
                        </div>
                        <div class="selection-card" onclick="selectLanguage('de')">
                            <div class="selection-card-icon">ðŸ‡©ðŸ‡ª</div>
                            <div class="selection-card-title">Deutsch</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading languages:', error);
                document.getElementById('languageGrid').innerHTML = '<div class="data-status">Unable to load languages. Using defaults.</div>';
            }
        }

        async function selectPersonality(id) {
            onboardingData.personality = id;
            document.querySelectorAll('#personalityGrid .selection-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.selection-card').classList.add('selected');
            
            try {
                await apiCall(ENDPOINTS.setPersonality, {
                    method: 'POST',
                    body: JSON.stringify({ personalityId: id })
                });
            } catch (err) {
                console.error('Error setting personality:', err);
            }
        }

        async function selectLanguage(code) {
            onboardingData.language = code;
            document.querySelectorAll('#languageGrid .selection-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.selection-card').classList.add('selected');
            
            try {
                await apiCall(ENDPOINTS.setLanguage, {
                    method: 'POST',
                    body: JSON.stringify({ language: code })
                });
            } catch (err) {
                console.error('Error setting language:', err);
            }
        }

        // Phase 2: Validate and Save Profile
        function validateAndNext(phase) {
            if (phase === 2) {
                if (validateProfile()) {
                    saveProfile();
                    nextPhase();
                }
            }
        }

        function validateProfile() {
            let valid = true;

            const name = document.getElementById('name');
            if (!name.value.trim()) {
                document.getElementById('nameError').classList.add('show');
                name.classList.add('error');
                valid = false;
            } else {
                document.getElementById('nameError').classList.remove('show');
                name.classList.remove('error');
            }

            const email = document.getElementById('email');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email.value)) {
                document.getElementById('emailError').classList.add('show');
                email.classList.add('error');
                valid = false;
            } else {
                document.getElementById('emailError').classList.remove('show');
                email.classList.remove('error');
            }

            const timezone = document.getElementById('timezone');
            if (!timezone.value) {
                document.getElementById('timezoneError').classList.add('show');
                timezone.classList.add('error');
                valid = false;
            } else {
                document.getElementById('timezoneError').classList.remove('show');
                timezone.classList.remove('error');
            }

            return valid;
        }

        async function saveProfile() {
            const profileData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                timezone: document.getElementById('timezone').value,
                dateOfBirth: document.getElementById('dateOfBirth').value || null,
                gender: document.getElementById('gender').value || null,
                height: document.getElementById('height').value || null,
                weight: document.getElementById('weight').value || null
            };

            onboardingData.profile = profileData;

            try {
                // Create/update profile
                await apiCall(ENDPOINTS.updateProfile, {
                    method: 'PUT',
                    body: JSON.stringify(profileData)
                });

                // Update timezone settings
                if (profileData.timezone) {
                    await apiCall(ENDPOINTS.updateSettings, {
                        method: 'PUT',
                        body: JSON.stringify({ 
                            timezone: profileData.timezone,
                            units: {
                                weight: 'kg',
                                height: 'cm',
                                distance: 'km'
                            }
                        })
                    });
                }

                console.log('âœ… Profile saved successfully');
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Failed to save profile. Please try again.');
            }
        }

        // Phase 3: Load and Connect Devices
        async function loadDevices() {
            const devices = [
                { id: 'fitbit', name: 'Fitbit', icon: 'ðŸ“±', endpoint: ENDPOINTS.fitbitAuth },
                { id: 'oura', name: 'Oura Ring', icon: 'ðŸ’', endpoint: ENDPOINTS.ouraAuth },
                { id: 'whoop', name: 'Whoop', icon: 'âŒš', endpoint: ENDPOINTS.whoopAuth },
                { id: 'garmin', name: 'Garmin', icon: 'ðŸƒ', endpoint: ENDPOINTS.garminAuth },
                { id: 'apple', name: 'Apple Health', icon: 'ðŸŽ', endpoint: ENDPOINTS.appleHealthAuth },
                { id: 'polar', name: 'Polar', icon: 'ðŸ»â€â„ï¸', endpoint: ENDPOINTS.polarAuth }
            ];

            const grid = document.getElementById('deviceGrid');
            grid.innerHTML = devices.map(d => `
                <div class="device-card" id="device-${d.id}" onclick="connectDevice('${d.id}', '${d.endpoint}')">
                    <div class="device-logo">${d.icon}</div>
                    <div class="device-name">${d.name}</div>
                    <div class="device-status" id="status-${d.id}">Not connected</div>
                </div>
            `).join('');
        }

        async function connectDevice(deviceId, endpoint) {
            try {
                console.log(`Connecting to ${deviceId}...`);
                
                // Call backend to initiate OAuth
                const data = await apiCall(endpoint, { method: 'GET' });
                
                if (data && data.authUrl) {
                    // Open OAuth window
                    const width = 600;
                    const height = 700;
                    const left = (screen.width - width) / 2;
                    const top = (screen.height - height) / 2;
                    
                    const authWindow = window.open(
                        data.authUrl,
                        `${deviceId}_auth`,
                        `width=${width},height=${height},left=${left},top=${top},toolbar=no,location=no,status=no,menubar=no`
                    );

                    // Listen for OAuth callback
                    window.addEventListener('message', function authCallback(event) {
                        if (event.data.type === 'oauth_success' && event.data.device === deviceId) {
                            console.log(`âœ… ${deviceId} connected successfully`);
                            
                            // Update UI
                            const card = document.getElementById(`device-${deviceId}`);
                            const status = document.getElementById(`status-${deviceId}`);
                            if (card) card.classList.add('connected');
                            if (status) status.textContent = 'Connected âœ“';
                            
                            // Store in onboarding data
                            onboardingData.devices.push(deviceId);
                            
                            // Remove listener
                            window.removeEventListener('message', authCallback);
                            
                            if (authWindow && !authWindow.closed) {
                                authWindow.close();
                            }
                        }
                    });

                    // Check if window was closed without completing auth
                    const checkClosed = setInterval(() => {
                        if (authWindow && authWindow.closed) {
                            clearInterval(checkClosed);
                            console.log(`${deviceId} auth window closed`);
                        }
                    }, 500);
                } else if (data && data.success) {
                    // Device connected directly without OAuth
                    const card = document.getElementById(`device-${deviceId}`);
                    const status = document.getElementById(`status-${deviceId}`);
                    if (card) card.classList.add('connected');
                    if (status) status.textContent = 'Connected âœ“';
                    onboardingData.devices.push(deviceId);
                }
            } catch (error) {
                console.error(`Error connecting ${deviceId}:`, error);
                alert(`Failed to connect to ${deviceId}. Please try again.`);
            }
        }

        // Phase 4: Load Goal Templates and Save Goals
        async function loadGoalTemplates() {
            try {
                const data = await apiCall(ENDPOINTS.getGoalTemplates);
                
                const grid = document.getElementById('goalTemplates');
                if (data && data.templates && data.templates.length > 0) {
                    grid.innerHTML = data.templates.map(t => `
                        <div class="selection-card" data-template-id="${t.id}" onclick="selectGoalTemplate('${t.id}')">
                            <div class="selection-card-icon">${t.icon || 'ðŸŽ¯'}</div>
                            <div class="selection-card-title">${t.name}</div>
                            <div class="selection-card-description">${t.description}</div>
                        </div>
                    `).join('');
                } else {
                    // Fallback default templates
                    grid.innerHTML = `
                        <div class="selection-card" data-template-id="weight-loss" onclick="selectGoalTemplate('weight-loss')">
                            <div class="selection-card-icon">ðŸ“‰</div>
                            <div class="selection-card-title">Weight Loss</div>
                            <div class="selection-card-description">Sustainable fat loss program</div>
                        </div>
                        <div class="selection-card" data-template-id="muscle-gain" onclick="selectGoalTemplate('muscle-gain')">
                            <div class="selection-card-icon">ðŸ’ª</div>
                            <div class="selection-card-title">Muscle Gain</div>
                            <div class="selection-card-description">Build strength and size</div>
                        </div>
                        <div class="selection-card" data-template-id="endurance" onclick="selectGoalTemplate('endurance')">
                            <div class="selection-card-icon">ðŸƒ</div>
                            <div class="selection-card-title">Endurance</div>
                            <div class="selection-card-description">Marathon & cardio training</div>
                        </div>
                        <div class="selection-card" data-template-id="general-health" onclick="selectGoalTemplate('general-health')">
                            <div class="selection-card-icon">ðŸŒŸ</div>
                            <div class="selection-card-title">General Health</div>
                            <div class="selection-card-description">Overall wellness & vitality</div>
                        </div>
                    `;
                }

                // Auto-calculate macros based on profile
                await autoCalculateMacros();
            } catch (error) {
                console.error('Error loading goal templates:', error);
                document.getElementById('goalTemplates').innerHTML = '<div class="data-status">Unable to load templates. Using defaults.</div>';
            }
        }

        function selectGoalTemplate(templateId) {
            onboardingData.selectedGoalTemplate = templateId;
            document.querySelectorAll('#goalTemplates .selection-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.selection-card').classList.add('selected');
        }

        async function autoCalculateMacros() {
            try {
                // Send profile data to calculate recommended macros
                const data = await apiCall(ENDPOINTS.calculateMacros, {
                    method: 'POST',
                    body: JSON.stringify({
                        weight: onboardingData.profile.weight,
                        height: onboardingData.profile.height,
                        age: calculateAge(onboardingData.profile.dateOfBirth),
                        gender: onboardingData.profile.gender,
                        activityLevel: 'moderate',
                        goal: onboardingData.selectedGoalTemplate || 'general-health'
                    })
                });

                if (data && data.targets) {
                    document.getElementById('calories').value = Math.round(data.targets.calories) || 2000;
                    document.getElementById('protein').value = Math.round(data.targets.protein) || 150;
                    document.getElementById('carbs').value = Math.round(data.targets.carbs) || 200;
                    document.getElementById('fats').value = Math.round(data.targets.fats) || 65;
                }
            } catch (error) {
                console.error('Error calculating macros:', error);
                // Set reasonable defaults
                document.getElementById('calories').value = 2000;
                document.getElementById('protein').value = 150;
                document.getElementById('carbs').value = 200;
                document.getElementById('fats').value = 65;
            }
        }

        function calculateAge(dateOfBirth) {
            if (!dateOfBirth) return 30; // Default age
            const today = new Date();
            const birthDate = new Date(dateOfBirth);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        async function saveGoals() {
            const selectedTemplate = document.querySelector('#goalTemplates .selection-card.selected');
            
            try {
                // Create goal from template
                if (selectedTemplate) {
                    const templateId = selectedTemplate.dataset.templateId;
                    await apiCall(ENDPOINTS.createGoal, {
                        method: 'POST',
                        body: JSON.stringify({ 
                            templateId: templateId,
                            startDate: new Date().toISOString(),
                            targetDate: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString() // 90 days
                        })
                    });
                }

                // Save nutrition targets
                const nutritionData = {
                    calories: parseInt(document.getElementById('calories').value) || 2000,
                    protein: parseInt(document.getElementById('protein').value) || 150,
                    carbs: parseInt(document.getElementById('carbs').value) || 200,
                    fats: parseInt(document.getElementById('fats').value) || 65
                };

                onboardingData.nutritionTargets = nutritionData;

                await apiCall(ENDPOINTS.setNutritionTargets, {
                    method: 'POST',
                    body: JSON.stringify(nutritionData)
                });

                console.log('âœ… Goals and nutrition targets saved');
                nextPhase();
            } catch (error) {
                console.error('Error saving goals:', error);
                alert('Failed to save goals. Continuing anyway...');
                nextPhase();
            }
        }

        // Phase 5: Connect Calendar
        async function connectCalendar(provider) {
            const endpoint = provider === 'google' ? ENDPOINTS.connectGoogle : ENDPOINTS.connectOutlook;
            
            try {
                console.log(`Connecting to ${provider} Calendar...`);
                
                // Get OAuth URL from backend
                const data = await apiCall(endpoint, { method: 'GET' });
                
                if (data && data.authUrl) {
                    // Open OAuth window
                    const width = 600;
                    const height = 700;
                    const left = (screen.width - width) / 2;
                    const top = (screen.height - height) / 2;
                    
                    const authWindow = window.open(
                        data.authUrl,
                        `${provider}_calendar_auth`,
                        `width=${width},height=${height},left=${left},top=${top},toolbar=no,location=no,status=no,menubar=no`
                    );

                    // Listen for OAuth callback
                    window.addEventListener('message', function calendarCallback(event) {
                        if (event.data.type === 'calendar_connected' && event.data.provider === provider) {
                            console.log(`âœ… ${provider} Calendar connected`);
                            onboardingData.calendar = provider;
                            
                            // Show success message
                            alert(`${provider.charAt(0).toUpperCase() + provider.slice(1)} Calendar connected successfully!`);
                            
                            // Remove listener
                            window.removeEventListener('message', calendarCallback);
                            
                            if (authWindow && !authWindow.closed) {
                                authWindow.close();
                            }
                        }
                    });

                    // Check if window was closed
                    const checkClosed = setInterval(() => {
                        if (authWindow && authWindow.closed) {
                            clearInterval(checkClosed);
                            console.log(`${provider} Calendar auth window closed`);
                        }
                    }, 500);
                } else {
                    throw new Error('No auth URL received from server');
                }
            } catch (error) {
                console.error('Error connecting calendar:', error);
                alert(`Failed to connect ${provider} Calendar. You can add this later in settings.`);
            }
        }

        // Phase 6: Connect Plaid (Banking)
        async function connectPlaid() {
            try {
                console.log('Initiating Plaid connection...');
                
                // Get link token from backend
                const data = await apiCall(ENDPOINTS.plaidLinkToken, { 
                    method: 'POST',
                    body: JSON.stringify({ userId: localStorage.getItem('userId') })
                });
                
                if (!data || !data.link_token) {
                    throw new Error('Failed to get Plaid link token');
                }

                // Initialize Plaid Link
                const handler = Plaid.create({
                    token: data.link_token,
                    onSuccess: async (public_token, metadata) => {
                        console.log('âœ… Plaid connection successful');
                        console.log('Institution:', metadata.institution.name);
                        
                        try {
                            // Exchange public token for access token
                            await apiCall(ENDPOINTS.plaidExchange, {
                                method: 'POST',
                                body: JSON.stringify({ 
                                    public_token: public_token,
                                    institution: metadata.institution,
                                    accounts: metadata.accounts
                                })
                            });

                            onboardingData.finance = 'plaid';
                            alert(`Successfully connected to ${metadata.institution.name}!`);
                        } catch (error) {
                            console.error('Error exchanging token:', error);
                            alert('Connected to bank but failed to save. You can reconnect later in settings.');
                        }
                    },
                    onExit: (err, metadata) => {
                        if (err) {
                            console.error('Plaid error:', err);
                            alert('Failed to connect bank account. You can try again later in settings.');
                        } else {
                            console.log('User exited Plaid Link');
                        }
                    },
                    onEvent: (eventName, metadata) => {
                        console.log('Plaid event:', eventName, metadata);
                    }
                });

                // Open Plaid Link
                handler.open();

            } catch (error) {
                console.error('Error connecting Plaid:', error);
                alert('Unable to initialize bank connection. You can add this later in settings.');
            }
        }

        // Load Plaid SDK dynamically
        function loadPlaidSDK() {
            return new Promise((resolve, reject) => {
                if (window.Plaid) {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = 'https://cdn.plaid.com/link/v2/stable/link-initialize.js';
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Failed to load Plaid SDK'));
                document.head.appendChild(script);
            });
        }

        // Load Plaid when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadPlaidSDK().catch(err => {
                console.error('Failed to load Plaid SDK:', err);
            });
        });

        // Phase 7: Select Plan and Start Trial
        function selectPlan(planId) {
            document.querySelectorAll('.plan-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.plan-card').classList.add('selected');
            onboardingData.subscription = planId;
        }

        async function startTrial() {
            try {
                console.log('Starting trial subscription...');
                
                // Create Stripe checkout session
                const data = await apiCall(ENDPOINTS.createCheckout, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        plan: onboardingData.subscription || 'trial',
                        successUrl: `${FRONTEND_URL}/onboarding.html?phase=8&status=success`,
                        cancelUrl: `${FRONTEND_URL}/onboarding.html?phase=7&status=cancelled`
                    })
                });

                if (data && data.url) {
                    // Redirect to Stripe Checkout
                    window.location.href = data.url;
                } else if (data && data.success) {
                    // Trial activated without payment
                    console.log('âœ… Trial activated');
                    onboardingData.subscription = 'trial';
                    nextPhase();
                } else {
                    throw new Error('Failed to create checkout session');
                }
            } catch (error) {
                console.error('Error starting trial:', error);
                alert('Failed to start trial. Continuing with limited access...');
                onboardingData.subscription = 'free';
                nextPhase();
            }
        }

        // Check for Stripe callback on page load
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');
            const phase = urlParams.get('phase');
            
            if (status === 'success' && phase === '8') {
                console.log('âœ… Payment successful');
                onboardingData.subscription = 'paid';
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (status === 'cancelled') {
                alert('Payment cancelled. You can upgrade later in settings.');
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        // Phase 8: Complete and Launch
        async function launchApp() {
            document.getElementById('launchButton').style.display = 'none';
            document.getElementById('finalLoading').classList.add('show');

            try {
                // Send complete onboarding data to backend
                const completeData = {
                    ...onboardingData.profile,
                    personality: onboardingData.personality,
                    language: onboardingData.language,
                    devices: onboardingData.devices,
                    nutritionTargets: onboardingData.nutritionTargets,
                    selectedGoalTemplate: onboardingData.selectedGoalTemplate,
                    calendar: onboardingData.calendar,
                    finance: onboardingData.finance,
                    subscription: onboardingData.subscription,
                    completedAt: new Date().toISOString(),
                    onboardingVersion: '1.0'
                };

                await apiCall(ENDPOINTS.completeOnboarding, {
                    method: 'POST',
                    body: JSON.stringify(completeData)
                });

                console.log('âœ… Onboarding completed successfully');
                
                // Wait a moment for effect
                setTimeout(() => {
                    // Redirect to main app
                    window.location.href = '/index.html';
                }, 2000);

            } catch (error) {
                console.error('Error completing onboarding:', error);
                
                // Still redirect even if API call fails
                setTimeout(() => {
                    window.location.href = '/index.html';
                }, 2000);
            }
        }

        // Initialize everything
        (async function initOnboarding() {
            console.log('ðŸ”¥ Phoenix Onboarding Initialized');
            
            // Check if user is authenticated
            const token = getAuthToken();
            if (!token) {
                console.warn('No auth token found - user needs to login first');
                // Uncomment to enforce authentication:
                // window.location.href = '/login.html';
                // return;
            }
            
            // Load initial data
            try {
                await Promise.all([
                    loadPersonalities(),
                    loadLanguages(),
                    loadDevices(),
                    loadGoalTemplates()
                ]);
                
                console.log('âœ… Onboarding data loaded successfully');
            } catch (error) {
                console.error('Error loading onboarding data:', error);
            }
        })();
    </script>
</body>
</html>
