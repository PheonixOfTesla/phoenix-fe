// ============================================================================
// ONBOARDING.HTML - OAUTH CALLBACK HANDLER
// ============================================================================
// Replace the existing "Check for Stripe callback on page load" section
// (around line 1414 in your onboarding.html) with this code:
// ============================================================================

// Check for OAuth callbacks (Stripe, Fitbit, etc.) on page load
document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const status = urlParams.get('status');
    const phase = urlParams.get('phase');
    const device = urlParams.get('device');
    
    // ✅ NEW: Handle device OAuth callback (e.g., ?device=fitbit&status=connected)
    if (device && status === 'connected') {
        console.log(`✅ ${device} connected via OAuth redirect`);
        
        // Update UI
        const card = document.getElementById(`device-${device}`);
        const statusEl = document.getElementById(`status-${device}`);
        if (card) card.classList.add('connected');
        if (statusEl) statusEl.textContent = 'Connected ✓';
        
        // Store in onboarding data
        if (!onboardingData.devices.includes(device)) {
            onboardingData.devices.push(device);
        }
        
        // Navigate to Phase 3 (devices) if not already there
        if (currentPhase !== 3) {
            document.getElementById(`phase${currentPhase}`).classList.remove('active');
            currentPhase = 3;
            document.getElementById('phase3').classList.add('active');
            updateProgress();
        }
        
        // Show success message
        alert(`${device.charAt(0).toUpperCase() + device.slice(1)} connected successfully!`);
        
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    // Handle Stripe callback
    if (status === 'success' && phase === '8') {
        console.log('✅ Payment successful');
        onboardingData.subscription = 'paid';
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
    } else if (status === 'cancelled') {
        alert('Payment cancelled. You can upgrade later in settings.');
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
});

// ============================================================================
// That's it! This code now handles BOTH:
// 1. Stripe payment callbacks (?phase=8&status=success)
// 2. Device OAuth callbacks (?device=fitbit&status=connected)
// ============================================================================
