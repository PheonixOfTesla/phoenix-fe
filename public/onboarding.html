<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix - Onboarding</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            background: #000;
            color: #00ffff;
            overflow: hidden;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 255, 255, 0.95);
            color: #000;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.4);
            z-index: 10000;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        .toast.show { display: block; }
        .toast.success { background: rgba(0, 255, 0, 0.95); }
        .toast.error { background: rgba(255, 0, 0, 0.95); color: #fff; }
        .toast.info { background: rgba(0, 150, 255, 0.95); color: #fff; }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .phase-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.5s ease;
            background: radial-gradient(circle at center, rgba(0, 15, 30, 1) 0%, rgba(0, 0, 0, 1) 100%);
        }

        .phase-container.active {
            display: flex;
            opacity: 1;
        }

        .phase-content {
            text-align: center;
            max-width: 600px;
            padding: 40px;
        }

        .content-title {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
        }

        .content-subtitle {
            font-size: 20px;
            color: rgba(0, 255, 255, 0.8);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-group label {
            display: block;
            color: rgba(0, 255, 255, 0.9);
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            color: #00ffff;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .btn {
            padding: 15px 40px;
            background: rgba(0, 255, 255, 0.2);
            border: 2px solid #00ffff;
            color: #00ffff;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn:hover {
            background: rgba(0, 255, 255, 0.4);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #00ffff;
            color: #000;
        }

        .btn-primary:hover {
            background: #00dddd;
        }

        .btn-skip {
            background: transparent;
            border-color: rgba(0, 255, 255, 0.3);
            margin-left: 15px;
        }

        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .device-card {
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .device-card:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: #00ffff;
            transform: translateY(-5px);
        }

        .device-card.connected {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
        }

        .device-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .device-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .device-name {
            font-size: 14px;
            color: #00ffff;
        }

        .device-status {
            font-size: 12px;
            color: rgba(0, 255, 255, 0.6);
            margin-top: 8px;
        }

        .device-status.connected {
            color: #00ff00;
        }

        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(0, 255, 255, 0.2);
            z-index: 9999;
        }

        .progress-fill {
            height: 100%;
            background: #00ffff;
            transition: width 0.5s ease;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .selection-card {
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            padding: 20px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .selection-card:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: #00ffff;
        }

        .selection-card.selected {
            background: rgba(0, 255, 255, 0.2);
            border-color: #00ffff;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Phase 0: Welcome -->
    <div id="phase-0" class="phase-container active">
        <div class="phase-content">
            <div class="content-title">WELCOME TO PHOENIX</div>
            <div class="content-subtitle">Your AI-Powered Life Operating System</div>
            <button class="btn btn-primary" onclick="nextPhase()" style="margin-top: 40px;">
                BEGIN SETUP
            </button>
        </div>
    </div>

    <!-- Phase 1: Voice & Language -->
    <div id="phase-1" class="phase-container">
        <div class="phase-content">
            <div class="content-title">CHOOSE YOUR LANGUAGE</div>
            <div class="selection-grid" id="languageGrid"></div>
            
            <div class="content-subtitle" style="margin-top: 40px;">SELECT YOUR AI VOICE</div>
            <div class="selection-grid" id="voiceGrid"></div>
            
            <button class="btn btn-primary" id="phase1Continue" disabled onclick="nextPhase()" style="margin-top: 40px;">
                CONTINUE
            </button>
        </div>
    </div>

    <!-- Phase 2: Account Creation -->
    <div id="phase-2" class="phase-container">
        <div class="phase-content">
            <div class="content-title">CREATE YOUR ACCOUNT</div>
            <div class="content-subtitle">Join the Phoenix ecosystem</div>
            
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="signupName" placeholder="John Doe">
            </div>
            
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="signupEmail" placeholder="you@example.com">
            </div>
            
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="signupPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            
            <button class="btn btn-primary" onclick="createAccount()" style="margin-top: 20px;">
                CREATE ACCOUNT
            </button>
        </div>
    </div>

    <!-- Phase 3: Connect Devices -->
    <div id="phase-3" class="phase-container">
        <div class="phase-content" style="max-width: 700px;">
            <div class="content-title">CONNECT YOUR DEVICES</div>
            <div class="content-subtitle">Sync your health data automatically (optional)</div>
            
            <div class="device-grid" id="deviceGrid"></div>
            
            <button class="btn btn-primary" onclick="nextPhase()" style="margin-top: 30px;">
                CONTINUE
            </button>
            <button class="btn btn-skip" onclick="nextPhase()">
                SKIP FOR NOW
            </button>
        </div>
    </div>

    <!-- Phase 4: Goals -->
    <div id="phase-4" class="phase-container">
        <div class="phase-content">
            <div class="content-title">SET YOUR GOALS</div>
            <div class="content-subtitle">What do you want to achieve? (optional)</div>
            
            <div class="form-group">
                <label>Primary Goal</label>
                <input type="text" id="primaryGoal" placeholder="e.g., Lose 20 lbs, Run a marathon">
            </div>
            
            <div class="form-group">
                <label>Target Weight (lbs)</label>
                <input type="number" id="targetWeight" placeholder="180">
            </div>
            
            <button class="btn btn-primary" onclick="saveGoal()" style="margin-top: 20px;">
                SAVE & CONTINUE
            </button>
            <button class="btn btn-skip" onclick="nextPhase()">
                SKIP FOR NOW
            </button>
        </div>
    </div>

    <!-- Phase 5: Launch -->
    <div id="phase-5" class="phase-container">
        <div class="phase-content">
            <div class="content-title">ðŸ”¥ READY TO LAUNCH</div>
            <div class="content-subtitle">Your Phoenix is awakening...</div>
            
            <div style="margin: 40px 0; font-size: 18px; line-height: 2; text-align: left;">
                âœ“ Account created<br>
                âœ“ Preferences saved<br>
                âœ“ AI companion activated<br>
                âœ“ Systems online
            </div>
            
            <button class="btn btn-primary" onclick="goToDashboard()" style="margin-top: 20px; font-size: 20px; padding: 20px 60px;">
                ENTER PHOENIX
            </button>
        </div>
    </div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:5000/api' 
            : 'https://pal-backend-production.up.railway.app/api';

        let currentPhase = 0;
        let userData = {
            language: 'en',
            voice: 'nova',
            name: '',
            email: '',
            token: null
        };

        const LANGUAGES = [
            { code: 'en', name: 'English', flag: 'ðŸ‡ºðŸ‡¸' },
            { code: 'es', name: 'EspaÃ±ol', flag: 'ðŸ‡ªðŸ‡¸' },
            { code: 'fr', name: 'FranÃ§ais', flag: 'ðŸ‡«ðŸ‡·' },
            { code: 'de', name: 'Deutsch', flag: 'ðŸ‡©ðŸ‡ª' },
            { code: 'it', name: 'Italiano', flag: 'ðŸ‡®ðŸ‡¹' },
            { code: 'pt', name: 'PortuguÃªs', flag: 'ðŸ‡§ðŸ‡·' },
            { code: 'zh', name: 'ä¸­æ–‡', flag: 'ðŸ‡¨ðŸ‡³' },
            { code: 'ja', name: 'æ—¥æœ¬èªž', flag: 'ðŸ‡¯ðŸ‡µ' },
            { code: 'ko', name: 'í•œêµ­ì–´', flag: 'ðŸ‡°ðŸ‡·' },
            { code: 'ar', name: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', flag: 'ðŸ‡¸ðŸ‡¦' },
            { code: 'hi', name: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€', flag: 'ðŸ‡®ðŸ‡³' },
            { code: 'ru', name: 'Ð ÑƒÑÑÐºÐ¸Ð¹', flag: 'ðŸ‡·ðŸ‡º' }
        ];

        const VOICES = [
            { id: 'alloy', name: 'Alloy', desc: 'Neutral' },
            { id: 'echo', name: 'Echo', desc: 'Warm' },
            { id: 'fable', name: 'Fable', desc: 'Expressive' },
            { id: 'onyx', name: 'Onyx', desc: 'Authoritative' },
            { id: 'nova', name: 'Nova', desc: 'Friendly' },
            { id: 'shimmer', name: 'Shimmer', desc: 'Gentle' }
        ];

        const DEVICES = [
            { id: 'fitbit', name: 'Fitbit', icon: 'âŒš' },
            { id: 'polar', name: 'Polar', icon: 'ðŸƒ' },
            { id: 'apple', name: 'Apple Health', icon: 'â¤ï¸', disabled: true },
            { id: 'whoop', name: 'WHOOP', icon: 'ðŸ’ª', disabled: true }
        ];

        (function init() {
            renderLanguages();
            renderVoices();
            renderDevices();
            updateProgress();
        })();

        function renderLanguages() {
            const grid = document.getElementById('languageGrid');
            grid.innerHTML = LANGUAGES.map(lang => `
                <div class="selection-card ${lang.code === 'en' ? 'selected' : ''}" onclick="selectLanguage('${lang.code}')">
                    <div style="font-size: 32px;">${lang.flag}</div>
                    <div style="margin-top: 8px; font-size: 12px;">${lang.name}</div>
                </div>
            `).join('');
        }

        function renderVoices() {
            const grid = document.getElementById('voiceGrid');
            grid.innerHTML = VOICES.map(voice => `
                <div class="selection-card ${voice.id === 'nova' ? 'selected' : ''}" onclick="selectVoice('${voice.id}')">
                    <div style="font-size: 16px; font-weight: bold;">${voice.name}</div>
                    <div style="font-size: 11px; color: rgba(0, 255, 255, 0.6); margin-top: 5px;">${voice.desc}</div>
                </div>
            `).join('');
        }

        function renderDevices() {
            const grid = document.getElementById('deviceGrid');
            grid.innerHTML = DEVICES.map(device => `
                <div class="device-card ${device.disabled ? 'disabled' : ''}" onclick="${device.disabled ? '' : `connectDevice('${device.id}')`}">
                    <div class="device-icon">${device.icon}</div>
                    <div class="device-name">${device.name}</div>
                    <div class="device-status">${device.disabled ? 'Coming Soon' : 'Tap to connect'}</div>
                </div>
            `).join('');
        }

        function selectLanguage(code) {
            userData.language = code;
            document.querySelectorAll('#languageGrid .selection-card').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            checkPhase1Complete();
        }

        function selectVoice(id) {
            userData.voice = id;
            document.querySelectorAll('#voiceGrid .selection-card').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            checkPhase1Complete();
        }

        function checkPhase1Complete() {
            const btn = document.getElementById('phase1Continue');
            btn.disabled = !(userData.language && userData.voice);
        }

        async function createAccount() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            if (!name || !email || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }

            try {
                showToast('Creating your account...', 'info');

                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name, 
                        email, 
                        password,
                        preferences: {
                            language: userData.language,
                            voice: userData.voice
                        }
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Registration failed');
                }

                userData.name = name;
                userData.email = email;
                userData.token = data.token;
                
                localStorage.setItem('phoenixToken', data.token);
                localStorage.setItem('phoenixUser', JSON.stringify(data.user));

                showToast('Account created successfully!', 'success');
                setTimeout(nextPhase, 1000);

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function connectDevice(deviceId) {
            if (!userData.token) {
                showToast('Please create account first', 'error');
                return;
            }

            try {
                showToast('Connecting...', 'info');

                const response = await fetch(`${API_BASE}/mercury/devices/${deviceId}/connect`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userData.token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Connection failed');
                }

                // Redirect to OAuth
                window.location.href = data.authUrl;

            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function saveGoal() {
            const goal = document.getElementById('primaryGoal').value;
            const weight = document.getElementById('targetWeight').value;

            if (goal && userData.token) {
                try {
                    await fetch(`${API_BASE}/mars/goals`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userData.token}`
                        },
                        body: JSON.stringify({ 
                            title: goal,
                            targetWeight: weight ? parseInt(weight) : null
                        })
                    });
                    showToast('Goal saved!', 'success');
                } catch (error) {
                    console.error('Goal save failed:', error);
                }
            }
            
            nextPhase();
        }

        function goToDashboard() {
            localStorage.setItem('phoenixOnboardingComplete', 'true');
            showToast('Launching Phoenix...', 'success');
            setTimeout(() => {
                window.location.href = '/index.html';
            }, 1000);
        }

        function nextPhase() {
            document.getElementById(`phase-${currentPhase}`).classList.remove('active');
            currentPhase++;
            document.getElementById(`phase-${currentPhase}`).classList.add('active');
            updateProgress();
        }

        function updateProgress() {
            const progress = (currentPhase / 5) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Check for OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        const device = urlParams.get('device');
        const status = urlParams.get('status');

        if (device && status === 'connected') {
            showToast(`${device.charAt(0).toUpperCase() + device.slice(1)} connected!`, 'success');
            window.history.replaceState({}, '', '/onboarding.html');
        }
    </script>
</body>
</html>
