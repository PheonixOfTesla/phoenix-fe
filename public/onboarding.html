<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Phoenix - Awakening</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            background: #000;
            color: #00ffff;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* ============================================
           TOAST NOTIFICATIONS
        ============================================ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 255, 255, 0.95);
            color: #000;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.4);
            z-index: 10000;
            display: none;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .toast.success {
            background: rgba(0, 255, 0, 0.95);
        }

        .toast.error {
            background: rgba(255, 0, 0, 0.95);
            color: #fff;
        }

        .toast.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ============================================
           PHASE CONTAINER
        ============================================ */
        .phase-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        .phase-container.active {
            display: flex;
            opacity: 1;
        }

        /* ============================================
           PHASE 0: VOICE & LANGUAGE SELECTION
        ============================================ */
        #phase-0 {
            background: radial-gradient(circle at center, rgba(0, 15, 30, 1) 0%, rgba(0, 0, 0, 1) 100%);
            overflow-y: auto;
            padding: 40px 20px;
        }

        .setup-container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
        }

        .setup-header {
            margin-bottom: 60px;
        }

        .phoenix-logo-large {
            font-size: 60px;
            color: #00ffff;
            text-shadow: 0 0 60px rgba(0, 255, 255, 1);
            letter-spacing: 15px;
            margin-bottom: 20px;
            animation: logoPulse 2s ease-in-out infinite;
        }

        @keyframes logoPulse {
            0%, 100% { text-shadow: 0 0 60px rgba(0, 255, 255, 1); }
            50% { text-shadow: 0 0 80px rgba(0, 255, 255, 1), 0 0 100px rgba(0, 255, 255, 0.6); }
        }

        .setup-subtitle {
            font-size: 24px;
            color: rgba(0, 255, 255, 0.9);
            margin-bottom: 15px;
        }

        .setup-description {
            font-size: 16px;
            color: rgba(0, 255, 255, 0.7);
            line-height: 1.6;
        }

        .setup-section {
            margin-bottom: 60px;
        }

        .section-title {
            font-size: 20px;
            color: #00ffff;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Language Cards */
        .language-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .language-card {
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .language-card:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: rgba(0, 255, 255, 0.6);
            transform: translateY(-5px);
        }

        .language-card.selected {
            background: rgba(0, 255, 255, 0.2);
            border-color: #00ffff;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        }

        .language-flag {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .language-name {
            font-size: 16px;
            color: #00ffff;
        }

        /* Voice Cards */
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .voice-card {
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .voice-card:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: rgba(0, 255, 255, 0.6);
            transform: translateY(-5px);
        }

        .voice-card.selected {
            background: rgba(0, 255, 255, 0.2);
            border-color: #00ffff;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        }

        .voice-name {
            font-size: 18px;
            color: #00ffff;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .voice-description {
            font-size: 14px;
            color: rgba(0, 255, 255, 0.7);
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .preview-btn {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.5);
            color: #00ffff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            width: 100%;
        }

        .preview-btn:hover {
            background: rgba(0, 255, 255, 0.3);
            border-color: #00ffff;
        }

        .preview-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Device Cards */
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .device-card {
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .device-card:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: rgba(0, 255, 255, 0.6);
            transform: translateY(-5px);
        }

        .device-card.connected {
            background: rgba(0, 255, 0, 0.1);
            border-color: rgba(0, 255, 0, 0.6);
        }

        .device-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .device-name {
            font-size: 18px;
            color: #00ffff;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .device-status {
            font-size: 12px;
            color: rgba(0, 255, 255, 0.7);
        }

        .device-status.connected {
            color: rgba(0, 255, 0, 0.9);
        }

        /* Continue Button */
        .continue-btn {
            background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%);
            border: none;
            color: #000;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .continue-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.6);
        }

        .continue-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ============================================
           PHASES 1-9: Existing styles
        ============================================ */
        .phase-content {
            text-align: center;
            z-index: 10;
            max-width: 800px;
            padding: 0 20px;
        }

        .content-title {
            font-size: 48px;
            margin-bottom: 30px;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
            animation: fadeInTitle 2s ease;
        }

        .content-subtitle {
            font-size: 24px;
            color: rgba(0, 255, 255, 0.9);
            margin-bottom: 20px;
            animation: fadeInSubtitle 2.5s ease;
        }

        .content-text {
            font-size: 16px;
            line-height: 1.8;
            color: rgba(0, 255, 255, 0.8);
            animation: fadeInText 3s ease;
        }

        @keyframes fadeInTitle {
            0% { opacity: 0; transform: translateY(-30px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInSubtitle {
            0% { opacity: 0; }
            30% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes fadeInText {
            0% { opacity: 0; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }

        /* Button Groups */
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            animation: fadeInButtons 3.5s ease;
        }

        @keyframes fadeInButtons {
            0% { opacity: 0; }
            70% { opacity: 0; }
            100% { opacity: 1; }
        }

        .btn {
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            border: 2px solid;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00ffff 0%, #00cccc 100%);
            border-color: #00ffff;
            color: #000;
        }

        .btn-secondary {
            background: transparent;
            border-color: #00ffff;
            color: #00ffff;
        }

        .btn-ghost {
            background: transparent;
            border-color: rgba(0, 255, 255, 0.5);
            color: rgba(0, 255, 255, 0.7);
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        /* Particle Background */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #00ffff;
            border-radius: 50%;
            animation: float 10s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) translateX(50px); opacity: 0; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .phoenix-logo-large {
                font-size: 40px;
            }

            .setup-subtitle {
                font-size: 20px;
            }

            .content-title {
                font-size: 32px;
            }

            .content-subtitle {
                font-size: 18px;
            }

            .language-grid,
            .voice-grid,
            .device-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Phase 0: Setup & Configuration -->
    <div id="phase-0" class="phase-container">
        <div class="setup-container">
            <div class="setup-header">
                <div class="phoenix-logo-large">PHOENIX</div>
                <div class="setup-subtitle">Let's Get You Set Up</div>
                <div class="setup-description">
                    Choose your preferences to personalize your Phoenix experience
                </div>
            </div>

            <!-- Language Selection -->
            <div class="setup-section">
                <div class="section-title">Choose Your Language</div>
                <div class="language-grid" id="languageGrid">
                    <!-- Languages will be loaded dynamically -->
                </div>
            </div>

            <!-- Voice Selection -->
            <div class="setup-section">
                <div class="section-title">Select Phoenix's Voice</div>
                <div class="voice-grid" id="voiceGrid">
                    <!-- Voices will be loaded dynamically -->
                </div>
            </div>

            <!-- Device Integration -->
            <div class="setup-section">
                <div class="section-title">Connect Your Devices (Optional)</div>
                <div class="device-grid" id="deviceGrid">
                    <!-- Devices will be loaded dynamically -->
                </div>
            </div>

            <!-- Continue Button -->
            <button class="continue-btn" id="continueBtn" disabled onclick="completeSetup()">
                Continue to Phoenix
            </button>
        </div>
    </div>

    <!-- Phases 1-9: Cinematic Onboarding -->
    <div id="phase-1" class="phase-container">
        <div class="phase-content">
            <div class="content-title">AWAKENING</div>
            <div class="content-subtitle">Initializing Phoenix Protocol...</div>
        </div>
        <div class="particles" id="particles-1"></div>
    </div>

    <div id="phase-2" class="phase-container">
        <div class="phase-content">
            <div class="content-title">HELLO</div>
            <div class="content-subtitle">I am Phoenix</div>
            <div class="content-text">
                Your AI companion, built to optimize every aspect of your life
            </div>
        </div>
        <div class="particles" id="particles-2"></div>
    </div>

    <div id="phase-3" class="phase-container">
        <div class="phase-content">
            <div class="content-title">YOUR MISSION</div>
            <div class="content-subtitle">If you choose to accept it...</div>
            <div class="content-text">
                I will help you become the most optimized version of yourself
            </div>
        </div>
        <div class="particles" id="particles-3"></div>
    </div>

    <div id="phase-4" class="phase-container">
        <div class="phase-content">
            <div class="content-title">THE PROMISE</div>
            <div class="content-text" style="font-size: 18px; max-width: 600px; margin: 0 auto;">
                Give me 30 days, and I'll help you build habits that stick.
                <br><br>
                Give me 90 days, and I'll help you achieve a goal you've been putting off for years.
                <br><br>
                Give me a year, and I'll fundamentally change how you operate as a human being.
            </div>
        </div>
        <div class="particles" id="particles-4"></div>
    </div>

    <div id="phase-5" class="phase-container">
        <div class="phase-content">
            <div class="content-title">SO... WHAT DO YOU SAY?</div>
            <div class="button-group">
                <button class="btn btn-ghost" onclick="selectOption('explore')">JUST EXPLORE</button>
                <button class="btn btn-secondary" onclick="selectOption('simple')">START SIMPLE</button>
                <button class="btn btn-primary" onclick="selectOption('all-in')">GO ALL IN</button>
            </div>
        </div>
        <div class="particles" id="particles-5"></div>
    </div>

    <div id="phase-6" class="phase-container">
        <div class="phase-content">
            <div class="content-title">EXCELLENT CHOICE</div>
            <div class="content-subtitle">Initializing your Phoenix ecosystem...</div>
        </div>
        <div class="particles" id="particles-6"></div>
    </div>

    <div id="phase-7" class="phase-container">
        <div class="phase-content">
            <div class="content-title">CONNECTING SYSTEMS</div>
            <div class="content-subtitle">Integrating with your digital life...</div>
        </div>
        <div class="particles" id="particles-7"></div>
    </div>

    <div id="phase-8" class="phase-container">
        <div class="phase-content">
            <div class="content-title">ALMOST READY</div>
            <div class="content-subtitle">Calibrating AI models...</div>
        </div>
        <div class="particles" id="particles-8"></div>
    </div>

    <div id="phase-9" class="phase-container">
        <div class="phase-content">
            <div class="content-title">ACTIVATION COMPLETE</div>
            <div class="content-subtitle">Welcome to Phoenix</div>
            <button class="btn btn-primary" onclick="goToDashboard()" style="margin-top: 30px;">
                ENTER DASHBOARD
            </button>
        </div>
        <div class="particles" id="particles-9"></div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:5000/api' 
            : 'https://pal-backend-production.up.railway.app/api';

        let currentPhase = 0;
        let selectedLanguage = 'en';
        let selectedVoice = null;
        let connectedDevices = [];
        let previewAudio = null;

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function getAuthToken() {
            return localStorage.getItem('phoenixToken');
        }

        function getAuthHeaders() {
            const token = getAuthToken();
            return {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            };
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ============================================
        // PHASE NAVIGATION
        // ============================================
        function showPhase(phaseNumber) {
            // Hide all phases
            document.querySelectorAll('.phase-container').forEach(phase => {
                phase.classList.remove('active');
            });

            // Show target phase
            const targetPhase = document.getElementById(`phase-${phaseNumber}`);
            if (targetPhase) {
                targetPhase.classList.add('active');
                currentPhase = phaseNumber;

                // Add particles for cinematic phases
                if (phaseNumber > 0) {
                    addParticles(`particles-${phaseNumber}`);
                }
            }
        }

        function nextPhase() {
            if (currentPhase < 9) {
                showPhase(currentPhase + 1);
            }
        }

        function addParticles(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Clear existing particles
            container.innerHTML = '';

            // Add 50 particles
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 10 + 's';
                particle.style.animationDuration = (10 + Math.random() * 10) + 's';
                container.appendChild(particle);
            }
        }

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadLanguages() {
            try {
                const response = await fetch(`${API_BASE}/onboarding/languages`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('Failed to load languages');
                }

                const languages = await response.json();
                renderLanguages(languages);
            } catch (error) {
                console.error('Error loading languages:', error);
                showToast('Could not load languages. Using defaults.', 'error');
                // Fallback to default languages
                renderLanguages([
                    { code: 'en', name: 'English', flag: 'üá∫üá∏' },
                    { code: 'es', name: 'Spanish', flag: 'üá™üá∏' },
                    { code: 'fr', name: 'French', flag: 'üá´üá∑' },
                    { code: 'de', name: 'German', flag: 'üá©üá™' }
                ]);
            }
        }

        async function loadDevices() {
            try {
                const response = await fetch(`${API_BASE}/onboarding/devices`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('Failed to load devices');
                }

                const devices = await response.json();
                renderDevices(devices);
            } catch (error) {
                console.error('Error loading devices:', error);
                showToast('Could not load devices. Using defaults.', 'error');
                // Fallback to default devices
                renderDevices([
                    { id: 'fitbit', name: 'Fitbit', icon: '‚åö', connected: false },
                    { id: 'googlefit', name: 'Google Fit', icon: 'üèÉ', connected: false },
                    { id: 'applehealth', name: 'Apple Health', icon: '‚ù§Ô∏è', connected: false },
                    { id: 'whoop', name: 'WHOOP', icon: 'üí™', connected: false }
                ]);
            }
        }

        async function loadVoices() {
            try {
                const response = await fetch(`${API_BASE}/voice/available`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('Failed to load voices');
                }

                const voices = await response.json();
                renderVoices(voices);
            } catch (error) {
                console.error('Error loading voices:', error);
                showToast('Could not load voices. Using defaults.', 'error');
                // Fallback to default voices
                renderVoices([
                    { id: 'alloy', name: 'Alloy', description: 'Neutral and balanced', gender: 'neutral' },
                    { id: 'echo', name: 'Echo', description: 'Warm and friendly', gender: 'male' },
                    { id: 'fable', name: 'Fable', description: 'Expressive and engaging', gender: 'male' },
                    { id: 'onyx', name: 'Onyx', description: 'Deep and authoritative', gender: 'male' },
                    { id: 'nova', name: 'Nova', description: 'Bright and energetic', gender: 'female' },
                    { id: 'shimmer', name: 'Shimmer', description: 'Soft and gentle', gender: 'female' }
                ]);
            }
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderLanguages(languages) {
            const grid = document.getElementById('languageGrid');
            grid.innerHTML = languages.map(lang => `
                <div class="language-card ${lang.code === 'en' ? 'selected' : ''}" 
                     onclick="selectLanguage('${lang.code}')">
                    <div class="language-flag">${lang.flag}</div>
                    <div class="language-name">${lang.name}</div>
                </div>
            `).join('');
        }

        function renderVoices(voices) {
            const grid = document.getElementById('voiceGrid');
            grid.innerHTML = voices.map(voice => `
                <div class="voice-card" onclick="selectVoice('${voice.id}')">
                    <div class="voice-name">${voice.name}</div>
                    <div class="voice-description">${voice.description}</div>
                    <button class="preview-btn" 
                            onclick="event.stopPropagation(); previewVoice('${voice.id}')">
                        üîä Preview Voice
                    </button>
                </div>
            `).join('');
        }

        function renderDevices(devices) {
            const grid = document.getElementById('deviceGrid');
            grid.innerHTML = devices.map(device => `
                <div class="device-card ${device.connected ? 'connected' : ''}" 
                     onclick="connectDevice('${device.id}')">
                    <div class="device-icon">${device.icon}</div>
                    <div class="device-name">${device.name}</div>
                    <div class="device-status ${device.connected ? 'connected' : ''}">
                        ${device.connected ? '‚úì Connected' : 'Tap to connect'}
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // SELECTION HANDLERS
        // ============================================
        function selectLanguage(code) {
            selectedLanguage = code;
            
            // Update UI
            document.querySelectorAll('.language-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Enable continue button if voice is also selected
            updateContinueButton();
        }

        function selectVoice(voiceId) {
            selectedVoice = voiceId;
            
            // Update UI
            document.querySelectorAll('.voice-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Enable continue button if language is also selected
            updateContinueButton();
        }

        async function previewVoice(voiceId) {
            const button = event.currentTarget;
            const originalText = button.textContent;
            
            try {
                // Stop any playing audio
                if (previewAudio) {
                    previewAudio.pause();
                    previewAudio = null;
                }

                // Show loading state
                button.textContent = '‚è≥ Loading...';
                button.disabled = true;

                // Request preview from backend
                const response = await fetch(`${API_BASE}/voice/speak`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        text: 'Hello. I am Phoenix, your AI companion.',
                        voice: voiceId,
                        speed: 1.0
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate voice preview');
                }

                // Play audio
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                previewAudio = new Audio(audioUrl);
                
                previewAudio.onended = () => {
                    button.textContent = originalText;
                    button.disabled = false;
                };

                await previewAudio.play();
                button.textContent = '‚ñ∂Ô∏è Playing...';

            } catch (error) {
                console.error('Error previewing voice:', error);
                showToast('Could not preview voice', 'error');
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function connectDevice(deviceId) {
            try {
                // Get OAuth URL from backend
                const response = await fetch(`${API_BASE}/mercury/devices/${deviceId}/oauth-url`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`Failed to get OAuth URL for ${deviceId}`);
                }

                const { authUrl } = await response.json();

                // Redirect to OAuth provider
                showToast(`Redirecting to ${deviceId} authorization...`, 'success');
                window.location.href = authUrl;

            } catch (error) {
                console.error(`Error connecting ${deviceId}:`, error);
                showToast(`Could not connect ${deviceId}`, 'error');
            }
        }

        function updateContinueButton() {
            const button = document.getElementById('continueBtn');
            button.disabled = !(selectedLanguage && selectedVoice);
        }

        // ============================================
        // COMPLETE SETUP
        // ============================================
        async function completeSetup() {
            try {
                // Save preferences to backend
                const preferences = {
                    language: selectedLanguage,
                    voice: selectedVoice,
                    connectedDevices: connectedDevices
                };

                const response = await fetch(`${API_BASE}/auth/me`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ preferences })
                });

                if (!response.ok) {
                    throw new Error('Failed to save preferences');
                }

                // Save to localStorage
                localStorage.setItem('phoenixPreferences', JSON.stringify(preferences));

                // Start cinematic onboarding
                showToast('Setup complete! Starting Phoenix...', 'success');
                setTimeout(() => {
                    showPhase(1);
                    startCinematicSequence();
                }, 1000);

            } catch (error) {
                console.error('Error completing setup:', error);
                showToast('Could not save preferences', 'error');
            }
        }

        // ============================================
        // CINEMATIC SEQUENCE
        // ============================================
        function startCinematicSequence() {
            const sequence = [
                { phase: 1, duration: 3000 },
                { phase: 2, duration: 4000 },
                { phase: 3, duration: 4000 },
                { phase: 4, duration: 6000 },
                { phase: 5, duration: 0 } // Wait for user input
            ];

            let currentIndex = 0;

            function playNext() {
                if (currentIndex >= sequence.length) return;

                const step = sequence[currentIndex];
                showPhase(step.phase);

                if (step.duration > 0) {
                    setTimeout(() => {
                        currentIndex++;
                        playNext();
                    }, step.duration);
                }
            }

            playNext();
        }

        function selectOption(option) {
            localStorage.setItem('phoenixCommitmentLevel', option);
            showToast('Preparing your Phoenix experience...', 'success');
            
            // Continue with phases 6-9
            setTimeout(() => showPhase(6), 1000);
            setTimeout(() => showPhase(7), 4000);
            setTimeout(() => showPhase(8), 7000);
            setTimeout(() => showPhase(9), 10000);
        }

        function goToDashboard() {
            // Mark onboarding as complete
            localStorage.setItem('phoenixOnboardingComplete', 'true');
            
            // Redirect to dashboard
            window.location.href = '/index.html';
        }

        // ============================================
        // OAUTH CALLBACK DETECTION
        // ============================================
        function checkOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const device = urlParams.get('device');
            const status = urlParams.get('status');

            if (device && status === 'connected') {
                console.log(`‚úÖ ${device} connected via OAuth redirect`);
                
                // Add to connected devices
                if (!connectedDevices.includes(device)) {
                    connectedDevices.push(device);
                }

                // Show success message
                showToast(`${device.charAt(0).toUpperCase() + device.slice(1)} connected successfully!`, 'success');

                // Update UI to show device as connected
                const deviceCard = document.querySelector(`[onclick*="${device}"]`);
                if (deviceCard) {
                    deviceCard.classList.add('connected');
                    const statusElement = deviceCard.querySelector('.device-status');
                    if (statusElement) {
                        statusElement.textContent = '‚úì Connected';
                        statusElement.classList.add('connected');
                    }
                }

                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (device && status === 'error') {
                console.error(`‚ùå ${device} connection failed`);
                showToast(`Failed to connect ${device}`, 'error');
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Listen for postMessage events from OAuth popup windows
        window.addEventListener('message', (event) => {
            // Verify origin for security
            const allowedOrigins = [
                window.location.origin,
                'https://phoenix-fe-kappa.vercel.app',
                'https://pal-backend-production.up.railway.app'
            ];

            if (!allowedOrigins.includes(event.origin)) {
                console.warn('Message from untrusted origin:', event.origin);
                return;
            }

            const { type, device, status } = event.data;

            if (type === 'oauth_success' && device) {
                console.log(`‚úÖ ${device} connected via postMessage`);
                
                // Add to connected devices
                if (!connectedDevices.includes(device)) {
                    connectedDevices.push(device);
                }

                // Show success message
                showToast(`${device.charAt(0).toUpperCase() + device.slice(1)} connected successfully!`, 'success');

                // Update UI
                const deviceCard = document.querySelector(`[onclick*="${device}"]`);
                if (deviceCard) {
                    deviceCard.classList.add('connected');
                    const statusElement = deviceCard.querySelector('.device-status');
                    if (statusElement) {
                        statusElement.textContent = '‚úì Connected';
                        statusElement.classList.add('connected');
                    }
                }
            } else if (type === 'oauth_error') {
                console.error(`‚ùå OAuth error:`, event.data);
                showToast('Device connection failed', 'error');
            }
        });

        // ============================================
        // INITIALIZATION
        // ============================================
        (async function init() {
            console.log('üöÄ Phoenix Onboarding Initialized');
            
            // Check if user is authenticated
            const token = getAuthToken();
            if (!token) {
                console.warn('No auth token found - user needs to login first');
                // Uncomment to enforce authentication:
                // window.location.href = '/login.html';
                // return;
            }

            // Check for OAuth callback
            checkOAuthCallback();

            // Load initial data
            try {
                await Promise.all([
                    loadLanguages(),
                    loadVoices(),
                    loadDevices()
                ]);
                
                console.log('‚úÖ Onboarding data loaded successfully');
            } catch (error) {
                console.error('Error loading onboarding data:', error);
            }

            // Show Phase 0 (setup)
            showPhase(0);
        })();
    </script>
</body>
</html>
