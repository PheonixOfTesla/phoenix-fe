<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix - JARVIS Intelligence</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Animated Background -->
    <div class="background">
        <div class="grid-lines"></div>
    </div>
    
    <!-- Background Canvas -->
    <canvas id="bg-canvas"></canvas>

    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-container">
            <div class="auth-title">üî• PHOENIX</div>
            <div class="auth-subtitle">Your Intelligence OS</div>
            
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="auth-button" onclick="login()">ACCESS SYSTEM</button>
                <div class="auth-switch">
                    Don't have access? <a onclick="toggleAuthMode()">Register</a>
                </div>
            </div>

            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" id="registerName" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="registerEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="registerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="auth-button" onclick="register()">CREATE ACCOUNT</button>
                <div class="auth-switch">
                    Already have access? <a onclick="toggleAuthMode()">Login</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Interface -->
    <div class="container hidden" id="mainInterface">
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span class="status-text" id="statusText">READY</span>
                </div>
                
                <div class="vitals-inline">
                    <div class="vital-item">
                        <span class="vital-label">HRV</span>
                        <span class="vital-value" id="hrvValue">66.2ms</span>
                    </div>
                    <div class="vital-item">
                        <span class="vital-label">RHR</span>
                        <span class="vital-value" id="rhrValue">58bpm</span>
                    </div>
                    <div class="vital-item">
                        <span class="vital-label">O‚ÇÇ</span>
                        <span class="vital-value" id="o2Value">98%</span>
                    </div>
                </div>
            </div>
            
            <div class="user-info">
                <div class="recovery-badge" id="recoveryBadge">Recovery: 78%</div>
                <span class="user-name" id="userName">Josh</span>
                <button class="logout-btn" onclick="logout()">EXIT</button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Phoenix Core -->
            <div class="phoenix-core-container">
                <!-- Outer Rings -->
                <div class="core-ring ring-outer"></div>
                <div class="core-ring ring-middle"></div>
                
                <!-- Center Orb -->
                <div class="phoenix-orb" id="phoenixOrb">
                    <div class="orb-glow"></div>
                    <div class="orb-inner-glow"></div>
                    <div class="flame-icon">üî•</div>
                </div>
                
                <!-- Greeting Text -->
                <div class="greeting-text">
                    <div class="greeting-main" id="greetingMain">Good evening, Josh</div>
                    <div class="greeting-sub" id="greetingSub">Wind down mode. Focus on recovery and tomorrow's preparation.</div>
                </div>

                <!-- Planet Gears -->
                <div class="planet-gear planet-mercury" id="planet-mercury" data-planet="mercury">
                    <div class="gear-outer">
                        <div class="gear-tooth" style="transform: rotate(0deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(30deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(60deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(90deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(120deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(150deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(180deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(210deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(240deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(270deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(300deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(330deg)"></div>
                    </div>
                    <div class="gear-inner">
                        <div class="gear-tooth-inner" style="transform: rotate(0deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(45deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(90deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(135deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(180deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(225deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(270deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(315deg)"></div>
                    </div>
                    <div class="planet-center">üî•</div>
                    <div class="planet-metric">
                        <div class="metric-value" id="mercury-metric">78%</div>
                        <div class="metric-label">Recovery</div>
                    </div>
                </div>

                <div class="planet-gear planet-venus" id="planet-venus" data-planet="venus">
                    <div class="gear-outer">
                        <div class="gear-tooth" style="transform: rotate(0deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(30deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(60deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(90deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(120deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(150deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(180deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(210deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(240deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(270deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(300deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(330deg)"></div>
                    </div>
                    <div class="gear-inner">
                        <div class="gear-tooth-inner" style="transform: rotate(0deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(45deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(90deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(135deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(180deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(225deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(270deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(315deg)"></div>
                    </div>
                    <div class="planet-center">üî•</div>
                    <div class="planet-metric">
                        <div class="metric-value" id="venus-metric">4x</div>
                        <div class="metric-label">Workouts</div>
                    </div>
                </div>

                <div class="planet-gear planet-earth" id="planet-earth" data-planet="earth">
                    <div class="gear-outer">
                        <div class="gear-tooth" style="transform: rotate(0deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(30deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(60deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(90deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(120deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(150deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(180deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(210deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(240deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(270deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(300deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(330deg)"></div>
                    </div>
                    <div class="gear-inner">
                        <div class="gear-tooth-inner" style="transform: rotate(0deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(45deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(90deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(135deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(180deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(225deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(270deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(315deg)"></div>
                    </div>
                    <div class="planet-center">üî•</div>
                    <div class="planet-metric">
                        <div class="metric-value" id="earth-metric">8</div>
                        <div class="metric-label">Events</div>
                    </div>
                </div>

                <div class="planet-gear planet-mars" id="planet-mars" data-planet="mars">
                    <div class="gear-outer">
                        <div class="gear-tooth" style="transform: rotate(0deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(30deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(60deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(90deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(120deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(150deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(180deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(210deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(240deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(270deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(300deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(330deg)"></div>
                    </div>
                    <div class="gear-inner">
                        <div class="gear-tooth-inner" style="transform: rotate(0deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(45deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(90deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(135deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(180deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(225deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(270deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(315deg)"></div>
                    </div>
                    <div class="planet-center">üî•</div>
                    <div class="planet-metric">
                        <div class="metric-value" id="mars-metric">3/5</div>
                        <div class="metric-label">Goals</div>
                    </div>
                </div>

                <div class="planet-gear planet-jupiter" id="planet-jupiter" data-planet="jupiter">
                    <div class="gear-outer">
                        <div class="gear-tooth" style="transform: rotate(0deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(30deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(60deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(90deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(120deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(150deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(180deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(210deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(240deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(270deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(300deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(330deg)"></div>
                    </div>
                    <div class="gear-inner">
                        <div class="gear-tooth-inner" style="transform: rotate(0deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(45deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(90deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(135deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(180deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(225deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(270deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(315deg)"></div>
                    </div>
                    <div class="planet-center">üî•</div>
                    <div class="planet-metric">
                        <div class="metric-value" id="jupiter-metric">$2.4K</div>
                        <div class="metric-label">Budget</div>
                    </div>
                </div>

                <div class="planet-gear planet-saturn" id="planet-saturn" data-planet="saturn">
                    <div class="gear-outer">
                        <div class="gear-tooth" style="transform: rotate(0deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(30deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(60deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(90deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(120deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(150deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(180deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(210deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(240deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(270deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(300deg)"></div>
                        <div class="gear-tooth" style="transform: rotate(330deg)"></div>
                    </div>
                    <div class="gear-inner">
                        <div class="gear-tooth-inner" style="transform: rotate(0deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(45deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(90deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(135deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(180deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(225deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(270deg)"></div>
                        <div class="gear-tooth-inner" style="transform: rotate(315deg)"></div>
                    </div>
                    <div class="planet-center">üî•</div>
                    <div class="planet-metric">
                        <div class="metric-value" id="saturn-metric">42%</div>
                        <div class="metric-label">Progress</div>
                    </div>
                </div>
            </div>

            <!-- Voice Controls -->
            <div class="voice-controls">
                <div class="voice-mode-toggle" onclick="toggleVoiceMode()">
                    <span id="voiceModeText">Voice Mode: Off</span>
                    <div class="toggle-switch" id="voiceToggle">
                        <div class="toggle-knob"></div>
                    </div>
                </div>
                <div class="voice-button" id="voiceButton" onclick="handleVoiceClick()">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 15c1.66 0 3-1.34 3-3V6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Bottom Panel -->
        <div class="bottom-panel">
            <div class="panel-section">
                <div class="panel-label">WEATHER</div>
                <div class="panel-value">72¬∞F</div>
                <div class="panel-detail">Clear, Perfect for training</div>
            </div>
            
            <div class="panel-section panel-center">
                <div class="panel-label">GOALS PROGRESS</div>
                <div class="panel-value-large">4/5</div>
                <div class="panel-detail">60% Complete</div>
            </div>
            
            <div class="panel-section panel-right">
                <div class="panel-label">SYSTEM TIME</div>
                <div class="panel-value" id="systemTime">00:17</div>
                <div class="panel-detail" id="systemDate">Saturday, Oct 18</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="action-button" onclick="syncWearables()">SYNC WEARABLES</button>
            <button class="action-button" onclick="viewGoals()">TODAY'S GOALS</button>
            <button class="action-button" onclick="healthAnalysis()">HEALTH ANALYSIS</button>
        </div>
    </div>

    <!-- Chat Toggle Button -->
    <button class="chat-toggle hidden" id="chatToggle" onclick="toggleChat()">üí¨</button>

    <!-- Chat Drawer -->
    <div class="chat-drawer" id="chatDrawer">
        <div class="drawer-header">
            <div class="drawer-title">Phoenix Interface</div>
            <button class="close-btn" onclick="toggleChat()">‚úï</button>
        </div>

        <div class="quick-actions-grid">
            <button class="quick-action" onclick="quickAction('schedule')">üìÖ Today's Schedule</button>
            <button class="quick-action" onclick="quickAction('recovery')">üí™ Recovery Status</button>
            <button class="quick-action" onclick="quickAction('goals')">üéØ Goal Progress</button>
            <button class="quick-action" onclick="quickAction('health')">‚ù§Ô∏è Health Metrics</button>
        </div>

        <div class="messages" id="messages">
            <div class="message">
                <div class="message-label">PHOENIX</div>
                <div class="message-content">Systems online. How can I assist you?</div>
            </div>
        </div>

        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Ask Phoenix anything..." onkeypress="handleChatKeypress(event)">
            <button class="send-btn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading hidden" id="loading">
        <div class="spinner"></div>
    </div>

    <script>
        // API Configuration
        const API_URL = 'https://pal-backend-production.up.railway.app/api';
        let phoenixToken = localStorage.getItem('phoenixToken');
        let currentUser = null;
        let isVoiceMode = false;

        // Initialize on load
        window.onload = () => {
            initBackgroundCanvas();
            checkAuth();
            updateTime();
            setInterval(updateTime, 1000);
        };

        function checkAuth() {
            if (phoenixToken) {
                fetchUserData();
            }
        }

        async function fetchUserData() {
            try {
                const response = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${phoenixToken}` }
                });
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('userName').textContent = currentUser.name || 'User';
                    showMainInterface();
                    loadAllData();
                } else {
                    localStorage.removeItem('phoenixToken');
                    phoenixToken = null;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) return alert('Please enter email and password');

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (response.ok && data.token) {
                    phoenixToken = data.token;
                    localStorage.setItem('phoenixToken', phoenixToken);
                    currentUser = data.user;
                    document.getElementById('userName').textContent = currentUser.name || 'User';
                    showMainInterface();
                    loadAllData();
                } else {
                    alert(data.message || 'Login failed');
                }
            } catch (error) {
                alert('Connection error: ' + error.message);
            }
        }

        async function register() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            if (!name || !email || !password) return alert('Please fill all fields');

            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                const data = await response.json();
                if (response.ok && data.token) {
                    phoenixToken = data.token;
                    localStorage.setItem('phoenixToken', phoenixToken);
                    currentUser = data.user;
                    document.getElementById('userName').textContent = currentUser.name || 'User';
                    showMainInterface();
                    loadAllData();
                } else {
                    alert(data.message || 'Registration failed');
                }
            } catch (error) {
                alert('Connection error: ' + error.message);
            }
        }

        function toggleAuthMode() {
            document.getElementById('loginForm').classList.toggle('hidden');
            document.getElementById('registerForm').classList.toggle('hidden');
        }

        function logout() {
            localStorage.removeItem('phoenixToken');
            phoenixToken = null;
            currentUser = null;
            document.getElementById('mainInterface').classList.add('hidden');
            document.getElementById('chatToggle').classList.add('hidden');
            document.getElementById('authModal').classList.remove('hidden');
        }

        function showMainInterface() {
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('mainInterface').classList.remove('hidden');
            document.getElementById('chatToggle').classList.remove('hidden');
        }

        async function loadAllData() {
            const headers = { 'Authorization': `Bearer ${phoenixToken}` };

            try {
                // Load Mercury (Health) data
                const healthRes = await fetch(`${API_URL}/mercury/latest`, { headers });
                if (healthRes.ok) {
                    const health = await healthRes.json();
                    if (health.data) {
                        document.getElementById('hrvValue').textContent = `${health.data.hrv || 0}ms`;
                        document.getElementById('rhrValue').textContent = `${health.data.heartRate || 0}bpm`;
                        document.getElementById('o2Value').textContent = `${health.data.spo2 || 98}%`;
                        document.getElementById('recoveryBadge').textContent = `Recovery: ${health.data.recoveryScore || 0}%`;
                        document.getElementById('mercury-metric').textContent = `${health.data.recoveryScore || 0}%`;
                    }
                }

                // Load Venus (Workouts) data
                const workoutsRes = await fetch(`${API_URL}/workouts/recent?limit=7`, { headers });
                if (workoutsRes.ok) {
                    const workouts = await workoutsRes.json();
                    const count = workouts.data?.length || 0;
                    document.getElementById('venus-metric').textContent = `${count}x`;
                }

                // Load Earth (Calendar) data
                const calendarRes = await fetch(`${API_URL}/earth/calendar-events`, { headers });
                if (calendarRes.ok) {
                    const calendar = await calendarRes.json();
                    const events = calendar.data?.length || 0;
                    document.getElementById('earth-metric').textContent = `${events}`;
                }

                // Load Mars (Goals) data
                const goalsRes = await fetch(`${API_URL}/goals/active`, { headers });
                if (goalsRes.ok) {
                    const goals = await goalsRes.json();
                    const active = goals.data?.length || 0;
                    const completed = goals.data?.filter(g => g.completed).length || 0;
                    document.getElementById('mars-metric').textContent = `${completed}/${active}`;
                }

                // Load Jupiter (Finance) data
                const financeRes = await fetch(`${API_URL}/jupiter/overview`, { headers });
                if (financeRes.ok) {
                    const finance = await financeRes.json();
                    const spent = finance.data?.expenses || 0;
                    document.getElementById('jupiter-metric').textContent = `${(spent/1000).toFixed(1)}K`;
                }

                // Load Saturn (Timeline) data
                const timelineRes = await fetch(`${API_URL}/saturn/timeline`, { headers });
                if (timelineRes.ok) {
                    const timeline = await timelineRes.json();
                    const progress = timeline.data?.lifeProgress || 0;
                    document.getElementById('saturn-metric').textContent = `${progress}%`;
                }

            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }

        function toggleVoiceMode() {
            isVoiceMode = !isVoiceMode;
            const toggle = document.getElementById('voiceToggle');
            const text = document.getElementById('voiceModeText');
            toggle.classList.toggle('active');
            text.textContent = isVoiceMode ? 'Voice Mode: On' : 'Voice Mode: Off';
        }

        function handleVoiceClick() {
            const btn = document.getElementById('voiceButton');
            btn.classList.toggle('active');
            // Implement actual voice recognition here
        }

        function toggleChat() {
            document.getElementById('chatDrawer').classList.toggle('open');
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addMessage('user', message);
            input.value = '';

            try {
                const response = await fetch(`${API_URL}/phoenix-companion/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${phoenixToken}`
                    },
                    body: JSON.stringify({ message, context: {} })
                });
                const data = await response.json();
                if (response.ok && data.response) {
                    addMessage('phoenix', data.response);
                } else {
                    addMessage('phoenix', 'I encountered an error processing that request.');
                }
            } catch (error) {
                addMessage('phoenix', 'Connection error. Please try again.');
            }
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') sendMessage();
        }

        function addMessage(sender, content) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = `
                <div class="message-label">${sender === 'user' ? 'YOU' : 'PHOENIX'}</div>
                <div class="message-content">${content}</div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function quickAction(action) {
            const actions = {
                schedule: `${API_URL}/earth/calendar-events`,
                recovery: `${API_URL}/mercury/latest`,
                goals: `${API_URL}/goals/active`,
                health: `${API_URL}/mercury/latest`
            };
            try {
                const response = await fetch(actions[action], {
                    headers: { 'Authorization': `Bearer ${phoenixToken}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    addMessage('phoenix', `Retrieved ${action} data: ${JSON.stringify(data.data).substring(0, 100)}...`);
                }
            } catch (error) {
                addMessage('phoenix', 'Failed to retrieve data.');
            }
        }

        async function syncWearables() {
            try {
                const response = await fetch(`${API_URL}/mercury/sync`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${phoenixToken}` }
                });
                const data = await response.json();
                alert(data.success ? 'Sync complete!' : 'Sync failed');
                if (data.success) loadAllData();
            } catch (error) {
                alert('Sync error: ' + error.message);
            }
        }

        function viewGoals() {
            quickAction('goals');
            toggleChat();
        }

        function healthAnalysis() {
            quickAction('health');
            toggleChat();
        }

        function updateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('systemTime').textContent = `${hours}:${minutes}`;
            
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            document.getElementById('systemDate').textContent = 
                `${days[now.getDay()]}, ${months[now.getMonth()]} ${now.getDate()}`;
        }

        function initBackgroundCanvas() {
            const canvas = document.getElementById('bg-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const particles = [];
            for (let i = 0; i < 80; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    size: Math.random() * 2 + 1
                });
            }

            let phase = 0;
            function animate() {
                ctx.fillStyle = 'rgba(5, 8, 16, 0.1)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
                    if (p.y < 0 || p.y > canvas.height) p.vy *= -1;

                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(0, 212, 255, ${0.3 + Math.sin(phase) * 0.2})`;
                    ctx.fill();
                });

                const scanY = (canvas.height / 2) + Math.sin(phase * 0.5) * 200;
                const gradient = ctx.createLinearGradient(0, scanY - 2, 0, scanY + 2);
                gradient.addColorStop(0, 'rgba(0, 212, 255, 0)');
                gradient.addColorStop(0.5, 'rgba(0, 212, 255, 0.3)');
                gradient.addColorStop(1, 'rgba(0, 212, 255, 0)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, scanY - 2, canvas.width, 4);

                phase += 0.02;
                requestAnimationFrame(animate);
            }
            animate();
        }
    </script>
</body>
</html>
