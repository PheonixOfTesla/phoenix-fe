<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix - Initialize System</title>
    <style>
        /* ============================================
           PHOENIX ONBOARDING - STREAMLINED (Steve Jobs Method)
           3 Phases: Name ‚Üí Account ‚Üí Planet Tour
           ============================================ */

        :root {
            --primary-cyan: #00d9ff;
            --primary-cyan-glow: rgba(0, 217, 255, 1);
            --primary-cyan-dim: rgba(0, 217, 255, 0.6);
            --primary-cyan-border: rgba(0, 217, 255, 0.3);
            --primary-cyan-bg: rgba(0, 217, 255, 0.1);

            --bg-dark: #000;
            --bg-panel: rgba(0, 10, 20, 0.9);
            --bg-card: rgba(0, 10, 20, 0.8);

            --error-red: #ff4444;
            --success-green: #00ff88;

            --font-primary: 'SF Mono', 'Monaco', 'Courier New', monospace;

            --shadow-glow-cyan: 0 0 20px rgba(0, 217, 255, 0.4);
            --shadow-glow-cyan-strong: 0 0 30px rgba(0, 217, 255, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: var(--bg-dark);
            color: var(--primary-cyan);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* Constellation Canvas */
        #constellation-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* Container */
        .container {
            position: relative;
            z-index: 10;
            max-width: 600px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Phoenix Avatar/Orb */
        .phoenix-avatar {
            width: 150px;
            height: 150px;
            margin: 0 auto 40px;
            position: relative;
        }

        .avatar-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, var(--primary-cyan-bg), transparent);
            border: 3px solid var(--primary-cyan-border);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            animation: corePulse 3s ease-in-out infinite;
        }

        .avatar-circle::after {
            content: '';
            position: absolute;
            width: 70%;
            height: 70%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%,
                rgba(255, 255, 255, 0.9),
                var(--primary-cyan) 25%,
                rgba(0, 200, 255, 0.6) 50%,
                transparent 100%);
            animation: orbBreathe 4s ease-in-out infinite;
            filter: blur(2px);
        }

        @keyframes orbBreathe {
            0%, 100% {
                transform: scale(1);
                opacity: 0.9;
            }
            50% {
                transform: scale(1.15);
                opacity: 1;
            }
        }

        @keyframes corePulse {
            0%, 100% {
                box-shadow: 0 0 40px var(--primary-cyan-glow);
            }
            50% {
                box-shadow: 0 0 60px var(--primary-cyan-glow);
            }
        }

        .avatar-circle.speaking::before {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            border: 2px solid var(--primary-cyan);
            animation: pulse 1.5s ease-out infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.4);
                opacity: 0;
            }
        }

        /* Phase Container */
        .phase {
            display: none;
            text-align: center;
            animation: fadeIn 0.8s ease-out;
            width: 100%;
        }

        .phase.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Status Bar */
        .status-bar {
            display: inline-block;
            padding: 10px 20px;
            border: 1px solid var(--primary-cyan-border);
            margin-bottom: 30px;
            font-size: 14px;
            letter-spacing: 2px;
            color: var(--primary-cyan-dim);
        }

        /* Phoenix Message */
        .phoenix-message {
            font-size: 20px;
            line-height: 1.6;
            margin-bottom: 40px;
            color: var(--primary-cyan);
            text-shadow: 0 0 10px var(--primary-cyan-glow);
        }

        .phoenix-message.large {
            font-size: 32px;
            letter-spacing: 4px;
            margin-bottom: 20px;
        }

        .phoenix-message.subtitle {
            font-size: 16px;
            color: var(--primary-cyan-dim);
            letter-spacing: 2px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-size: 12px;
            letter-spacing: 2px;
            color: var(--primary-cyan-dim);
            text-transform: uppercase;
        }

        .form-input {
            width: 100%;
            padding: 15px 20px;
            background: rgba(0, 10, 20, 0.8);
            border: 1px solid var(--primary-cyan-border);
            color: var(--primary-cyan);
            font-family: var(--font-primary);
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-cyan);
            box-shadow: var(--shadow-glow-cyan);
        }

        .form-input::placeholder {
            color: rgba(0, 217, 255, 0.3);
        }

        /* Phone Number Input Group */
        .phone-input-group {
            display: flex;
            gap: 10px;
        }

        .country-select {
            width: 120px;
            padding: 15px;
            background: rgba(0, 10, 20, 0.8);
            border: 1px solid var(--primary-cyan-border);
            color: var(--primary-cyan);
            font-family: var(--font-primary);
            font-size: 14px;
            cursor: pointer;
        }

        .country-select:focus {
            outline: none;
            border-color: var(--primary-cyan);
            box-shadow: var(--shadow-glow-cyan);
        }

        /* Buttons */
        .btn-primary {
            padding: 18px 50px;
            background: transparent;
            border: 2px solid var(--primary-cyan);
            color: var(--primary-cyan);
            font-family: var(--font-primary);
            font-size: 16px;
            letter-spacing: 3px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            margin: 10px;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-cyan-bg);
            box-shadow: var(--shadow-glow-cyan-strong);
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            padding: 12px 30px;
            background: transparent;
            border: 1px solid var(--primary-cyan-border);
            color: var(--primary-cyan-dim);
            font-family: var(--font-primary);
            font-size: 14px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-secondary:hover {
            color: var(--primary-cyan);
            border-color: var(--primary-cyan);
        }

        .btn-link {
            background: none;
            border: none;
            color: rgba(0, 217, 255, 0.7);
            cursor: pointer;
            text-decoration: underline;
            font-size: 14px;
            font-family: var(--font-primary);
            margin-top: 15px;
        }

        /* Planet Tour Styles */
        .planet-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 40px auto;
            max-width: 500px;
        }

        .planet {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid rgba(0, 217, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            opacity: 0.3;
            transition: all 0.5s;
            position: relative;
        }

        .planet.active {
            opacity: 1;
            border-color: var(--primary-cyan);
            box-shadow: 0 0 30px var(--primary-cyan-glow);
            animation: planetPulse 2s ease-in-out infinite;
        }

        @keyframes planetPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .planet-name {
            font-size: 12px;
            color: var(--primary-cyan-dim);
            margin-top: 10px;
            letter-spacing: 1px;
        }

        .planet.active .planet-name {
            color: var(--primary-cyan);
        }

        /* Skip Button */
        .skip-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 12px 24px;
            background: rgba(0, 10, 20, 0.9);
            border: 1px solid var(--primary-cyan-border);
            color: var(--primary-cyan-dim);
            font-family: var(--font-primary);
            font-size: 12px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 100;
        }

        .skip-btn:hover {
            color: var(--primary-cyan);
            border-color: var(--primary-cyan);
            box-shadow: var(--shadow-glow-cyan);
        }

        /* Error Message */
        .error-message {
            color: var(--error-red);
            font-size: 14px;
            margin-top: 15px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary-cyan-border);
            border-top-color: var(--primary-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 20px 15px;
            }

            .phoenix-avatar {
                width: 120px;
                height: 120px;
            }

            .phoenix-message.large {
                font-size: 24px;
            }

            .planet-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
            }

            .planet {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <!-- Constellation Background -->
    <canvas id="constellation-canvas"></canvas>

    <div class="container">
        <!-- PHASE -1: Audio Unlock (Click to Start) -->
        <div id="phase-start" class="phase active">
            <div class="phoenix-avatar">
                <div class="avatar-circle"></div>
            </div>

            <div class="status-bar">[ SYSTEM READY ]</div>

            <div class="phoenix-message large">
                PHOENIX INITIALIZE
            </div>

            <div class="phoenix-message subtitle">
                AI-Powered Life Operating System
            </div>

            <button class="btn-primary" id="initializeBtn" onclick="unlockAudioAndStart()" style="margin-top: 40px;">
                [ INITIALIZE SYSTEM ]
            </button>
        </div>

        <!-- PHASE 0: What's Your Name? -->
        <div id="phase-0" class="phase">
            <div class="phoenix-avatar">
                <div class="avatar-circle" id="avatar-0"></div>
            </div>

            <div class="status-bar">[ SYSTEM READY ]</div>

            <div class="phoenix-message">
                Hey, I'm Phoenix.<br>What should I call you?
            </div>

            <div class="form-group">
                <input type="text"
                       class="form-input"
                       id="userName"
                       placeholder="Your name"
                       autocomplete="name"
                       style="text-align: center; font-size: 20px;">
            </div>

            <button class="btn-primary" id="nameSubmitBtn" onclick="submitName()">
                CONTINUE
            </button>

            <div class="error-message" id="nameError"></div>
        </div>

        <!-- PHASE 1: Create Account -->
        <div id="phase-1" class="phase">
            <div class="phoenix-avatar">
                <div class="avatar-circle" id="avatar-1"></div>
            </div>

            <div class="status-bar">[ CREATING PROFILE ]</div>

            <div class="phoenix-message" id="greetingMessage">
                Hey <span id="userNameDisplay"></span>,<br>
                We need to create you an account before we get the ball rolling.
            </div>

            <form id="accountForm" onsubmit="createAccount(event)">
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <div class="phone-input-group">
                        <select class="country-select" id="countryCode">
                            <option value="+1" data-country="US" selected>üá∫üá∏ +1</option>
                            <option value="+44" data-country="GB">üá¨üáß +44</option>
                            <option value="+61" data-country="AU">üá¶üá∫ +61</option>
                            <option value="+91" data-country="IN">üáÆüá≥ +91</option>
                            <option value="+86" data-country="CN">üá®üá≥ +86</option>
                            <option value="+81" data-country="JP">üáØüáµ +81</option>
                            <option value="+49" data-country="DE">üá©üá™ +49</option>
                            <option value="+33" data-country="FR">üá´üá∑ +33</option>
                            <option value="+39" data-country="IT">üáÆüáπ +39</option>
                            <option value="+34" data-country="ES">üá™üá∏ +34</option>
                            <option value="+7" data-country="RU">üá∑üá∫ +7</option>
                            <option value="+55" data-country="BR">üáßüá∑ +55</option>
                            <option value="+27" data-country="ZA">üáøüá¶ +27</option>
                            <option value="+82" data-country="KR">üá∞üá∑ +82</option>
                            <option value="+31" data-country="NL">üá≥üá± +31</option>
                        </select>
                        <input type="tel"
                               class="form-input"
                               id="phoneNumber"
                               placeholder="(555) 123-4567"
                               autocomplete="tel"
                               required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password"
                           class="form-input"
                           id="password"
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                           autocomplete="new-password"
                           minlength="6"
                           required>
                </div>

                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password"
                           class="form-input"
                           id="confirmPassword"
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                           autocomplete="new-password"
                           minlength="6"
                           required>
                </div>

                <button type="submit" class="btn-primary" id="createAccountBtn">
                    CREATE ACCOUNT
                </button>

                <button type="button" class="btn-link" onclick="toggleEmailMode()">
                    Sign up with email instead
                </button>
            </form>

            <div class="error-message" id="accountError"></div>
        </div>

        <!-- PHASE 2: Planet Tour -->
        <div id="phase-2" class="phase">
            <div class="phoenix-avatar">
                <div class="avatar-circle" id="avatar-2"></div>
            </div>

            <div class="status-bar" id="tourStatus">[ SYSTEM INITIALIZED ]</div>

            <div class="phoenix-message">
                Welcome to your Phoenix interface.<br>
                <span id="tourPrompt">Would you like me to show you what I can do?</span>
            </div>

            <div class="planet-grid" id="planetGrid">
                <!-- Planets will be dynamically generated -->
            </div>

            <button class="btn-primary" id="startTourBtn" onclick="startPlanetTour()" style="display: block;">
                SHOW ME
            </button>

            <button class="btn-primary" id="enterDashboardBtn" onclick="launchApp()" style="display: none;">
                ENTER PHOENIX
            </button>

            <button class="skip-btn" id="skipBtn" onclick="skipTour()">
                Skip Tour ‚Üí
            </button>
        </div>
    </div>

    <script>
        console.log('üöÄ Phoenix Onboarding - Streamlined Version Starting...');

        // ============================================
        // CONFIGURATION
        // ============================================
        const API_BASE_URL = 'https://pal-backend-production.up.railway.app/api';

        // User data object
        let userData = {
            name: '',
            phone: '',
            email: '',
            password: '',
            language: 'en',
            voice: 'nova',  // Default voice
            personality: 'friendly_helpful',  // Default personality
            authToken: null,
            // Auto-detected location data
            city: null,
            country: null,
            latitude: null,
            longitude: null,
            timezone: null
        };

        let currentPhase = 0;
        let currentAudio = null;
        let planetTourTimer = null;
        let usingEmailMode = false;

        // ============================================
        // CONSTELLATION BACKGROUND
        // ============================================
        function initConstellation() {
            const canvas = document.getElementById('constellation-canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const stars = [];
            const numStars = 100;

            for (let i = 0; i < numStars; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: Math.random() * 1.5,
                    alpha: Math.random()
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                stars.forEach(star => {
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(0, 217, 255, ${star.alpha})`;
                    ctx.fill();

                    // Twinkle effect
                    star.alpha += (Math.random() - 0.5) * 0.02;
                    star.alpha = Math.max(0, Math.min(1, star.alpha));
                });

                requestAnimationFrame(animate);
            }

            animate();

            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        // ============================================
        // AUTO-DETECT LANGUAGE
        // ============================================
        function autoDetectLanguage() {
            const savedLang = localStorage.getItem('phoenixLanguage');
            if (savedLang) {
                console.log('üåç Using saved language:', savedLang);
                return savedLang;
            }

            const browserLang = navigator.language || navigator.userLanguage;
            console.log('üåç Detected browser language:', browserLang);

            // Map to supported languages (simplified)
            const langMap = {
                'en': 'en', 'es': 'es', 'fr': 'fr', 'de': 'de', 'it': 'it',
                'pt': 'pt', 'nl': 'nl', 'pl': 'pl', 'ru': 'ru', 'ja': 'ja',
                'zh': 'zh', 'ar': 'ar', 'hi': 'hi', 'ko': 'ko'
            };

            const detectedLang = langMap[browserLang.split('-')[0]] || 'en';
            console.log('‚úÖ Auto-detected language:', detectedLang);

            localStorage.setItem('phoenixLanguage', detectedLang);
            return detectedLang;
        }

        // ============================================
        // AUTO-DETECT LOCATION (IP GEOLOCATION)
        // ============================================
        async function autoDetectLocation() {
            try {
                console.log('üìç Auto-detecting location via IP geolocation...');

                // Use ipapi.co free tier (no API key required)
                const response = await fetch('https://ipapi.co/json/');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const locationData = await response.json();

                console.log('‚úÖ Location detected:', {
                    city: locationData.city,
                    country: locationData.country_name,
                    timezone: locationData.timezone
                });

                // Update userData with location info
                userData.city = locationData.city || null;
                userData.country = locationData.country_name || null;
                userData.latitude = locationData.latitude || null;
                userData.longitude = locationData.longitude || null;
                userData.timezone = locationData.timezone || null;

                // Save to localStorage for future use
                localStorage.setItem('phoenixCity', locationData.city || '');
                localStorage.setItem('phoenixCountry', locationData.country_name || '');
                localStorage.setItem('phoenixTimezone', locationData.timezone || '');

                return {
                    city: locationData.city,
                    country: locationData.country_name,
                    latitude: locationData.latitude,
                    longitude: locationData.longitude,
                    timezone: locationData.timezone
                };

            } catch (error) {
                console.error('‚ùå Location detection failed:', error);
                // Don't block onboarding if location detection fails
                return null;
            }
        }

        // ============================================
        // PHOENIX SPEAK (TTS)
        // ============================================
        async function phoenixSpeak(text, avatarId = 'avatar-0') {
            console.log('[TTS] Speaking:', text.substring(0, 50) + '...');

            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            const avatar = document.getElementById(avatarId);
            if (avatar) avatar.classList.add('speaking');

            try {
                const response = await fetch(`${API_BASE_URL}/tts/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        voice: userData.voice,
                        language: userData.language
                    })
                });

                if (!response.ok) {
                    throw new Error(`TTS failed: ${response.status}`);
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);

                currentAudio = new Audio(audioUrl);

                // Wait for audio to be buffered before playing (prevents clipping)
                await new Promise(bufferResolve => {
                    const timeout = setTimeout(bufferResolve, 100); // 100ms fallback
                    currentAudio.addEventListener('canplay', () => {
                        clearTimeout(timeout);
                        bufferResolve();
                    }, { once: true });
                });

                // Return a Promise that resolves when audio finishes
                return new Promise((resolve) => {
                    currentAudio.onended = () => {
                        if (avatar) avatar.classList.remove('speaking');
                        URL.revokeObjectURL(audioUrl);
                        console.log('‚úÖ TTS playback completed');
                        resolve();  // Audio finished
                    };

                    currentAudio.play().catch(err => {
                        console.error('‚ùå Audio play error:', err);
                        if (avatar) avatar.classList.remove('speaking');
                        URL.revokeObjectURL(audioUrl);
                        resolve();  // Resolve anyway so we don't block
                    });
                });
            } catch (error) {
                console.error('‚ùå TTS Error:', error);
                if (avatar) avatar.classList.remove('speaking');
            }
        }

        // ============================================
        // AUDIO UNLOCK (Click to Start)
        // ============================================
        let audioUnlocked = false;

        function unlockAudioAndStart() {
            // Prevent multiple clicks
            if (audioUnlocked) {
                console.log('‚ö†Ô∏è Already initializing...');
                return;
            }
            audioUnlocked = true;

            console.log('üîä Audio unlocked via user interaction');

            // Disable button and show loading
            const btn = document.getElementById('initializeBtn');
            btn.disabled = true;
            btn.textContent = '[ INITIALIZING... ]';

            // Hide start screen after short delay
            setTimeout(() => {
                document.getElementById('phase-start').classList.remove('active');

                // Show Phase 0
                document.getElementById('phase-0').classList.add('active');

                // Now we can play audio (user clicked, browser allows it)
                setTimeout(() => {
                    phoenixSpeak("I'm Phoenix. What should I call you?", 'avatar-0');
                }, 500);
            }, 300);
        }

        // ============================================
        // PHASE 0: NAME INPUT
        // ============================================
        let nameSubmitted = false;

        async function submitName() {
            // Prevent multiple submissions
            if (nameSubmitted) {
                console.log('‚ö†Ô∏è Name already submitted...');
                return;
            }

            const nameInput = document.getElementById('userName');
            const name = nameInput.value.trim();
            const errorEl = document.getElementById('nameError');
            const btn = document.getElementById('nameSubmitBtn');

            if (!name) {
                errorEl.textContent = 'Please enter your name';
                errorEl.classList.add('show');
                return;
            }

            if (name.length < 2) {
                errorEl.textContent = 'Name must be at least 2 characters';
                errorEl.classList.add('show');
                return;
            }

            // Lock submission
            nameSubmitted = true;
            btn.disabled = true;
            btn.textContent = 'PROCESSING...';

            console.log('‚úÖ Name submitted:', name);
            userData.name = name;
            errorEl.classList.remove('show');

            // Move to Phase 1 (name will be greeted there)
            setTimeout(() => {
                goToPhase(1);
                nameSubmitted = false; // Reset for future use if needed
            }, 300);
        }

        // Handle Enter key on name input
        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('userName');
            if (nameInput) {
                nameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        submitName();
                    }
                });
            }
        });

        // ============================================
        // PHASE 1: CREATE ACCOUNT
        // ============================================
        function toggleEmailMode() {
            usingEmailMode = !usingEmailMode;
            const form = document.getElementById('accountForm');

            if (usingEmailMode) {
                // Show email input instead of phone
                form.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email"
                               class="form-input"
                               id="emailAddress"
                               placeholder="your@email.com"
                               autocomplete="email"
                               required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password"
                               class="form-input"
                               id="password"
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                               autocomplete="new-password"
                               minlength="6"
                               required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        <input type="password"
                               class="form-input"
                               id="confirmPassword"
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                               autocomplete="new-password"
                               minlength="6"
                               required>
                    </div>

                    <button type="submit" class="btn-primary" id="createAccountBtn">
                        CREATE ACCOUNT
                    </button>

                    <button type="button" class="btn-link" onclick="toggleEmailMode()">
                        Sign up with phone number
                    </button>
                `;
            } else {
                // Show phone input (restore original)
                location.reload(); // Quick way to restore original form
            }

            form.onsubmit = createAccount;
        }

        async function createAccount(event) {
            event.preventDefault();
            console.log('üìù Creating account...');

            const errorEl = document.getElementById('accountError');
            const submitBtn = document.getElementById('createAccountBtn');
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate passwords match
            if (password !== confirmPassword) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.classList.add('show');
                return;
            }

            // Get phone or email
            let identifier, identifierType;
            if (usingEmailMode) {
                identifier = document.getElementById('emailAddress').value;
                identifierType = 'email';
                userData.email = identifier;
            } else {
                const countryCode = document.getElementById('countryCode').value;
                const phoneNumber = document.getElementById('phoneNumber').value;
                identifier = countryCode + phoneNumber.replace(/\D/g, '');
                identifierType = 'phone';
                userData.phone = identifier;
            }

            userData.password = password;

            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'CREATING... <span class="loading"></span>';
            errorEl.classList.remove('show');

            try {
                console.log('üì§ Sending registration request...');
                console.log('   Name:', userData.name);
                console.log('   Type:', identifierType);
                console.log('   Value:', identifier);
                console.log('   Language:', userData.language);
                console.log('   Voice:', userData.voice);
                console.log('   Personality:', userData.personality);

                const requestBody = {
                    name: userData.name,
                    [identifierType]: identifier,
                    password: password,
                    language: userData.language,
                    voice: userData.voice,
                    personality: userData.personality,
                    city: userData.city,
                    country: userData.country,
                    latitude: userData.latitude,
                    longitude: userData.longitude,
                    timezone: userData.timezone
                };

                console.log('üì¶ Request body:', JSON.stringify(requestBody, null, 2));

                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('üì• Response status:', response.status);
                console.log('üì• Response headers:', Object.fromEntries(response.headers.entries()));

                const data = await response.json();
                console.log('üì• Response data:', data);

                if (!response.ok) {
                    throw new Error(data.error || data.message || 'Registration failed');
                }

                if (data.token) {
                    console.log('‚úÖ Registration successful! Token received.');
                    userData.authToken = data.token;
                    localStorage.setItem('phoenixToken', data.token);
                    localStorage.setItem('phoenixName', userData.name);
                    localStorage.setItem('phoenixLanguage', userData.language);
                    localStorage.setItem('phoenixVoice', userData.voice);

                    // Speak confirmation and WAIT for it to finish
                    await phoenixSpeak(`Perfect. You're all set, ${userData.name}.`, 'avatar-1');

                    // Move to Phase 2 (Planet Tour) after audio completes
                    setTimeout(() => {
                        goToPhase(2);
                    }, 500);
                } else {
                    throw new Error('No token received from server');
                }

            } catch (error) {
                console.error('‚ùå Registration error:', error);
                errorEl.textContent = error.message;
                errorEl.classList.add('show');
                submitBtn.disabled = false;
                submitBtn.textContent = 'CREATE ACCOUNT';
            }
        }

        // ============================================
        // PHASE 2: PLANET TOUR
        // ============================================
        const planets = [
            { name: 'Mercury', emoji: 'üíô', description: "Track your health and vitals - I can connect to your wearables and monitor your recovery." },
            { name: 'Venus', emoji: 'üíú', description: "Log workouts, meals, and body composition - I'll help you reach your fitness goals." },
            { name: 'Earth', emoji: 'üåç', description: "Sync your calendar - I can reorganize your schedule based on your energy levels and priorities." },
            { name: 'Mars', emoji: 'üî¥', description: "Set goals and build habits - from starting a business to saving $5,000." },
            { name: 'Jupiter', emoji: 'üü°', description: "Manage your finances - track spending, budgets, and get insights on your money." },
            { name: 'Saturn', emoji: 'ü™ê', description: "Plan your legacy - quarterly reviews and long-term vision." },
            { name: 'Uranus', emoji: 'üîµ', description: "Innovate and track ideas - capture breakthroughs and creative projects." },
            { name: 'Neptune', emoji: 'üíé', description: "Understand your dreams and intuition - I'll help you decode patterns." }
        ];

        function initPlanetGrid() {
            const grid = document.getElementById('planetGrid');
            grid.innerHTML = planets.map((planet, i) => `
                <div class="planet" id="planet-${i}">
                    <div style="text-align: center;">
                        <div style="font-size: 32px;">${planet.emoji}</div>
                        <div class="planet-name">${planet.name}</div>
                    </div>
                </div>
            `).join('');
        }

        let tourStarted = false;

        async function startPlanetTour() {
            // Prevent multiple clicks
            if (tourStarted) {
                console.log('‚ö†Ô∏è Tour already started...');
                return;
            }
            tourStarted = true;

            console.log('üåç Starting planet tour...');

            const btn = document.getElementById('startTourBtn');
            btn.disabled = true;
            btn.textContent = 'LOADING...';

            setTimeout(() => {
                btn.style.display = 'none';
                document.getElementById('tourPrompt').textContent = 'Let me show you around...';
            }, 300);

            for (let i = 0; i < planets.length; i++) {
                const planet = planets[i];
                const planetEl = document.getElementById(`planet-${i}`);

                // Activate planet
                planetEl.classList.add('active');

                // Update status
                document.getElementById('tourStatus').textContent = `[ ${planet.name.toUpperCase()} ]`;

                // Speak description
                await phoenixSpeak(planet.description, 'avatar-2');

                // Wait before next planet
                await new Promise(resolve => {
                    planetTourTimer = setTimeout(resolve, 1500);
                });
            }

            // Tour complete
            console.log('‚úÖ Planet tour complete');
            document.getElementById('tourStatus').textContent = '[ READY FOR LAUNCH ]';
            document.getElementById('tourPrompt').textContent = "I'm your therapist, coach, and assistant - for less than a Netflix subscription. And I'll know you better than any of them combined.";

            await phoenixSpeak("I'm your therapist, coach, and assistant - for less than a Netflix subscription. And I'll know you better than any of them combined. Ready to begin?", 'avatar-2');

            // Show launch button
            setTimeout(() => {
                document.getElementById('enterDashboardBtn').style.display = 'block';
                document.getElementById('skipBtn').style.display = 'none';
            }, 2000);
        }

        let isLaunching = false;

        function skipTour() {
            if (isLaunching) {
                console.log('‚ö†Ô∏è Already launching...');
                return;
            }

            console.log('‚è≠Ô∏è Skipping tour...');

            // Stop any playing audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            // Clear timers
            if (planetTourTimer) {
                clearTimeout(planetTourTimer);
            }

            // Disable skip button
            const skipBtn = document.getElementById('skipBtn');
            if (skipBtn) {
                skipBtn.disabled = true;
                skipBtn.style.opacity = '0.5';
            }

            // Go straight to dashboard
            launchApp();
        }

        async function launchApp() {
            if (isLaunching) {
                console.log('‚ö†Ô∏è Already launching...');
                return;
            }
            isLaunching = true;

            console.log('üöÄ Launching Phoenix dashboard...');

            localStorage.setItem('phoenixOnboardingComplete', 'true');

            // Disable any visible buttons
            const enterBtn = document.getElementById('enterDashboardBtn');
            if (enterBtn) {
                enterBtn.disabled = true;
                enterBtn.textContent = 'LAUNCHING...';
            }

            // Speak and WAIT for audio to complete
            await phoenixSpeak('Activating your system now...', 'avatar-2');

            // Redirect after audio completes (small buffer)
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 500);
        }

        // ============================================
        // PHASE NAVIGATION
        // ============================================
        function goToPhase(phaseNum) {
            console.log(`üìç Moving to Phase ${phaseNum}`);

            // Hide current phase
            document.querySelectorAll('.phase').forEach(p => p.classList.remove('active'));

            // Show target phase
            const targetPhase = document.getElementById(`phase-${phaseNum}`);
            if (targetPhase) {
                targetPhase.classList.add('active');
                currentPhase = phaseNum;

                // Phase-specific actions
                if (phaseNum === 1) {
                    // Update greeting with user's name
                    document.getElementById('userNameDisplay').textContent = userData.name;

                    // Speak greeting and wait for audio
                    setTimeout(async () => {
                        await phoenixSpeak(`Hey ${userData.name}, we need to create you an account before we get the ball rolling.`, 'avatar-1');
                    }, 500);
                }

                if (phaseNum === 2) {
                    // Initialize planet grid
                    initPlanetGrid();

                    // Speak welcome and wait for audio
                    setTimeout(async () => {
                        await phoenixSpeak(`Welcome to your Phoenix interface. Would you like me to show you what I can do?`, 'avatar-2');
                    }, 500);
                }
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üé¨ Initializing Phoenix Onboarding...');

            // Init constellation background
            initConstellation();

            // Auto-detect language
            userData.language = autoDetectLanguage();
            console.log('üåç Language set to:', userData.language);

            // Auto-detect location (for weather, timezone)
            await autoDetectLocation();
            console.log('üìç Location detection complete');

            // Default voice and personality
            userData.voice = 'nova';
            userData.personality = 'friendly_helpful';
            console.log('üéôÔ∏è Voice set to:', userData.voice);
            console.log('ü§ñ Personality set to:', userData.personality);

            // Don't auto-play audio on load (browser blocks it anyway)
            // Audio will start when user clicks CONTINUE (after interaction)

            console.log('‚úÖ Onboarding initialized');
        });
    </script>
</body>
</html>
