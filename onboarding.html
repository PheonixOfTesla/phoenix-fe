<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix - Initialize System</title>
    <style>
        /* ============================================
           PHOENIX ONBOARDING - HOLOGRAPHIC INTERFACE
           ============================================ */
        
        :root {
            --primary-cyan: #00ffff;
            --primary-cyan-glow: rgba(0, 255, 255, 1);
            --primary-cyan-dim: rgba(0, 255, 255, 0.6);
            --primary-cyan-border: rgba(0, 255, 255, 0.3);
            --primary-cyan-bg: rgba(0, 255, 255, 0.1);
            
            --bg-dark: #000;
            --bg-panel: rgba(0, 10, 20, 0.9);
            --bg-card: rgba(0, 10, 20, 0.8);
            
            --error-red: #ff4444;
            --success-green: #00ff88;
            
            --font-primary: 'Courier New', 'Consolas', monospace;
            
            --shadow-glow-cyan: 0 0 20px rgba(0, 255, 255, 0.4);
            --shadow-glow-cyan-strong: 0 0 30px rgba(0, 255, 255, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-primary);
            background: var(--bg-dark);
            color: var(--primary-cyan);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* Constellation Canvas */
        #constellation-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* Grid Underlay */
        .grid-underlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(var(--primary-cyan-border) 1px, transparent 1px),
                linear-gradient(90deg, var(--primary-cyan-border) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.1;
            pointer-events: none;
            z-index: 0;
            animation: gridMove 60s linear infinite;
        }

        @keyframes gridMove {
            0% { background-position: 0 0; }
            100% { background-position: 50px 50px; }
        }

        /* VHS Overlay */
        .vhs-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.1) 2px,
                rgba(0, 0, 0, 0.1) 4px
            );
            pointer-events: none;
            z-index: 3;
            opacity: 0.3;
            animation: vhsScan 8s linear infinite;
        }

        @keyframes vhsScan {
            0% { background-position: 0 0; }
            100% { background-position: 0 100vh; }
        }

        /* Container */
        .container {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow-y: auto;
        }

        /* Progress Bar */
        .progress-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--primary-cyan-border);
        }

        .progress-bar {
            height: 4px;
            background: linear-gradient(90deg, var(--primary-cyan), var(--primary-cyan-glow));
            transition: width 0.5s ease;
            box-shadow: 0 0 20px var(--primary-cyan-glow);
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            padding: 15px 40px;
            max-width: 900px;
            margin: 0 auto;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0.3;
            transition: opacity 0.3s;
            font-size: 11px;
            letter-spacing: 1px;
        }

        .progress-step.active {
            opacity: 1;
            color: var(--primary-cyan);
            text-shadow: 0 0 10px var(--primary-cyan-glow);
        }

        .progress-step.completed {
            opacity: 0.6;
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--primary-cyan-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s;
        }

        .progress-step.active .step-number {
            border-color: var(--primary-cyan);
            background: var(--primary-cyan-bg);
            box-shadow: var(--shadow-glow-cyan);
        }

        .progress-step.completed .step-number {
            border-color: var(--primary-cyan);
            background: var(--primary-cyan);
            color: #000;
        }

        /* Phase Container */
        .phase {
            display: none;
            animation: fadeIn 0.6s ease-out;
        }

        .phase.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Phoenix Avatar */
        .phoenix-avatar {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            position: relative;
        }

        .avatar-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, var(--primary-cyan-bg), transparent);
            border: 3px solid var(--primary-cyan-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            position: relative;
            overflow: hidden;
            animation: corePulse 3s ease-in-out infinite;
        }

        /* Energy Orb Inside Avatar */
        .avatar-circle::after {
            content: '';
            position: absolute;
            width: 60%;
            height: 60%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%,
                rgba(255, 255, 255, 0.9),
                var(--primary-cyan) 25%,
                rgba(0, 200, 255, 0.6) 50%,
                transparent 100%);
            animation: orbBreathe 4s ease-in-out infinite, orbFloat 6s ease-in-out infinite;
            filter: blur(2px);
        }

        @keyframes orbBreathe {
            0%, 100% {
                transform: scale(1);
                opacity: 0.9;
            }
            50% {
                transform: scale(1.15);
                opacity: 1;
            }
        }

        @keyframes orbFloat {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            33% {
                transform: translate(5px, -5px) scale(1.05);
            }
            66% {
                transform: translate(-5px, 3px) scale(0.95);
            }
        }

        @keyframes corePulse {
            0%, 100% {
                box-shadow: 0 0 30px var(--primary-cyan-glow);
            }
            50% {
                box-shadow: 0 0 50px var(--primary-cyan-glow);
            }
        }

        .avatar-circle::before {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            border: 2px solid var(--primary-cyan);
            opacity: 0;
        }

        .avatar-circle.speaking::before {
            animation: pulse 1.5s ease-out infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.4);
                opacity: 0;
            }
        }

        /* Voice Status */
        .voice-status {
            text-align: center;
            margin-bottom: 30px;
            padding: 12px;
            background: rgba(0, 255, 255, 0.03);
            border: 1px solid var(--primary-cyan-border);
            border-radius: 4px;
            font-size: 12px;
            letter-spacing: 2px;
            transition: all 0.3s;
        }

        .voice-status.speaking {
            animation: statusGlow 1.5s ease-in-out infinite;
        }

        @keyframes statusGlow {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
                border-color: var(--primary-cyan-border);
            }
            50% { 
                box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
                border-color: var(--primary-cyan);
            }
        }

        /* Phase Header */
        .phase-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .phase-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--primary-cyan);
            text-shadow: 0 0 20px var(--primary-cyan-glow);
            letter-spacing: 2px;
        }

        .phase-subtitle {
            font-size: 14px;
            color: var(--primary-cyan-dim);
            letter-spacing: 1px;
        }

        /* Selection Grid */
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .selection-card {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.05), rgba(0, 255, 255, 0.1));
            border: 1px solid var(--primary-cyan-border);
            border-radius: 4px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .selection-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .selection-card:hover {
            border-color: var(--primary-cyan);
            background: rgba(0, 255, 255, 0.15);
            transform: translateY(-4px);
            box-shadow: var(--shadow-glow-cyan-strong);
        }

        .selection-card:hover::before {
            left: 100%;
        }

        .selection-card.selected {
            border-color: var(--primary-cyan);
            background: rgba(0, 255, 255, 0.2);
            box-shadow: var(--shadow-glow-cyan);
        }

        .selection-card .icon {
            font-size: 48px;
            margin-bottom: 16px;
            text-shadow: 0 0 10px var(--primary-cyan-glow);
        }

        .selection-card .title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-cyan);
        }

        .selection-card .subtitle {
            font-size: 12px;
            color: var(--primary-cyan-dim);
        }

        /* Voice Preview Button */
        .voice-preview-btn {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid var(--primary-cyan-border);
            color: var(--primary-cyan);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 12px;
            font-size: 11px;
            letter-spacing: 1px;
            font-family: var(--font-primary);
            transition: all 0.2s;
        }

        .voice-preview-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            border-color: var(--primary-cyan);
            box-shadow: var(--shadow-glow-cyan);
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: var(--primary-cyan-dim);
            margin-bottom: 8px;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px;
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid var(--primary-cyan-border);
            border-radius: 4px;
            color: var(--primary-cyan);
            font-size: 14px;
            font-family: var(--font-primary);
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-cyan);
            background: rgba(0, 255, 255, 0.1);
            box-shadow: var(--shadow-glow-cyan);
        }

        /* Phone Input with Country Code */
        .phone-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .country-selector {
            width: 120px !important;
            flex-shrink: 0;
            cursor: pointer;
            padding: 14px 10px !important;
            background: rgba(0, 255, 255, 0.05) !important;
            border: 1px solid var(--primary-cyan-border) !important;
            color: var(--primary-cyan) !important;
        }

        .country-selector:focus {
            outline: none !important;
            border-color: var(--primary-cyan) !important;
            background: rgba(0, 255, 255, 0.1) !important;
            box-shadow: var(--shadow-glow-cyan) !important;
        }

        .phone-input-wrapper input {
            flex: 1;
        }

        /* Code Input */
        .code-input-wrapper {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 30px 0;
        }

        .code-digit {
            width: 60px;
            height: 70px;
            font-size: 32px;
            text-align: center;
            background: rgba(0, 255, 255, 0.05);
            border: 2px solid var(--primary-cyan-border);
            border-radius: 4px;
            color: var(--primary-cyan);
            font-weight: bold;
            font-family: var(--font-primary);
            transition: all 0.3s;
        }

        .code-digit:focus {
            outline: none;
            border-color: var(--primary-cyan);
            background: rgba(0, 255, 255, 0.1);
            box-shadow: var(--shadow-glow-cyan);
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 32px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            min-width: 140px;
            font-family: var(--font-primary);
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--primary-cyan-border);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--primary-cyan-bg);
            color: var(--primary-cyan);
            border: 2px solid var(--primary-cyan);
            box-shadow: var(--shadow-glow-cyan);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow-cyan-strong);
        }

        .btn-primary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary-cyan-dim);
            border: 1px solid var(--primary-cyan-border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-cyan);
        }

        .btn-skip {
            background: transparent;
            color: rgba(255, 255, 255, 0.4);
            border: none;
            text-decoration: underline;
        }

        /* Device Cards */
        .device-card {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.05), rgba(0, 255, 255, 0.1));
            border: 1px solid var(--primary-cyan-border);
            border-radius: 4px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .device-card:hover:not(.disabled) {
            border-color: var(--primary-cyan);
            transform: translateY(-4px);
            box-shadow: var(--shadow-glow-cyan);
        }

        .device-card.connected {
            border-color: var(--success-green);
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .device-card.connected .device-status {
            color: var(--success-green);
            font-weight: 600;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .device-card.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .device-card .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .device-card .title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-cyan);
        }

        .device-status {
            font-size: 11px;
            color: var(--primary-cyan-dim);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            background: var(--bg-panel);
            border: 1px solid var(--primary-cyan);
            color: var(--primary-cyan);
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
            letter-spacing: 1px;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            box-shadow: var(--shadow-glow-cyan);
        }

        .toast.error {
            border-color: var(--error-red);
            color: var(--error-red);
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.4);
        }

        .toast.success {
            border-color: var(--success-green);
            color: var(--success-green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 255, 255, 0.2);
            border-top-color: var(--primary-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Intro Text */
        .intro-text {
            text-align: center;
            max-width: 600px;
            margin: 0 auto 40px;
            line-height: 1.8;
            color: var(--primary-cyan-dim);
            font-size: 14px;
        }

        .intro-text p {
            margin-bottom: 16px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .progress-steps {
                padding: 15px 20px;
                overflow-x: auto;
            }

            .progress-step {
                font-size: 10px;
            }

            .step-number {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }

            .phase-title {
                font-size: 24px;
            }

            .selection-grid {
                grid-template-columns: 1fr;
            }

            .code-digit {
                width: 50px;
                height: 60px;
                font-size: 28px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <canvas id="constellation-canvas"></canvas>
    <div class="grid-underlay"></div>
    <div class="vhs-overlay"></div>

    <!-- Progress Bar -->
    <div class="progress-wrapper">
        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        <div class="progress-steps">
            <div class="progress-step active" data-step="0">
                <div class="step-number">0</div>
                <span>INIT</span>
            </div>
            <div class="progress-step" data-step="1">
                <div class="step-number">1</div>
                <span>LANG</span>
            </div>
            <div class="progress-step" data-step="2">
                <div class="step-number">2</div>
                <span>VOICE</span>
            </div>
            <div class="progress-step" data-step="3">
                <div class="step-number">3</div>
                <span>AUTH</span>
            </div>
            <div class="progress-step" data-step="4">
                <div class="step-number">4</div>
                <span>VERIFY</span>
            </div>
            <div class="progress-step" data-step="5">
                <div class="step-number">5</div>
                <span>SYNC</span>
            </div>
            <div class="progress-step" data-step="6">
                <div class="step-number">6</div>
                <span>GOALS</span>
            </div>
            <div class="progress-step" data-step="7">
                <div class="step-number">7</div>
                <span>PERSONA</span>
            </div>
            <div class="progress-step" data-step="8">
                <div class="step-number">8</div>
                <span>LAUNCH</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Phase 0: Welcome -->
        <div class="phase active" id="phase0">
            <div class="phoenix-avatar">
                <div class="avatar-circle" id="avatarCircle0"></div>
            </div>
            <div class="voice-status" id="voiceStatus0">
                [ SYSTEM READY ]
            </div>
            <div class="phase-header">
                <h1 class="phase-title" data-i18n="phase.init">PHOENIX INITIALIZE</h1>
                <p class="phase-subtitle">AI-POWERED LIFE OPERATING SYSTEM</p>
            </div>
            <div class="intro-text">
                <p>I'M PHOENIX, YOUR PERSONAL AI COMPANION.</p>
                <p>I'LL HELP YOU OPTIMIZE YOUR HEALTH, FITNESS, PRODUCTIVITY, AND LIFE DECISIONS.</p>
                <p>LET'S GET YOU SET UP. THIS WILL TAKE APPROXIMATELY 180 SECONDS.</p>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="startOnboarding()">[ INITIALIZE SYSTEM ]</button>
            </div>
        </div>

        <!-- Phase 1: Language Selection -->
        <div class="phase" id="phase1">
            <div class="phoenix-avatar">
                <div class="avatar-circle" id="avatarCircle1"></div>
            </div>
            <div class="voice-status" id="voiceStatus1">[ VOICE ACTIVE ]</div>
            <div class="phase-header">
                <h1 class="phase-title" data-i18n="phase.language">SELECT LANGUAGE</h1>
                <p class="phase-subtitle" data-i18n="phase.language.subtitle">CHOOSE YOUR PREFERRED LANGUAGE</p>
            </div>
            <div class="selection-grid" id="languageGrid">
                <!-- Core 11 languages with full i18n support -->
                <div class="selection-card" data-lang="en" onclick="switchLanguage('en')" data-name="English">
                    <div class="icon">üá¨üáß</div>
                    <div class="title">ENGLISH</div>
                    <div class="subtitle">Global</div>
                </div>
                <div class="selection-card" data-lang="es" onclick="switchLanguage('es')" data-name="Spanish">
                    <div class="icon">üá™üá∏</div>
                    <div class="title">ESPA√ëOL</div>
                    <div class="subtitle">Spanish</div>
                </div>
                <div class="selection-card" data-lang="fr" onclick="switchLanguage('fr')" data-name="French">
                    <div class="icon">üá´üá∑</div>
                    <div class="title">FRAN√áAIS</div>
                    <div class="subtitle">French</div>
                </div>
                <div class="selection-card" data-lang="de" onclick="switchLanguage('de')" data-name="German">
                    <div class="icon">üá©üá™</div>
                    <div class="title">DEUTSCH</div>
                    <div class="subtitle">German</div>
                </div>
                <div class="selection-card" data-lang="it" onclick="switchLanguage('it')" data-name="Italian">
                    <div class="icon">üáÆüáπ</div>
                    <div class="title">ITALIANO</div>
                    <div class="subtitle">Italian</div>
                </div>
                <div class="selection-card" data-lang="pt" onclick="switchLanguage('pt')" data-name="Portuguese">
                    <div class="icon">üáµüáπ</div>
                    <div class="title">PORTUGU√äS</div>
                    <div class="subtitle">Portuguese</div>
                </div>
                <div class="selection-card" data-lang="nl" onclick="switchLanguage('nl')" data-name="Dutch">
                    <div class="icon">üá≥üá±</div>
                    <div class="title">NEDERLANDS</div>
                    <div class="subtitle">Dutch</div>
                </div>
                <div class="selection-card" data-lang="pl" onclick="switchLanguage('pl')" data-name="Polish">
                    <div class="icon">üáµüá±</div>
                    <div class="title">POLSKI</div>
                    <div class="subtitle">Polish</div>
                </div>
                <div class="selection-card" data-lang="ru" onclick="switchLanguage('ru')" data-name="Russian">
                    <div class="icon">üá∑üá∫</div>
                    <div class="title">–†–£–°–°–ö–ò–ô</div>
                    <div class="subtitle">Russian</div>
                </div>
                <div class="selection-card" data-lang="ja" onclick="switchLanguage('ja')" data-name="Japanese">
                    <div class="icon">üáØüáµ</div>
                    <div class="title">Êó•Êú¨Ë™û</div>
                    <div class="subtitle">Japanese</div>
                </div>
                <div class="selection-card" data-lang="zh" onclick="switchLanguage('zh')" data-name="Chinese">
                    <div class="icon">üá®üá≥</div>
                    <div class="title">‰∏≠Êñá</div>
                    <div class="subtitle">Chinese</div>
                </div>

                <!-- Additional 26 languages (voice support only) -->
                <div class="selection-card" data-lang="ar" onclick="switchLanguage('ar')" data-name="Arabic">
                    <div class="icon">üá∏üá¶</div>
                    <div class="title">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</div>
                    <div class="subtitle">Arabic</div>
                </div>
                <div class="selection-card" data-lang="cs" onclick="switchLanguage('cs')" data-name="Czech">
                    <div class="icon">üá®üáø</div>
                    <div class="title">ƒåE≈†TINA</div>
                    <div class="subtitle">Czech</div>
                </div>
                <div class="selection-card" data-lang="da" onclick="switchLanguage('da')" data-name="Danish">
                    <div class="icon">üá©üá∞</div>
                    <div class="title">DANSK</div>
                    <div class="subtitle">Danish</div>
                </div>
                <div class="selection-card" data-lang="el" onclick="switchLanguage('el')" data-name="Greek">
                    <div class="icon">üá¨üá∑</div>
                    <div class="title">ŒïŒõŒõŒóŒùŒôŒöŒÜ</div>
                    <div class="subtitle">Greek</div>
                </div>
                <div class="selection-card" data-lang="fi" onclick="switchLanguage('fi')" data-name="Finnish">
                    <div class="icon">üá´üáÆ</div>
                    <div class="title">SUOMI</div>
                    <div class="subtitle">Finnish</div>
                </div>
                <div class="selection-card" data-lang="he" onclick="switchLanguage('he')" data-name="Hebrew">
                    <div class="icon">üáÆüá±</div>
                    <div class="title">◊¢◊ë◊®◊ô◊™</div>
                    <div class="subtitle">Hebrew</div>
                </div>
                <div class="selection-card" data-lang="hi" onclick="switchLanguage('hi')" data-name="Hindi">
                    <div class="icon">üáÆüá≥</div>
                    <div class="title">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</div>
                    <div class="subtitle">Hindi</div>
                </div>
                <div class="selection-card" data-lang="hu" onclick="switchLanguage('hu')" data-name="Hungarian">
                    <div class="icon">üá≠üá∫</div>
                    <div class="title">MAGYAR</div>
                    <div class="subtitle">Hungarian</div>
                </div>
                <div class="selection-card" data-lang="id" onclick="switchLanguage('id')" data-name="Indonesian">
                    <div class="icon">üáÆüá©</div>
                    <div class="title">BAHASA</div>
                    <div class="subtitle">Indonesian</div>
                </div>
                <div class="selection-card" data-lang="ko" onclick="switchLanguage('ko')" data-name="Korean">
                    <div class="icon">üá∞üá∑</div>
                    <div class="title">ÌïúÍµ≠Ïñ¥</div>
                    <div class="subtitle">Korean</div>
                </div>
                <div class="selection-card" data-lang="ms" onclick="switchLanguage('ms')" data-name="Malay">
                    <div class="icon">üá≤üáæ</div>
                    <div class="title">BAHASA MELAYU</div>
                    <div class="subtitle">Malay</div>
                </div>
                <div class="selection-card" data-lang="no" onclick="switchLanguage('no')" data-name="Norwegian">
                    <div class="icon">üá≥üá¥</div>
                    <div class="title">NORSK</div>
                    <div class="subtitle">Norwegian</div>
                </div>
                <div class="selection-card" data-lang="ro" onclick="switchLanguage('ro')" data-name="Romanian">
                    <div class="icon">üá∑üá¥</div>
                    <div class="title">ROM√ÇNƒÇ</div>
                    <div class="subtitle">Romanian</div>
                </div>
                <div class="selection-card" data-lang="sk" onclick="switchLanguage('sk')" data-name="Slovak">
                    <div class="icon">üá∏üá∞</div>
                    <div class="title">SLOVENƒåINA</div>
                    <div class="subtitle">Slovak</div>
                </div>
                <div class="selection-card" data-lang="sv" onclick="switchLanguage('sv')" data-name="Swedish">
                    <div class="icon">üá∏üá™</div>
                    <div class="title">SVENSKA</div>
                    <div class="subtitle">Swedish</div>
                </div>
                <div class="selection-card" data-lang="th" onclick="switchLanguage('th')" data-name="Thai">
                    <div class="icon">üáπüá≠</div>
                    <div class="title">‡πÑ‡∏ó‡∏¢</div>
                    <div class="subtitle">Thai</div>
                </div>
                <div class="selection-card" data-lang="tr" onclick="switchLanguage('tr')" data-name="Turkish">
                    <div class="icon">üáπüá∑</div>
                    <div class="title">T√úRK√áE</div>
                    <div class="subtitle">Turkish</div>
                </div>
                <div class="selection-card" data-lang="uk" onclick="switchLanguage('uk')" data-name="Ukrainian">
                    <div class="icon">üá∫üá¶</div>
                    <div class="title">–£–ö–†–ê–á–ù–°–¨–ö–ê</div>
                    <div class="subtitle">Ukrainian</div>
                </div>
                <div class="selection-card" data-lang="vi" onclick="switchLanguage('vi')" data-name="Vietnamese">
                    <div class="icon">üáªüá≥</div>
                    <div class="title">TI·∫æNG VI·ªÜT</div>
                    <div class="subtitle">Vietnamese</div>
                </div>
                <div class="selection-card" data-lang="ca" onclick="switchLanguage('ca')" data-name="Catalan">
                    <div class="icon">üá™üá∏</div>
                    <div class="title">CATAL√Ä</div>
                    <div class="subtitle">Catalan</div>
                </div>
                <div class="selection-card" data-lang="hr" onclick="switchLanguage('hr')" data-name="Croatian">
                    <div class="icon">üá≠üá∑</div>
                    <div class="title">HRVATSKI</div>
                    <div class="subtitle">Croatian</div>
                </div>
                <div class="selection-card" data-lang="en-AU" onclick="switchLanguage('en-AU')" data-name="English (Australia)">
                    <div class="icon">üá¶üá∫</div>
                    <div class="title">ENGLISH (AU)</div>
                    <div class="subtitle">Australian</div>
                </div>
                <div class="selection-card" data-lang="en-IN" onclick="switchLanguage('en-IN')" data-name="English (India)">
                    <div class="icon">üáÆüá≥</div>
                    <div class="title">ENGLISH (IN)</div>
                    <div class="subtitle">Indian</div>
                </div>
                <div class="selection-card" data-lang="en-IE" onclick="switchLanguage('en-IE')" data-name="English (Ireland)">
                    <div class="icon">üáÆüá™</div>
                    <div class="title">ENGLISH (IE)</div>
                    <div class="subtitle">Irish</div>
                </div>
                <div class="selection-card" data-lang="en-ZA" onclick="switchLanguage('en-ZA')" data-name="English (South Africa)">
                    <div class="icon">üáøüá¶</div>
                    <div class="title">ENGLISH (ZA)</div>
                    <div class="subtitle">South African</div>
                </div>
                <div class="selection-card" data-lang="pt-BR" onclick="switchLanguage('pt-BR')" data-name="Portuguese (Brazil)">
                    <div class="icon">üáßüá∑</div>
                    <div class="title">PORTUGU√äS (BR)</div>
                    <div class="subtitle">Brazilian</div>
                </div>
            </div>
                    <div class="subtitle">Global</div>
                </div>
                <div class="selection-card" data-lang="es" onclick="switchLanguage('es')" data-name="Spanish">
                    <div class="icon">üá™üá∏</div>
                    <div class="title">ESPA√ëOL</div>
                    <div class="subtitle">Spanish</div>
                </div>
                <div class="selection-card" data-lang="fr" onclick="switchLanguage('fr')" data-name="French">
                    <div class="icon">üá´üá∑</div>
                    <div class="title">FRAN√áAIS</div>
                    <div class="subtitle">French</div>
                </div>
                <div class="selection-card" data-lang="de" onclick="switchLanguage('de')" data-name="German">
                    <div class="icon">üá©üá™</div>
                    <div class="title">DEUTSCH</div>
                    <div class="subtitle">German</div>
                </div>
                <div class="selection-card" data-lang="it" onclick="switchLanguage('it')" data-name="Italian">
                    <div class="icon">üáÆüáπ</div>
                    <div class="title">ITALIANO</div>
                    <div class="subtitle">Italian</div>
                </div>
                <div class="selection-card" data-lang="pt" onclick="switchLanguage('pt')" data-name="Portuguese">
                    <div class="icon">üáµüáπ</div>
                    <div class="title">PORTUGU√äS</div>
                    <div class="subtitle">Portuguese</div>
                </div>
                <div class="selection-card" data-lang="nl" onclick="switchLanguage('nl')" data-name="Dutch">
                    <div class="icon">üá≥üá±</div>
                    <div class="title">NEDERLANDS</div>
                    <div class="subtitle">Dutch</div>
                </div>
                <div class="selection-card" data-lang="pl" onclick="switchLanguage('pl')" data-name="Polish">
                    <div class="icon">üáµüá±</div>
                    <div class="title">POLSKI</div>
                    <div class="subtitle">Polish</div>
                </div>
                <div class="selection-card" data-lang="ru" onclick="switchLanguage('ru')" data-name="Russian">
                    <div class="icon">üá∑üá∫</div>
                    <div class="title">–†–£–°–°–ö–ò–ô</div>
                    <div class="subtitle">Russian</div>
                </div>
                <div class="selection-card" data-lang="ja" onclick="switchLanguage('ja')" data-name="Japanese">
                    <div class="icon">üáØüáµ</div>
                    <div class="title">Êó•Êú¨Ë™û</div>
                    <div class="subtitle">Japanese</div>
                </div>
                <div class="selection-card" data-lang="zh" onclick="switchLanguage('zh')" data-name="Chinese">
                    <div class="icon">üá®üá≥</div>
                    <div class="title">‰∏≠Êñá</div>
                    <div class="subtitle">Chinese</div>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" id="nextPhase1" disabled><span data-i18n="btn.continue">CONTINUE</span></button>
            </div>
        </div>

        <!-- Phase 2: iOS Voice Selection -->
        <div class="phase" id="phase2">
            <div class="phoenix-avatar">
                <div class="avatar-circle" id="avatarCircle2"></div>
            </div>
            <div class="voice-status" id="voiceStatus2">[ VOICE ACTIVE ]</div>
            <div class="phase-header">
                <h1 class="phase-title" data-i18n="phase.voice">SELECT VOICE</h1>
                <p class="phase-subtitle" data-i18n="phase.voice.subtitle">CHOOSE YOUR PREFERRED VOICE</p>
            </div>
            <div id="iosVoiceLoading" style="text-align: center; padding: 40px;">
                <div class="loading-spinner"></div>
                <p data-i18n="voice.loading">Loading available voices...</p>
            </div>
            <div class="selection-grid" id="iosVoiceGrid" style="display: none;">
                <!-- iOS voices will be populated by JavaScript based on selected language -->
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="previousPhase()"><span data-i18n="btn.back">BACK</span></button>
                <button class="btn btn-primary" id="nextPhase2" disabled><span data-i18n="btn.continue">CONTINUE</span></button>
            </div>
        </div>
        <!-- Phase 3: Personality Selection (NEW) -->
        <div class="phase" id="phase3persona">
            <div class="phoenix-avatar">
                <div class="avatar-circle" id="avatarCircle3persona"></div>
            </div>
            <div class="voice-status" id="voiceStatus3persona">[ VOICE ACTIVE ]</div>
            <div class="phase-header">
                <h1 class="phase-title" data-i18n="phase.persona">SELECT PERSONALITY</h1>
                <p class="phase-subtitle" data-i18n="phase.persona.subtitle">CHOOSE YOUR AI PERSONALITY</p>
            </div>
            <div class="selection-grid" id="personaGrid">
                <div class="selection-card" data-persona="friendly_helpful" onclick="selectPersona('friendly_helpful')">
                    <div class="icon">üòä</div>
                    <div class="title" data-i18n="persona.friendly">FRIENDLY HELPER</div>
                    <div class="subtitle">Warm and supportive</div>
                    <button class="voice-preview-btn" onclick="testVoicePersona('friendly_helpful', event)">‚ñ∂ TEST</button>
                </div>
                <div class="selection-card" data-persona="professional_serious" onclick="selectPersona('professional_serious')">
                    <div class="icon">üíº</div>
                    <div class="title" data-i18n="persona.professional">PROFESSIONAL</div>
                    <div class="subtitle">Direct and efficient</div>
                    <button class="voice-preview-btn" onclick="testVoicePersona('professional_serious', event)">‚ñ∂ TEST</button>
                </div>
                <div class="selection-card" data-persona="british_refined" onclick="selectPersona('british_refined')">
                    <div class="icon">üé©</div>
                    <div class="title" data-i18n="persona.british">BRITISH BUTLER</div>
                    <div class="subtitle">Refined and courteous</div>
                    <button class="voice-preview-btn" onclick="testVoicePersona('british_refined', event)">‚ñ∂ TEST</button>
                </div>
                <div class="selection-card" data-persona="whimsical_storyteller" onclick="selectPersona('whimsical_storyteller')">
                    <div class="icon">üìö</div>
                    <div class="title" data-i18n="persona.storyteller">STORYTELLER</div>
                    <div class="subtitle">Creative and imaginative</div>
                    <button class="voice-preview-btn" onclick="testVoicePersona('whimsical_storyteller', event)">‚ñ∂ TEST</button>
                </div>
                <div class="selection-card" data-persona="gentle_nurturing" onclick="selectPersona('gentle_nurturing')">
                    <div class="icon">üå∏</div>
                    <div class="title" data-i18n="persona.nurturing">GENTLE GUIDE</div>
                    <div class="subtitle">Caring and patient</div>
                    <button class="voice-preview-btn" onclick="testVoicePersona('gentle_nurturing', event)">‚ñ∂ TEST</button>
                </div>
                <div class="selection-card" data-persona="neutral_efficient" onclick="selectPersona('neutral_efficient')">
                    <div class="icon">‚ö°</div>
                    <div class="title" data-i18n="persona.efficient">EFFICIENT</div>
                    <div class="subtitle">Neutral and balanced</div>
                    <button class="voice-preview-btn" onclick="testVoicePersona('neutral_efficient', event)">‚ñ∂ TEST</button>
                </div>
                <div class="selection-card" data-persona="motivational_coach" onclick="selectPersona('motivational_coach')">
                    <div class="icon">üî•</div>
                    <div class="title" data-i18n="persona.coach">COACH</div>
                    <div class="subtitle">Energetic motivator</div>
                    <button class="voice-preview-btn" onclick="testVoicePersona('motivational_coach', event)">‚ñ∂ TEST</button>
                </div>
                <div class="selection-card" data-persona="zen_master" onclick="selectPersona('zen_master')">
                    <div class="icon">üßò</div>
                    <div class="title" data-i18n="persona.zen">ZEN MASTER</div>
                    <div class="subtitle">Calm and mindful</div>
                    <button class="voice-preview-btn" onclick="testVoicePersona('zen_master', event)">‚ñ∂ TEST</button>
                </div>
                <div class="selection-card" data-persona="tech_genius" onclick="selectPersona('tech_genius')">
                    <div class="icon">ü§ñ</div>
                    <div class="title" data-i18n="persona.tech">TECH GENIUS</div>
                    <div class="subtitle">Smart and analytical</div>
                    <button class="voice-preview-btn" onclick="testVoicePersona('tech_genius', event)">‚ñ∂ TEST</button>
                </div>
                <div class="selection-card" data-persona="comedian" onclick="selectPersona('comedian')">
                    <div class="icon">üé≠</div>
                    <div class="title" data-i18n="persona.comedian">COMEDIAN</div>
                    <div class="subtitle">Witty and fun</div>
                    <button class="voice-preview-btn" onclick="testVoicePersona('comedian', event)">‚ñ∂ TEST</button>
                </div>
                <div class="selection-card" data-persona="therapist" onclick="selectPersona('therapist')">
                    <div class="icon">üí≠</div>
                    <div class="title" data-i18n="persona.therapist">THERAPIST</div>
                    <div class="subtitle">Understanding listener</div>
                    <button class="voice-preview-btn" onclick="testVoicePersona('therapist', event)">‚ñ∂ TEST</button>
                </div>
                <div class="selection-card" data-persona="commander" onclick="selectPersona('commander')">
                    <div class="icon">‚öîÔ∏è</div>
                    <div class="title" data-i18n="persona.commander">COMMANDER</div>
                    <div class="subtitle">Decisive leader</div>
                    <button class="voice-preview-btn" onclick="testVoicePersona('commander', event)">‚ñ∂ TEST</button>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="previousPhase()"><span data-i18n="btn.back">BACK</span></button>
                <button class="btn btn-primary" id="nextPhase3persona" disabled><span data-i18n="btn.continue">CONTINUE</span></button>
            </div>
        </div>

        <!-- Phase 4: Account Creation -->
        <div class="phase" id="phase4">
            <div class="phoenix-avatar">
                <div class="avatar-circle" id="avatarCircle4"></div>
            </div>
            <div class="voice-status" id="voiceStatus4">[ VOICE ACTIVE ]</div>
            <div class="phase-header">
                <h1 class="phase-title" data-i18n="phase.auth">CREATE ACCOUNT</h1>
                <p class="phase-subtitle" data-i18n="phase.auth.subtitle">REGISTER YOUR CREDENTIALS</p>
            </div>
            <form id="accountForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>FULL NAME</label>
                        <input type="text" id="name" placeholder="John Doe" required>
                    </div>
                    <div class="form-group">
                        <label>EMAIL</label>
                        <input type="email" id="email" placeholder="your@email.com" required>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>PHONE NUMBER</label>
                        <div class="phone-input-wrapper">
                            <select id="countryCode" class="country-selector">
                                <option value="+1" data-country="US">üá∫üá∏ +1</option>
                                <option value="+44" data-country="GB">üá¨üáß +44</option>
                                <option value="+91" data-country="IN">üáÆüá≥ +91</option>
                                <option value="+86" data-country="CN">üá®üá≥ +86</option>
                                <option value="+81" data-country="JP">üáØüáµ +81</option>
                                <option value="+49" data-country="DE">üá©üá™ +49</option>
                                <option value="+33" data-country="FR">üá´üá∑ +33</option>
                                <option value="+61" data-country="AU">üá¶üá∫ +61</option>
                                <option value="+39" data-country="IT">üáÆüáπ +39</option>
                                <option value="+34" data-country="ES">üá™üá∏ +34</option>
                                <option value="+7" data-country="RU">üá∑üá∫ +7</option>
                                <option value="+55" data-country="BR">üáßüá∑ +55</option>
                                <option value="+52" data-country="MX">üá≤üáΩ +52</option>
                                <option value="+82" data-country="KR">üá∞üá∑ +82</option>
                                <option value="+31" data-country="NL">üá≥üá± +31</option>
                            </select>
                            <input type="tel" id="phone" placeholder="(555) 123-4567" required>
                        </div>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>PASSWORD</label>
                        <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label>CONFIRM PASSWORD</label>
                        <input type="password" id="confirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
                    </div>
                </div>
            </form>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="previousPhase()"><span data-i18n="btn.back">BACK</span></button>
                <button class="btn btn-primary" onclick="createAccount()">[ CREATE ACCOUNT ]</button>
            </div>
        </div>

        <!-- Phase 5: Verification Choice -->
        <div class="phase" id="phase5">
            <div class="phoenix-avatar">
                <div class="avatar-circle" id="avatarCircle5"></div>
            </div>
            <div class="voice-status" id="voiceStatus5">[ CHOOSE VERIFICATION METHOD ]</div>
            <div class="phase-header">
                <h1 class="phase-title" data-i18n="phase.verify">VERIFY YOUR ACCOUNT</h1>
                <p class="phase-subtitle">CHOOSE HOW YOU'D LIKE TO VERIFY</p>
            </div>
            <div class="button-group" style="display: flex; flex-direction: column; gap: 20px; max-width: 400px; margin: 40px auto;">
                <button class="btn btn-primary" onclick="verifyViaPhone()" style="padding: 20px; font-size: 16px;">
                    üì± VERIFY WITH PHONE<br>
                    <span style="font-size: 12px; opacity: 0.7;">Receive SMS verification code</span>
                </button>
                <button class="btn btn-secondary" onclick="verifyViaEmail()" style="padding: 20px; font-size: 16px;">
                    üìß VERIFY WITH EMAIL<br>
                    <span style="font-size: 12px; opacity: 0.7;">Instant verification (for now)</span>
                </button>
            </div>
        </div>

        <!-- Phase 4b: Phone Verification (shown if user chooses phone) -->
        <div class="phase" id="phase5b" style="display: none;">
            <div class="phoenix-avatar">
                <div class="avatar-circle" id="avatarCircle4b"></div>
            </div>
            <div class="voice-status" id="voiceStatus4b">[ VERIFICATION SENT ]</div>
            <div class="phase-header">
                <h1 class="phase-title" data-i18n="phase.verify">VERIFY PHONE</h1>
                <p class="phase-subtitle">ENTER 6-DIGIT CODE SENT TO <span id="userPhone" style="color: var(--primary-cyan);"></span></p>
            </div>
            <div class="code-input-wrapper">
                <input type="text" class="code-digit" maxlength="1" id="code1">
                <input type="text" class="code-digit" maxlength="1" id="code2">
                <input type="text" class="code-digit" maxlength="1" id="code3">
                <input type="text" class="code-digit" maxlength="1" id="code4">
                <input type="text" class="code-digit" maxlength="1" id="code5">
                <input type="text" class="code-digit" maxlength="1" id="code6">
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-skip" onclick="resendCode()">[ RESEND CODE ]</button>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="verifyPhone()">[ VERIFY PHONE ]</button>
                <button class="btn btn-secondary" onclick="backToVerificationChoice()">[ GO BACK ]</button>
            </div>
        </div>

        <!-- Phase 6: Device Connections -->
        <div class="phase" id="phase6">
            <div class="phoenix-avatar">
                <div class="avatar-circle" id="avatarCircle6"></div>
            </div>
            <div class="voice-status" id="voiceStatus6">[ VOICE ACTIVE ]</div>
            <div class="phase-header">
                <h1 class="phase-title" data-i18n="phase.sync">SYNC DEVICES</h1>
                <p class="phase-subtitle">CONNECT WEARABLES FOR HEALTH TRACKING</p>
            </div>
            <div class="selection-grid">
                <div class="device-card" data-device="fitbit">
                    <div class="icon">‚åö</div>
                    <div class="title">FITBIT</div>
                    <div class="device-status">NOT CONNECTED</div>
                </div>
                <div class="device-card" data-device="polar">
                    <div class="icon">‚ù§Ô∏è</div>
                    <div class="title">POLAR</div>
                    <div class="device-status">NOT CONNECTED</div>
                </div>
                <div class="device-card disabled">
                    <div class="icon">üçé</div>
                    <div class="title">APPLE HEALTH</div>
                    <div class="device-status">COMING SOON</div>
                </div>
                <div class="device-card disabled">
                    <div class="icon">üí™</div>
                    <div class="title">WHOOP</div>
                    <div class="device-status">COMING SOON</div>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="previousPhase()"><span data-i18n="btn.back">BACK</span></button>
                <button class="btn btn-primary" onclick="nextPhase()"><span data-i18n="btn.continue">CONTINUE</span></button>
                <button class="btn btn-skip" onclick="nextPhase()"><span data-i18n="btn.skip">SKIP</span></button>
            </div>
        </div>

        <!-- Phase 7: Goals Setup (Open Text) -->
        <div class="phase" id="phase7">
            <div class="phoenix-avatar">
                <div class="avatar-circle" id="avatarCircle7"></div>
            </div>
            <div class="voice-status" id="voiceStatus7">[ VOICE ACTIVE ]</div>
            <div class="phase-header">
                <h1 class="phase-title" data-i18n="phase.goals">SET OBJECTIVES</h1>
                <p class="phase-subtitle" data-i18n="phase.goals.subtitle">TELL ME YOUR GOALS IN YOUR OWN WORDS</p>
            </div>
            <div class="goals-container" style="max-width: 700px; margin: 0 auto; padding: 20px;">
                <textarea
                    id="openGoalsText"
                    data-i18n-placeholder="goals.placeholder"
                    placeholder="Tell me what you want to achieve... (e.g., 'I want to lose 10kg, run a marathon, improve my sleep, and build a meditation habit')"
                    rows="8"
                    style="
                        width: 100%;
                        padding: 20px;
                        font-size: 16px;
                        font-family: 'Courier New', monospace;
                        background: rgba(0, 0, 0, 0.3);
                        border: 2px solid var(--primary-cyan);
                        color: var(--primary-cyan);
                        border-radius: 8px;
                        resize: vertical;
                        min-height: 200px;
                        line-height: 1.6;
                    "
                ></textarea>
                <div class="goals-ai-note" style="margin-top: 15px; text-align: center; opacity: 0.7; font-size: 14px;">
                    <p data-i18n="goals.ai_note">‚ú® Phoenix AI will analyze and structure your goals automatically</p>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="previousPhase()"><span data-i18n="btn.back">BACK</span></button>
                <button class="btn btn-primary" onclick="saveOpenGoals()"><span data-i18n="btn.continue">CONTINUE</span></button>
                <button class="btn btn-skip" onclick="nextPhase()"><span data-i18n="btn.skip">SKIP</span></button>
            </div>
        </div>

        <!-- Phase 8: Complete -->
        <div class="phase" id="phase8">
            <div class="phoenix-avatar">
                <div class="avatar-circle" id="avatarCircle8"></div>
            </div>
            <div class="voice-status" id="voiceStatus8">[ SYSTEM READY ]</div>
            <div class="phase-header">
                <h1 class="phase-title" data-i18n="phase.launch">INITIALIZATION COMPLETE</h1>
                <p class="phase-subtitle">WELCOME TO PHOENIX, <span id="welcomeName" style="color: var(--primary-cyan);"></span></p>
            </div>
            <div class="intro-text">
                <p>YOUR ACCOUNT IS ACTIVE.</p>
                <p>LET ME SHOW YOU AROUND YOUR NEW COMMAND CENTER.</p>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="launchApp()" style="font-size: 14px; padding: 18px 48px;">
                    [ LAUNCH PHOENIX ]
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
        /**
         * PHOENIX ONBOARDING - REAL API INTEGRATION
         * 
         * This version uses the actual backend API endpoints:
         * - POST /api/auth/register - Create account
         * - POST /api/sms-verification/send-verification - Send SMS code
         * - POST /api/sms-verification/verify-code - Verify phone
         * - POST /api/sms-verification/resend-code - Resend verification
         * - POST /api/tts/generate - Text-to-speech
         * - POST /api/mercury/devices/:provider/connect - Device integration
         * - POST /api/mars/goals - Goal creation
         * 
         * Backend: https://pal-backend-production.up.railway.app
         * Frontend: https://phoenix-fe-kappa.vercel.app
         */
        
        // Configuration
        const API_BASE_URL = 'https://pal-backend-production.up.railway.app/api';
        const API_URL = 'https://pal-backend-production.up.railway.app';
        
        // API Helper Functions
        const api = {
            authToken: null,
            
            setAuthToken(token) {
                this.authToken = token;
                localStorage.setItem('phoenixToken', token);
            },
            
            async request(endpoint, options = {}) {
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                if (this.authToken) {
                    headers['Authorization'] = `Bearer ${this.authToken}`;
                }
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    ...options,
                    headers
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
                
                return data;
            },
            
            auth: {
                async register(userData) {
                    return await api.request('/auth/register', {
                        method: 'POST',
                        body: JSON.stringify(userData)
                    });
                },
                
                async verify(data) {
                    return await api.request('/sms-verification/verify-code', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                },
                
                async resendVerification(data) {
                    return await api.request('/sms-verification/resend-code', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                }
            },
            
            mercury: {
                devices: {
                    async connect(provider) {
                        const response = await api.request(`/mercury/devices/${provider}/connect`, {
                            method: 'POST'
                        });
                        return response.connectUrl || response.url;
                    }
                }
            },
            
            mars: {
                goals: {
                    async create(goalData) {
                        return await api.request('/mars/goals', {
                            method: 'POST',
                            body: JSON.stringify(goalData)
                        });
                    }
                }
            }
        };
        
        // State
        let currentPhase = 0;
        let userData = {
            language: 'en',
            languageName: 'English',
            voice: 'echo',
            profile: {},
            authToken: null,
            devices: [],
            goals: {}
        };
        
        // Audio context for playing TTS
        let currentAudio = null;
        let isPlaying = false;
        
        // Language code mapper for TTS API
        const languageMap = {
            'en': 'en-GB',
            'es': 'es',
            'fr': 'fr',
            'de': 'de',
            'it': 'it',
            'pt': 'pt',
            'nl': 'nl',
            'pl': 'pl',
            'ru': 'ru',
            'ja': 'ja',
            'zh': 'zh'
        };

        // Auto-detect user's system language
        function autoDetectLanguage() {
            // Check if already set in localStorage
            const savedLang = localStorage.getItem('phoenixLanguage');
            if (savedLang) {
                console.log('üåç Using saved language:', savedLang);
                return savedLang;
            }

            // Detect from browser/system
            const browserLang = navigator.language || navigator.userLanguage;
            console.log('üåç Detected browser language:', browserLang);

            // Map to our supported languages
            const langMap = {
                'en': 'en', 'en-US': 'en', 'en-GB': 'en', 'en-AU': 'en-AU', 'en-IN': 'en-IN', 'en-IE': 'en-IE', 'en-ZA': 'en-ZA',
                'es': 'es', 'es-ES': 'es', 'es-MX': 'es',
                'fr': 'fr', 'fr-FR': 'fr', 'fr-CA': 'fr',
                'de': 'de', 'de-DE': 'de', 'de-AT': 'de', 'de-CH': 'de',
                'it': 'it', 'it-IT': 'it',
                'pt': 'pt', 'pt-PT': 'pt', 'pt-BR': 'pt-BR',
                'nl': 'nl', 'nl-NL': 'nl',
                'pl': 'pl', 'pl-PL': 'pl',
                'ru': 'ru', 'ru-RU': 'ru',
                'ja': 'ja', 'ja-JP': 'ja',
                'zh': 'zh', 'zh-CN': 'zh', 'zh-TW': 'zh',
                'ar': 'ar', 'ar-SA': 'ar',
                'cs': 'cs', 'cs-CZ': 'cs',
                'da': 'da', 'da-DK': 'da',
                'el': 'el', 'el-GR': 'el',
                'fi': 'fi', 'fi-FI': 'fi',
                'he': 'he', 'he-IL': 'he',
                'hi': 'hi', 'hi-IN': 'hi',
                'hu': 'hu', 'hu-HU': 'hu',
                'id': 'id', 'id-ID': 'id',
                'ko': 'ko', 'ko-KR': 'ko',
                'ms': 'ms', 'ms-MY': 'ms',
                'no': 'no', 'nb-NO': 'no', 'nn-NO': 'no',
                'ro': 'ro', 'ro-RO': 'ro',
                'sk': 'sk', 'sk-SK': 'sk',
                'sv': 'sv', 'sv-SE': 'sv',
                'th': 'th', 'th-TH': 'th',
                'tr': 'tr', 'tr-TR': 'tr',
                'uk': 'uk', 'uk-UA': 'uk',
                'vi': 'vi', 'vi-VN': 'vi',
                'ca': 'ca', 'ca-ES': 'ca',
                'hr': 'hr', 'hr-HR': 'hr'
            };

            const detectedLang = langMap[browserLang] || langMap[browserLang.split('-')[0]] || 'en';
            console.log('‚úÖ Auto-detected language:', detectedLang);

            // Save and apply
            localStorage.setItem('phoenixLanguage', detectedLang);
            return detectedLang;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Auto-detect and set language FIRST
            const detectedLang = autoDetectLanguage();
            if (window.PhoenixI18n) {
                PhoenixI18n.setLanguage(detectedLang);
            }

            setupLanguageSelection();
            setupVoiceSelection();
            setupDeviceCards();
            setupCodeInputs();

            // Preload language welcome messages for instant response
            preloadLanguageWelcomes();

            // Check for OAuth callback (from fitbit.html or other device callbacks)
            const urlParams = new URLSearchParams(window.location.search);
            const device = urlParams.get('device');
            const status = urlParams.get('status');

            if (device && status) {
                // Restore userData from localStorage if it exists
                const savedData = localStorage.getItem('phoenixOnboardingData');
                if (savedData) {
                    try {
                        const restored = JSON.parse(savedData);
                        Object.assign(userData, restored);
                        console.log('[Onboarding] Restored user data after OAuth');
                    } catch (e) {
                        console.error('[Onboarding] Failed to restore data:', e);
                    }
                }

                if (status === 'connected') {
                    showToast(`${device.toUpperCase()} CONNECTED SUCCESSFULLY`, 'success');

                    // Mark device card as connected
                    const deviceCard = document.querySelector(`.device-card[data-device="${device}"]`);
                    if (deviceCard) {
                        deviceCard.classList.add('connected');
                        const statusEl = deviceCard.querySelector('.device-status');
                        if (statusEl) {
                            statusEl.textContent = 'CONNECTED';
                        }
                    }

                    // Navigate to Phase 5 (SYNC) to show the connected device
                    goToPhase(5);

                } else if (status === 'error') {
                    showToast(`${device.toUpperCase()} CONNECTION FAILED`, 'error');
                    goToPhase(5); // Still go to device sync phase
                }

                // Clean URL (remove query parameters)
                window.history.replaceState({}, '', '/onboarding.html');
            }

            // Enable audio on first user interaction (required by browsers)
            document.body.addEventListener('click', () => {
                if (!currentAudio) {
                    console.log('[Audio] User interaction detected, audio enabled');
                }
            }, { once: true });
        });

        /**
         * Phoenix speaks using OpenAI TTS API
         */
        async function phoenixSpeak(text, phaseNum = currentPhase) {
            // Stop any current audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            isPlaying = true;

            // Show speaking animation
            const avatar = document.getElementById(`avatarCircle${phaseNum}`);
            const status = document.getElementById(`voiceStatus${phaseNum}`);
            if (avatar) avatar.classList.add('speaking');
            if (status) {
                status.classList.add('speaking');
                status.textContent = '[ PHOENIX SPEAKING ]';
            }

            // Speed settings per voice (1.0 = normal)
            const voiceSpeeds = {
                'nova': 1.0,  // Nova at normal speed
                'echo': 1.0,
                'onyx': 1.0,
                'shimmer': 1.0,
                'alloy': 1.0,
                'fable': 1.0
            };

            try {
                console.log('[TTS] Requesting:', text.substring(0, 50) + '...');

                const selectedVoice = userData.voice || 'nova';
                const cacheKey = `welcome_${userData.language}_${text}`;
                let audioUrl;

                // Check cache first for instant playback
                if (audioCache.has(cacheKey)) {
                    console.log('[TTS] Using cached audio - instant playback!');
                    audioUrl = audioCache.get(cacheKey);
                } else {
                    console.log('[TTS] Cache miss - fetching from API');

                    // Call backend TTS API
                    const response = await fetch(`${API_URL}/api/tts/generate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            text: text,
                            voice: selectedVoice,
                            language: languageMap[userData.language] || 'en-GB',
                            speed: voiceSpeeds[selectedVoice] || 1.0
                        })
                    });

                    console.log('[TTS] Response status:', response.status);
                    console.log('[TTS] Content-Type:', response.headers.get('content-type'));

                    if (!response.ok) {
                        throw new Error(`TTS failed: ${response.status}`);
                    }

                    // Backend returns audio/mpeg buffer directly
                    const audioBlob = await response.blob();
                    console.log('[TTS] Audio blob size:', audioBlob.size, 'bytes');

                    audioUrl = URL.createObjectURL(audioBlob);

                    // Cache for future use
                    audioCache.set(cacheKey, audioUrl);
                }

                console.log('[TTS] Audio URL ready');

                // Play audio
                currentAudio = new Audio(audioUrl);
                
                currentAudio.onloadeddata = () => {
                    console.log('[TTS] Audio loaded, duration:', currentAudio.duration);
                };
                
                currentAudio.onerror = (e) => {
                    console.error('[TTS] Audio playback error:', e);
                    if (avatar) avatar.classList.remove('speaking');
                    if (status) {
                        status.classList.remove('speaking');
                        status.textContent = '[ VOICE STANDBY ]';
                    }
                    isPlaying = false;
                };
                
                currentAudio.onended = () => {
                    console.log('[TTS] Audio finished playing');
                    if (avatar) avatar.classList.remove('speaking');
                    if (status) {
                        status.classList.remove('speaking');
                        status.textContent = '[ VOICE STANDBY ]';
                    }
                    // Don't revoke cached URLs
                    if (!audioCache.has(cacheKey)) {
                        URL.revokeObjectURL(audioUrl);
                    }
                    isPlaying = false;
                };

                // Start playback
                const playPromise = currentAudio.play();
                
                if (playPromise !== undefined) {
                    playPromise
                        .then(() => {
                            console.log('[TTS] Playback started successfully');
                        })
                        .catch(error => {
                            console.error('[TTS] Playback error:', error);
                            // Browsers require user interaction for audio
                            // This is expected on first load
                            if (avatar) avatar.classList.remove('speaking');
                            if (status) {
                                status.classList.remove('speaking');
                                status.textContent = '[ VOICE STANDBY ]';
                            }
                            isPlaying = false;
                        });
                }

            } catch (error) {
                console.error('[TTS] Error:', error);
                // Silent fail - voice is optional
                if (avatar) avatar.classList.remove('speaking');
                if (status) {
                    status.classList.remove('speaking');
                    status.textContent = '[ VOICE STANDBY ]';
                }
                isPlaying = false;
            }
        }


        /**
         * Start onboarding
         */
        function startOnboarding() {
            // Just move to next phase - no speech on phase 0 since we transition immediately
            nextPhase();
        }

        /**
         * Language Selection
         */
        function setupLanguageSelection() {
            const welcomeMessages = {
                'en': 'English selected. Excellent choice.',
                'es': 'Espa√±ol seleccionado. Excelente elecci√≥n.',
                'fr': 'Fran√ßais s√©lectionn√©. Excellent choix.',
                'de': 'Deutsch ausgew√§hlt. Ausgezeichnete Wahl.',
                'it': 'Italiano selezionato. Ottima scelta.',
                'pt': 'Portugu√™s selecionado. Excelente escolha.',
                'nl': 'Nederlands geselecteerd. Uitstekende keuze.',
                'pl': 'Polski wybrany. Doskona≈Çy wyb√≥r.',
                'ru': '–†—É—Å—Å–∫–∏–π –≤—ã–±—Ä–∞–Ω. –û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä.',
                'ja': 'Êó•Êú¨Ë™û„ÅåÈÅ∏Êäû„Åï„Çå„Åæ„Åó„Åü„ÄÇÁ¥†Êô¥„Çâ„Åó„ÅÑÈÅ∏Êäû„Åß„Åô„ÄÇ',
                'zh': 'Â∑≤ÈÄâÊã©‰∏≠Êñá„ÄÇÂæàÂ•ΩÁöÑÈÄâÊã©„ÄÇ'
            };

            const nextMessages = {
                'en': "Now, let's choose my voice. Listen to each option and select your favourite.",
                'es': 'Ahora, elijamos mi voz. Escucha cada opci√≥n y selecciona tu favorita.',
                'fr': 'Maintenant, choisissons ma voix. √âcoutez chaque option et s√©lectionnez votre pr√©f√©r√©e.',
                'de': 'Jetzt w√§hlen wir meine Stimme. H√∂ren Sie sich jede Option an und w√§hlen Sie Ihre Lieblingsstimme.',
                'it': 'Ora scegliamo la mia voce. Ascolta ogni opzione e seleziona la tua preferita.',
                'pt': 'Agora vamos escolher a minha voz. Ou√ßa cada op√ß√£o e selecione a sua favorita.',
                'nl': 'Laten we nu mijn stem kiezen. Luister naar elke optie en selecteer je favoriet.',
                'pl': 'Teraz wybierzmy m√≥j g≈Ços. Pos≈Çuchaj ka≈ºdej opcji i wybierz swojƒÖ ulubionƒÖ.',
                'ru': '–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–µ–º –º–æ–π –≥–æ–ª–æ—Å. –ü–æ—Å–ª—É—à–∞–π—Ç–µ –∫–∞–∂–¥—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π –ª—é–±–∏–º—ã–π.',
                'ja': 'Ê¨°„Å´ÁßÅ„ÅÆÂ£∞„ÇíÈÅ∏„Å≥„Åæ„Åó„Çá„ÅÜ„ÄÇÂêÑ„Ç™„Éó„Ç∑„Éß„É≥„ÇíËÅû„ÅÑ„Å¶„ÄÅ„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                'zh': 'Áé∞Âú®ËÆ©Êàë‰ª¨ÈÄâÊã©ÊàëÁöÑÂ£∞Èü≥„ÄÇÂê¨Âê¨ÊØè‰∏™ÈÄâÈ°πÂπ∂ÈÄâÊã©‰Ω†ÊúÄÂñúÊ¨¢ÁöÑ„ÄÇ'
            };

            document.querySelectorAll('#languageGrid .selection-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('#languageGrid .selection-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    userData.language = card.dataset.lang;
                    userData.languageName = card.dataset.name;
                    document.getElementById('nextPhase1').disabled = false;
                    
                    phoenixSpeak(welcomeMessages[userData.language] || welcomeMessages['en'], 1);
                });
            });
            
            document.getElementById('nextPhase1').addEventListener('click', () => {
                // Proceed to next phase immediately, speech is optional
                nextPhase();
                // Try to speak but don't block the transition
                phoenixSpeak(nextMessages[userData.language] || nextMessages['en'], 1).catch(err => {
                    console.log('Speech optional, continuing:', err);
                });
            });
        }

        /**
         * Voice Selection
         */
        function setupVoiceSelection() {
            const continueMessages = {
                'en': "Perfect. From now on, this is how I'll sound. Now let's create your account.",
                'es': 'Perfecto. De ahora en adelante, as√≠ es como sonar√©. Ahora creemos tu cuenta.',
                'fr': "Parfait. √Ä partir de maintenant, c'est ainsi que je sonnerai. Cr√©ons maintenant votre compte.",
                'de': 'Perfekt. Von nun an werde ich so klingen. Lassen Sie uns nun Ihr Konto erstellen.',
                'it': 'Perfetto. D\'ora in poi, suoner√≤ cos√¨. Ora creiamo il tuo account.',
                'pt': 'Perfeito. De agora em diante, √© assim que vou soar. Agora vamos criar sua conta.',
                'nl': 'Perfect. Vanaf nu klink ik zo. Laten we nu je account aanmaken.',
                'pl': 'Doskonale. Od teraz tak bƒôdƒô brzmieƒá. Teraz utw√≥rzmy twoje konto.',
                'ru': '–û—Ç–ª–∏—á–Ω–æ. –û—Ç–Ω—ã–Ω–µ —è –±—É–¥—É –∑–≤—É—á–∞—Ç—å —Ç–∞–∫. –¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –≤–∞—à—É —É—á–µ—Ç–Ω—É—é –∑–∞–ø–∏—Å—å.',
                'ja': 'ÂÆåÁíß„Åß„Åô„ÄÇ‰ªäÂæå„ÅØ„Åì„ÅÆ„Çà„ÅÜ„Å´ËÅû„Åì„Åà„Åæ„Åô„ÄÇ„Åù„Çå„Åß„ÅØ„ÄÅ„Ç¢„Ç´„Ç¶„É≥„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                'zh': 'ÂÆåÁæé„ÄÇ‰ªéÁé∞Âú®ÂºÄÂßãÔºåÊàë‰ºöËøôÊ†∑ËØ¥ËØù„ÄÇÁé∞Âú®ËÆ©Êàë‰ª¨ÂàõÂª∫ÊÇ®ÁöÑÂ∏êÊà∑„ÄÇ'
            };

            document.querySelectorAll('#voiceGrid .selection-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('#voiceGrid .selection-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    userData.voice = card.dataset.voice;
                    document.getElementById('nextPhase2').disabled = false;
                });
            });
            
            document.getElementById('nextPhase2').addEventListener('click', () => {
                // Proceed to next phase immediately, speech is optional
                nextPhase();
                // Try to speak but don't block the transition
                phoenixSpeak(continueMessages[userData.language] || continueMessages['en'], 2).catch(err => {
                    console.log('Speech optional, continuing:', err);
                });
            });
        }

        /**
         * Audio cache for voice previews (prevents re-downloading)
         */
        const audioCache = new Map();

        /**
         * Preload language welcome messages for instant response
         */
        async function preloadLanguageWelcomes() {
            const welcomeMessages = {
                'en': 'English selected. Excellent choice. Now I will guide you through the setup.',
                'es': 'Espa√±ol seleccionado. Excelente elecci√≥n. Ahora te guiar√© a trav√©s de la configuraci√≥n.',
                'fr': 'Fran√ßais s√©lectionn√©. Excellent choix. Maintenant je vais vous guider √† travers la configuration.',
                'de': 'Deutsch ausgew√§hlt. Ausgezeichnete Wahl. Jetzt werde ich Sie durch die Einrichtung f√ºhren.',
                'it': 'Italiano selezionato. Ottima scelta. Ora ti guider√≤ attraverso la configurazione.',
                'pt': 'Portugu√™s selecionado. Excelente escolha. Agora vou gui√°-lo atrav√©s da configura√ß√£o.',
                'nl': 'Nederlands geselecteerd. Uitstekende keuze. Nu zal ik je door de installatie leiden.',
                'pl': 'Polski wybrany. Doskona≈Çy wyb√≥r. Teraz poprowadzƒô ciƒô przez konfiguracjƒô.',
                'ru': '–†—É—Å—Å–∫–∏–π –≤—ã–±—Ä–∞–Ω. –û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä. –¢–µ–ø–µ—Ä—å —è –ø—Ä–æ–≤–µ–¥—É –≤–∞—Å —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫—É.',
                'ja': 'Êó•Êú¨Ë™û„ÅåÈÅ∏Êäû„Åï„Çå„Åæ„Åó„Åü„ÄÇÁ¥†Êô¥„Çâ„Åó„ÅÑÈÅ∏Êäû„Åß„Åô„ÄÇ‰ªä„ÄÅ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Çí„ÅîÊ°àÂÜÖ„Åó„Åæ„Åô„ÄÇ',
                'zh': 'ÈÄâÊã©‰∫Ü‰∏≠Êñá„ÄÇÂæàÂ•ΩÁöÑÈÄâÊã©„ÄÇÁé∞Âú®ÊàëÂ∞ÜÊåáÂØºÊÇ®ÂÆåÊàêËÆæÁΩÆ„ÄÇ'
            };

            const languageMap = {
                'en': 'en-GB',
                'es': 'es',
                'fr': 'fr',
                'de': 'de',
                'it': 'it',
                'pt': 'pt',
                'nl': 'nl',
                'pl': 'pl',
                'ru': 'ru',
                'ja': 'ja',
                'zh': 'zh'
            };

            console.log('[Preload] Starting language welcome preload for', Object.keys(welcomeMessages).length, 'languages');

            // Preload each language (fire and forget)
            for (const [lang, text] of Object.entries(welcomeMessages)) {
                const cacheKey = `welcome_${lang}_${text}`;

                // Skip if already cached
                if (audioCache.has(cacheKey)) {
                    continue;
                }

                // Preload in background (don't await)
                fetch(`${API_URL}/api/tts/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        voice: 'nova',
                        language: languageMap[lang] || 'en-GB',
                        speed: 1.0
                    })
                })
                .then(response => response.blob())
                .then(audioBlob => {
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioCache.set(cacheKey, audioUrl);
                    console.log('[Preload] Cached welcome for', lang);
                })
                .catch(error => {
                    console.warn('[Preload] Failed to cache welcome for', lang, ':', error.message);
                    // Silent fail - will generate on demand
                });
            }
        }

        /**
         * Preload all voice previews in background for instant playback
         */
        async function preloadVoicePreviews() {
            const voices = ['nova', 'echo', 'onyx', 'shimmer', 'alloy', 'fable'];
            const language = userData.language || 'en';

            console.log('[Preload] Starting background preload for', voices.length, 'voices');

            const samples = {
                'en': {
                    'nova': "Hello. I'm Nova, your friendly helper.",
                    'echo': "Good day. I'm Echo, your butler.",
                    'onyx': "Hello. I'm Onyx, professional assistant.",
                    'shimmer': "Hi there. I'm Shimmer, your gentle guide.",
                    'alloy': "Hello. I'm Alloy, your balanced assistant.",
                    'fable': "Greetings. I'm Fable, your storytelling companion."
                },
                'es': {
                    'nova': "Hola. Soy Nova, tu asistente amigable.",
                    'echo': "Buenos d√≠as. Soy Echo, tu mayordomo.",
                    'onyx': "Hola. Soy Onyx, asistente profesional.",
                    'shimmer': "Hola. Soy Shimmer, tu gu√≠a gentil.",
                    'alloy': "Hola. Soy Alloy, tu asistente equilibrado.",
                    'fable': "Saludos. Soy Fable, tu compa√±ero de historias."
                }
                // Add other languages as needed
            };

            const langSamples = samples[language] || samples['en'];
            const voiceSpeeds = {
                'nova': 1.0,
                'echo': 1.0,
                'onyx': 1.0,
                'shimmer': 1.0,
                'alloy': 1.0,
                'fable': 1.0
            };

            // Preload each voice (fire and forget)
            for (const voice of voices) {
                const cacheKey = `${voice}_${language}_${langSamples[voice]}`;

                // Skip if already cached
                if (audioCache.has(cacheKey)) {
                    continue;
                }

                // Preload in background (don't await)
                fetch(`${API_URL}/api/tts/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: langSamples[voice],
                        voice: voice,
                        language: languageMap[language] || 'en-GB',
                        speed: voiceSpeeds[voice] || 1.0
                    })
                })
                .then(response => response.blob())
                .then(audioBlob => {
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioCache.set(cacheKey, audioUrl);
                    console.log('[Preload] Cached', voice);
                })
                .catch(error => {
                    console.warn('[Preload] Failed to cache', voice, ':', error.message);
                    // Silent fail - will retry on user click
                });
            }
        }

        /**
         * Preview voice with retry logic and caching
         */
        async function previewVoice(voice, event) {
            event.stopPropagation();
            event.preventDefault();

            // Prevent double-clicks
            if (isPlaying) {
                console.log('[Preview] Already playing, ignoring click');
                return;
            }

            const samples = {
                'en': {
                    'nova': "Hello. I'm Nova, your friendly helper.",
                    'echo': "Good day. I'm Echo, your butler.",
                    'onyx': "Hello. I'm Onyx, professional assistant.",
                    'shimmer': "Hi there. I'm Shimmer, your gentle guide.",
                    'alloy': "Hello. I'm Alloy, your balanced assistant.",
                    'fable': "Greetings. I'm Fable, your storytelling companion."
                },
                'es': {
                    'nova': "Hola. Soy Nova, tu asistente amigable.",
                    'echo': "Buenos d√≠as. Soy Echo, tu mayordomo.",
                    'onyx': "Hola. Soy Onyx, asistente profesional.",
                    'shimmer': "Hola. Soy Shimmer, tu gu√≠a gentil.",
                    'alloy': "Hola. Soy Alloy, tu asistente equilibrado.",
                    'fable': "Saludos. Soy Fable, tu compa√±ero narrador."
                },
                'fr': {
                    'nova': "Bonjour. Je suis Nova, votre assistante amicale.",
                    'echo': "Bonjour. Je suis Echo, votre majordome.",
                    'onyx': "Bonjour. Je suis Onyx, assistant professionnel.",
                    'shimmer': "Bonjour. Je suis Shimmer, votre guide douce.",
                    'alloy': "Bonjour. Je suis Alloy, votre assistant √©quilibr√©.",
                    'fable': "Salutations. Je suis Fable, votre compagnon conteur."
                },
                'de': {
                    'nova': "Hallo. Ich bin Nova, deine freundliche Helferin.",
                    'echo': "Guten Tag. Ich bin Echo, dein Butler.",
                    'onyx': "Hallo. Ich bin Onyx, professioneller Assistent.",
                    'shimmer': "Hallo. Ich bin Shimmer, dein sanfter F√ºhrer.",
                    'alloy': "Hallo. Ich bin Alloy, dein ausgewogener Assistent.",
                    'fable': "Gr√º√üe. Ich bin Fable, dein Geschichtenerz√§hler."
                },
                'it': {
                    'nova': "Ciao. Sono Nova, il tuo assistente amichevole.",
                    'echo': "Buongiorno. Sono Echo, il tuo maggiordomo.",
                    'onyx': "Ciao. Sono Onyx, assistente professionale.",
                    'shimmer': "Ciao. Sono Shimmer, la tua guida gentile.",
                    'alloy': "Ciao. Sono Alloy, il tuo assistente equilibrato.",
                    'fable': "Saluti. Sono Fable, il tuo compagno narratore."
                },
                'pt': {
                    'nova': "Ol√°. Sou a Nova, sua assistente amig√°vel.",
                    'echo': "Bom dia. Sou o Echo, seu mordomo.",
                    'onyx': "Ol√°. Sou o Onyx, assistente profissional.",
                    'shimmer': "Ol√°. Sou a Shimmer, sua guia gentil.",
                    'alloy': "Ol√°. Sou o Alloy, seu assistente equilibrado.",
                    'fable': "Sauda√ß√µes. Sou o Fable, seu companheiro contador de hist√≥rias."
                },
                'nl': {
                    'nova': "Hallo. Ik ben Nova, je vriendelijke helper.",
                    'echo': "Goedendag. Ik ben Echo, je butler.",
                    'onyx': "Hallo. Ik ben Onyx, professionele assistent.",
                    'shimmer': "Hallo. Ik ben Shimmer, je zachte gids.",
                    'alloy': "Hallo. Ik ben Alloy, je evenwichtige assistent.",
                    'fable': "Groeten. Ik ben Fable, je verhalende metgezel."
                },
                'pl': {
                    'nova': "Cze≈õƒá. Jestem Nova, twoim przyjaznym pomocnikiem.",
                    'echo': "Dzie≈Ñ dobry. Jestem Echo, twoim kamerdynerem.",
                    'onyx': "Cze≈õƒá. Jestem Onyx, profesjonalnym asystentem.",
                    'shimmer': "Cze≈õƒá. Jestem Shimmer, twoim ≈Çagodnym przewodnikiem.",
                    'alloy': "Cze≈õƒá. Jestem Alloy, twoim zr√≥wnowa≈ºonym asystentem.",
                    'fable': "Pozdrowienia. Jestem Fable, twoim towarzyszem opowie≈õci."
                },
                'ru': {
                    'nova': "–ü—Ä–∏–≤–µ—Ç. –Ø –ù–æ–≤–∞, —Ç–≤–æ–π –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫.",
                    'echo': "–î–æ–±—Ä—ã–π –¥–µ–Ω—å. –Ø –≠—Ö–æ, —Ç–≤–æ–π –¥–≤–æ—Ä–µ—Ü–∫–∏–π.",
                    'onyx': "–ü—Ä–∏–≤–µ—Ç. –Ø –û–Ω–∏–∫—Å, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.",
                    'shimmer': "–ü—Ä–∏–≤–µ—Ç. –Ø –®–∏–º–º–µ—Ä, —Ç–≤–æ–π –º—è–≥–∫–∏–π –≥–∏–¥.",
                    'alloy': "–ü—Ä–∏–≤–µ—Ç. –Ø –≠–ª–ª–æ–π, —Ç–≤–æ–π —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.",
                    'fable': "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é. –Ø –§—ç–π–±–ª, —Ç–≤–æ–π —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫."
                },
                'ja': {
                    'nova': "„Åì„Çì„Å´„Å°„ÅØ„ÄÇÁßÅ„ÅØNova„ÄÅ„ÅÇ„Å™„Åü„ÅÆË¶™„Åó„Åø„ÇÑ„Åô„ÅÑ„Éò„É´„Éë„Éº„Åß„Åô„ÄÇ",
                    'echo': "„Åì„Çì„Å´„Å°„ÅØ„ÄÇÁßÅ„ÅØEcho„ÄÅ„ÅÇ„Å™„Åü„ÅÆÂü∑‰∫ã„Åß„Åô„ÄÇ",
                    'onyx': "„Åì„Çì„Å´„Å°„ÅØ„ÄÇÁßÅ„ÅØOnyx„ÄÅ„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Å™„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇ",
                    'shimmer': "„Åì„Çì„Å´„Å°„ÅØ„ÄÇÁßÅ„ÅØShimmer„ÄÅ„ÅÇ„Å™„Åü„ÅÆÂÑ™„Åó„ÅÑ„Ç¨„Ç§„Éâ„Åß„Åô„ÄÇ",
                    'alloy': "„Åì„Çì„Å´„Å°„ÅØ„ÄÇÁßÅ„ÅØAlloy„ÄÅ„ÅÇ„Å™„Åü„ÅÆ„Éê„É©„É≥„Çπ„ÅÆÂèñ„Çå„Åü„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇ",
                    'fable': "„ÅîÊå®Êã∂Áî≥„Åó‰∏ä„Åí„Åæ„Åô„ÄÇÁßÅ„ÅØFable„ÄÅ„ÅÇ„Å™„Åü„ÅÆÁâ©Ë™û„ÅÆ‰ª≤Èñì„Åß„Åô„ÄÇ"
                },
                'zh': {
                    'nova': "‰Ω†Â•Ω„ÄÇÊàëÊòØNovaÔºå‰Ω†ÂèãÂ•ΩÁöÑÂä©Êâã„ÄÇ",
                    'echo': "ÊÇ®Â•Ω„ÄÇÊàëÊòØEchoÔºåÊÇ®ÁöÑÁÆ°ÂÆ∂„ÄÇ",
                    'onyx': "‰Ω†Â•Ω„ÄÇÊàëÊòØOnyxÔºå‰∏ì‰∏öÂä©ÁêÜ„ÄÇ",
                    'shimmer': "‰Ω†Â•Ω„ÄÇÊàëÊòØShimmerÔºå‰Ω†Ê∏©ÊüîÁöÑÂêëÂØº„ÄÇ",
                    'alloy': "‰Ω†Â•Ω„ÄÇÊàëÊòØAlloyÔºå‰Ω†Âπ≥Ë°°ÁöÑÂä©Êâã„ÄÇ",
                    'fable': "ÈóÆÂÄô„ÄÇÊàëÊòØFableÔºå‰Ω†ÁöÑËÆ≤ÊïÖ‰∫ã‰ºô‰º¥„ÄÇ"
                }
            };
            
            const langSamples = samples[userData.language] || samples['en'];

            // Stop current audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            isPlaying = true;

            // Speed settings per voice (1.0 = normal)
            const voiceSpeeds = {
                'nova': 1.0,  // Nova at normal speed
                'echo': 1.0,
                'onyx': 1.0,
                'shimmer': 1.0,
                'alloy': 1.0,
                'fable': 1.0
            };

            // Create cache key
            const cacheKey = `${voice}_${userData.language}_${langSamples[voice]}`;

            try {
                let audioUrl;

                // Check cache first
                if (audioCache.has(cacheKey)) {
                    console.log('[Preview] Using cached audio for', voice);
                    audioUrl = audioCache.get(cacheKey);
                } else {
                    // Fetch with retry logic (3 attempts)
                    let lastError;
                    let attempt = 0;
                    const maxAttempts = 3;

                    while (attempt < maxAttempts) {
                        attempt++;
                        console.log(`[Preview] Attempt ${attempt}/${maxAttempts} for ${voice}`);

                        try {
                            // Create abort controller for timeout
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout

                            const response = await fetch(`${API_URL}/api/tts/generate`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    text: langSamples[voice],
                                    voice: voice,
                                    language: languageMap[userData.language] || 'en-GB',
                                    speed: voiceSpeeds[voice] || 1.0
                                }),
                                signal: controller.signal
                            });

                            clearTimeout(timeoutId);

                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }

                            const audioBlob = await response.blob();
                            audioUrl = URL.createObjectURL(audioBlob);

                            // Cache the audio URL
                            audioCache.set(cacheKey, audioUrl);
                            console.log('[Preview] Audio cached for', voice);

                            // Success - break retry loop
                            break;

                        } catch (error) {
                            lastError = error;
                            console.warn(`[Preview] Attempt ${attempt} failed:`, error.message);

                            // Wait before retry (exponential backoff: 500ms, 1s, 2s)
                            if (attempt < maxAttempts) {
                                await new Promise(resolve => setTimeout(resolve, 500 * Math.pow(2, attempt - 1)));
                            }
                        }
                    }

                    // If all retries failed
                    if (!audioUrl) {
                        throw lastError || new Error('All retry attempts failed');
                    }
                }

                // Play audio
                currentAudio = new Audio(audioUrl);

                currentAudio.onended = () => {
                    currentAudio = null;
                    isPlaying = false;
                    console.log('[Preview] Playback completed');
                };

                currentAudio.onerror = (e) => {
                    console.error('[Preview] Audio playback error:', e);
                    currentAudio = null;
                    isPlaying = false;
                    // Don't show error toast for playback issues - silent fail
                };

                await currentAudio.play();
                console.log('[Preview] Playing', voice);

            } catch (error) {
                console.error('[Preview] Failed after all retries:', error);
                isPlaying = false;

                // Show user-friendly error (not a scary technical message)
                showToast('LOADING VOICE... TRY AGAIN', 'error');
            }
        }

        /**
         * Create Account
         */
        async function createAccount() {
            const form = document.getElementById('accountForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                showToast('PASSWORDS DO NOT MATCH', 'error');
                return;
            }

            // Combine country code and phone number
            const countryCode = document.getElementById('countryCode').value;
            const phoneNumber = document.getElementById('phone').value;
            const fullPhone = countryCode + phoneNumber;
            const email = document.getElementById('email').value;

            userData.profile = {
                name: document.getElementById('name').value,
                email: email,
                phone: fullPhone,
                password: password
            };

            showLoading(true);

            try {
                console.log('[Registration] Submitting:', {
                    name: userData.profile.name,
                    email: userData.profile.email,
                    phone: userData.profile.phone,
                    language: userData.language,
                    voice: userData.voice
                });

                const response = await api.auth.register({
                    name: userData.profile.name,
                    email: userData.profile.email,
                    phone: userData.profile.phone,
                    password: userData.profile.password,
                    language: userData.language,
                    voice: userData.voice
                });

                // Extract token from response (handle different response structures)
                const token = response.token || response.data?.token;
                if (token) {
                    userData.authToken = token;
                    api.setAuthToken(token);
                    localStorage.setItem('phoenixToken', token);
                }
                
                // Send verification code - REQUIRED
                try {
                    const smsResponse = await fetch(`${API_BASE_URL}/sms-verification/send-verification`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? `Bearer ${token}` : ''
                        },
                        body: JSON.stringify({
                            phone: userData.profile.phone
                        })
                    });
                    
                    if (!smsResponse.ok) {
                        const errorData = await smsResponse.json().catch(() => ({}));
                        throw new Error(errorData.error || 'Failed to send verification code');
                    }
                    
                    console.log('[SMS] Verification code sent successfully');
                } catch (verifyError) {
                    console.error('[SMS] CRITICAL: Verification send failed:', verifyError.message);
                    throw verifyError; // Re-throw to stop registration flow
                }

                showLoading(false);
                showToast('ACCOUNT CREATED SUCCESSFULLY', 'success');
                
                const verificationMessages = {
                    'en': `Great. I just sent a verification code to ${userData.profile.phone}. Can you enter it for me?`,
                    'es': `Excelente. Acabo de enviar un c√≥digo de verificaci√≥n a ${userData.profile.phone}. ¬øPuedes ingresarlo por m√≠?`,
                    'fr': `Parfait. Je viens d'envoyer un code de v√©rification au ${userData.profile.phone}. Pouvez-vous le saisir pour moi?`,
                    'de': `Gro√üartig. Ich habe gerade einen Best√§tigungscode an ${userData.profile.phone} gesendet. K√∂nnen Sie ihn f√ºr mich eingeben?`,
                    'it': `Ottimo. Ho appena inviato un codice di verifica a ${userData.profile.phone}. Puoi inserirlo per me?`,
                    'pt': `√ìtimo. Acabei de enviar um c√≥digo de verifica√ß√£o para ${userData.profile.phone}. Pode digit√°-lo para mim?`,
                    'nl': `Geweldig. Ik heb zojuist een verificatiecode naar ${userData.profile.phone} gestuurd. Kun je die voor me invoeren?`,
                    'pl': `≈öwietnie. W≈Ça≈õnie wys≈Ça≈Çem kod weryfikacyjny na ${userData.profile.phone}. Czy mo≈ºesz go dla mnie wprowadziƒá?`,
                    'ru': `–û—Ç–ª–∏—á–Ω–æ. –Ø —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞ ${userData.profile.phone}. –ú–æ–∂–µ—Ç–µ –≤–≤–µ—Å—Ç–∏ –µ–≥–æ –¥–ª—è –º–µ–Ω—è?`,
                    'ja': `Á¥†Êô¥„Çâ„Åó„ÅÑ„ÄÇ${userData.profile.phone}„Å´Á¢∫Ë™ç„Ç≥„Éº„Éâ„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇÂÖ•Âäõ„Åó„Å¶„ÅÑ„Åü„Å†„Åë„Åæ„Åô„ÅãÔºü`,
                    'zh': `Â§™Â•Ω‰∫Ü„ÄÇÊàëÂàöÂàöÂêë${userData.profile.phone}ÂèëÈÄÅ‰∫ÜÈ™åËØÅÁ†Å„ÄÇÊÇ®ËÉΩ‰∏∫ÊàëËæìÂÖ•ÂêóÔºü`
                };
                
                // Proceed to next phase immediately, speech is optional
                nextPhase();

                // Try to speak but don't block the transition
                phoenixSpeak(verificationMessages[userData.language] || verificationMessages['en'], 3).catch(err => {
                    console.log('Speech optional, continuing:', err);
                });

            } catch (error) {
                showLoading(false);
                console.error('[Registration] Error:', error);
                const errorMessage = error.message || 'Account creation failed';
                showToast(errorMessage.toUpperCase(), 'error');
            }
        }

        /**
         * Setup code inputs
         */
        function setupCodeInputs() {
            const inputs = document.querySelectorAll('.code-digit');
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                });
            });
        }

        /**
         * Verification Choice Functions
         */
        async function verifyViaEmail() {
            showLoading(true);
            try {
                // Call skip verification endpoint (marks email as verified)
                const response = await api.request('/auth/skip-verification', {
                    method: 'POST'
                });

                if (response.success) {
                    userData.emailVerified = true;
                    showLoading(false);
                    showToast('EMAIL VERIFIED', 'success');
                    console.log('[Verification] Email verified successfully');
                    // Proceed to next phase
                    nextPhase();
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                showLoading(false);
                console.error('[Verification] Email verification error:', error);
                showToast('VERIFICATION FAILED', 'error');
            }
        }

        async function verifyViaPhone() {
            // Show phone verification phase
            document.getElementById('phase4').classList.remove('active');
            document.getElementById('phase4b').classList.add('active');

            // Phone number already sent SMS during registration, so just show the code entry
            const phone = userData.profile.phone;
            if (phone) {
                document.getElementById('userPhone').textContent = phone;
            }
        }

        function backToVerificationChoice() {
            document.getElementById('phase4b').classList.remove('active');
            document.getElementById('phase4').classList.add('active');
        }

        /**
         * Verify Phone (SMS Code)
         */
        async function verifyPhone() {
            const code = Array.from(document.querySelectorAll('.code-digit'))
                .map(input => input.value)
                .join('');

            if (code.length !== 6) {
                showToast('ENTER ALL 6 DIGITS', 'error');
                return;
            }

            showLoading(true);

            try {
                const response = await api.auth.verify({
                    phone: userData.profile.phone,
                    code: code
                });

                showLoading(false);
                showToast('PHONE VERIFIED', 'success');

                // Mark phone as verified in userData
                userData.phoneVerified = true;
                console.log('[Verification] Phone verified successfully');

                const verifiedMessages = {
                    'en': "Verified. Now, would you like to connect any wearable devices? This helps me track your health data and provide better insights.",
                    'es': 'Verificado. Ahora, ¬øte gustar√≠a conectar alg√∫n dispositivo port√°til? Esto me ayuda a rastrear tus datos de salud y proporcionar mejores conocimientos.',
                    'fr': 'V√©rifi√©. Maintenant, souhaitez-vous connecter des appareils portables? Cela m\'aide √† suivre vos donn√©es de sant√© et √† fournir de meilleures informations.',
                    'de': 'Verifiziert. M√∂chten Sie jetzt tragbare Ger√§te verbinden? Dies hilft mir, Ihre Gesundheitsdaten zu verfolgen und bessere Einblicke zu geben.',
                    'it': 'Verificato. Ora, vorresti connettere dispositivi indossabili? Questo mi aiuta a monitorare i tuoi dati sulla salute e fornire informazioni migliori.',
                    'pt': 'Verificado. Agora, gostaria de conectar dispositivos vest√≠veis? Isso me ajuda a rastrear seus dados de sa√∫de e fornecer melhores insights.',
                    'nl': 'Geverifieerd. Wil je nu draagbare apparaten verbinden? Dit helpt me je gezondheidsgegevens bij te houden en betere inzichten te geven.',
                    'pl': 'Zweryfikowane. Czy chcesz teraz po≈ÇƒÖczyƒá urzƒÖdzenia do noszenia? Pomaga mi to ≈õledziƒá twoje dane zdrowotne i dostarczaƒá lepsze spostrze≈ºenia.',
                    'ru': '–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ. –¢–µ–ø–µ—Ä—å —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –Ω–æ—Å–∏–º—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞? –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –º–Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –æ –∑–¥–æ—Ä–æ–≤—å–µ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –ª—É—á—à—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.',
                    'ja': 'Á¢∫Ë™çÊ∏à„Åø„ÄÇ„Ç¶„Çß„Ç¢„É©„Éñ„É´„Éá„Éê„Ç§„Çπ„ÇíÊé•Á∂ö„Åó„Åæ„Åô„ÅãÔºü„Åì„Çå„Å´„Çà„Çä„ÄÅÂÅ•Â∫∑„Éá„Éº„Çø„ÇíËøΩË∑°„Åó„ÄÅ„Çà„ÇäËâØ„ÅÑÊ¥ûÂØü„ÇíÊèê‰æõ„Åß„Åç„Åæ„Åô„ÄÇ',
                    'zh': 'Â∑≤È™åËØÅ„ÄÇÁé∞Âú®ÊÇ®ÊÉ≥ËøûÊé•ÂèØÁ©øÊà¥ËÆæÂ§áÂêóÔºüËøôÂèØ‰ª•Â∏ÆÂä©ÊàëËøΩË∏™ÊÇ®ÁöÑÂÅ•Â∫∑Êï∞ÊçÆÂπ∂Êèê‰æõÊõ¥Â•ΩÁöÑËßÅËß£„ÄÇ'
                };

                // Proceed to next phase immediately, speech is optional
                nextPhase();

                // Try to speak but don't block the transition
                phoenixSpeak(verifiedMessages[userData.language] || verifiedMessages['en'], 4).catch(err => {
                    console.log('Speech optional, continuing:', err);
                });

            } catch (error) {
                showLoading(false);
                console.error('[Verification] Error:', error);
                showToast('VERIFICATION FAILED - CHECK CODE', 'error');
            }
        }

        /**
         * Resend Code
         */
        async function resendCode() {
            const resendMessages = {
                'en': "I sent a new code to your phone.",
                'es': 'Envi√© un nuevo c√≥digo a tu tel√©fono.',
                'fr': 'J\'ai envoy√© un nouveau code √† votre t√©l√©phone.',
                'de': 'Ich habe einen neuen Code an Ihr Telefon gesendet.',
                'it': 'Ho inviato un nuovo codice al tuo telefono.',
                'pt': 'Enviei um novo c√≥digo para o seu telefone.',
                'nl': 'Ik heb een nieuwe code naar je telefoon gestuurd.',
                'pl': 'Wys≈Ça≈Çem nowy kod na tw√≥j telefon.',
                'ru': '–Ø –æ—Ç–ø—Ä–∞–≤–∏–ª –Ω–æ–≤—ã–π –∫–æ–¥ –Ω–∞ –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω.',
                'ja': 'Êñ∞„Åó„ÅÑ„Ç≥„Éº„Éâ„ÇíÈõªË©±„Å´ÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ',
                'zh': 'ÊàëÂêëÊÇ®ÁöÑÊâãÊú∫ÂèëÈÄÅ‰∫ÜÊñ∞‰ª£Á†Å„ÄÇ'
            };

            try {
                await api.auth.resendVerification({ phone: userData.profile.phone });
                showToast('CODE RESENT', 'success');
                phoenixSpeak(resendMessages[userData.language] || resendMessages['en'], 4);
            } catch (error) {
                showToast('RESEND FAILED', 'error');
            }
        }

        /**
         * Check Connected Devices
         */
        async function checkConnectedDevices() {
            try {
                const token = localStorage.getItem('phoenixToken');
                if (!token) return;

                console.log('[Devices] Checking connected devices...');

                const response = await api.request('/mercury/devices', {
                    method: 'GET'
                });

                if (response.success && response.devices) {
                    response.devices.forEach(device => {
                        const deviceCard = document.querySelector(`.device-card[data-device="${device.provider}"]`);
                        if (deviceCard) {
                            deviceCard.classList.add('connected');
                            const statusEl = deviceCard.querySelector('.device-status');
                            if (statusEl) {
                                statusEl.textContent = 'CONNECTED';
                            }
                            console.log(`[Devices] ${device.provider} marked as connected`);
                        }
                    });
                }
            } catch (error) {
                console.error('[Devices] Error checking connected devices:', error);
            }
        }

        /**
         * Device Cards Setup
         */
        function setupDeviceCards() {
            // Check for already connected devices
            checkConnectedDevices();

            document.querySelectorAll('.device-card:not(.disabled)').forEach(card => {
                card.addEventListener('click', async () => {
                    const device = card.dataset.device;

                    if (card.classList.contains('connected')) {
                        return;
                    }

                    showLoading(true);

                    try {
                        const response = await api.request(`/mercury/devices/${device}/connect`, {
                            method: 'POST'
                        });

                        // Get the auth URL from response
                        const authUrl = response.authUrl || response.connectUrl || response.url;

                        if (!authUrl) {
                            throw new Error('No authorization URL received');
                        }

                        localStorage.setItem('phoenixOnboardingData', JSON.stringify(userData));
                        window.location.href = authUrl;
                    } catch (error) {
                        showLoading(false);
                        console.error('Device connection error:', error);
                        showToast('CONNECTION FAILED', 'error');
                    }
                });
            });
        }

        /**
         * Save Goals
         */
        async function saveGoals() {
            const primaryGoal = document.getElementById('primaryGoal').value;
            const currentWeight = document.getElementById('currentWeight').value;
            const targetWeight = document.getElementById('targetWeight').value;

            if (primaryGoal && currentWeight && targetWeight) {
                userData.goals = {
                    primary: primaryGoal,
                    currentWeight: parseFloat(currentWeight),
                    targetWeight: parseFloat(targetWeight)
                };

                showLoading(true);

                try {
                    await api.mars.goals.create({
                        title: primaryGoal,
                        type: 'weight',
                        targetValue: targetWeight,
                        currentValue: currentWeight
                    });

                    showLoading(false);
                    
                    const goalMessages = {
                        'en': `Got it. ${primaryGoal} is an excellent goal. I'll help you track your progress.`,
                        'es': `Entendido. ${primaryGoal} es un objetivo excelente. Te ayudar√© a seguir tu progreso.`,
                        'fr': `Compris. ${primaryGoal} est un excellent objectif. Je vous aiderai √† suivre vos progr√®s.`,
                        'de': `Verstanden. ${primaryGoal} ist ein ausgezeichnetes Ziel. Ich helfe Ihnen, Ihren Fortschritt zu verfolgen.`,
                        'it': `Capito. ${primaryGoal} √® un obiettivo eccellente. Ti aiuter√≤ a monitorare i tuoi progressi.`,
                        'pt': `Entendido. ${primaryGoal} √© um objetivo excelente. Vou ajud√°-lo a acompanhar seu progresso.`,
                        'nl': `Begrepen. ${primaryGoal} is een uitstekend doel. Ik zal je helpen je voortgang bij te houden.`,
                        'pl': `Zrozumia≈Çem. ${primaryGoal} to doskona≈Çy cel. Pomogƒô ci ≈õledziƒá twoje postƒôpy.`,
                        'ru': `–ü–æ–Ω—è—Ç–Ω–æ. ${primaryGoal} ‚Äî –æ—Ç–ª–∏—á–Ω–∞—è —Ü–µ–ª—å. –Ø –ø–æ–º–æ–≥—É –≤–∞–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å.`,
                        'ja': `‰∫ÜËß£„Åó„Åæ„Åó„Åü„ÄÇ${primaryGoal}„ÅØÁ¥†Êô¥„Çâ„Åó„ÅÑÁõÆÊ®ô„Åß„Åô„ÄÇÈÄ≤Êçó„ÇíËøΩË∑°„Åô„Çã„ÅäÊâã‰ºù„ÅÑ„Çí„Åó„Åæ„Åô„ÄÇ`,
                        'zh': `ÊòéÁôΩ‰∫Ü„ÄÇ${primaryGoal}ÊòØ‰∏Ä‰∏™ÂæàÂ•ΩÁöÑÁõÆÊ†á„ÄÇÊàë‰ºöÂ∏ÆÂä©ÊÇ®Ë∑üË∏™ËøõÂ∫¶„ÄÇ`
                    };
                    
                    // Try to speak but don't block
                    phoenixSpeak(goalMessages[userData.language] || goalMessages['en'], 6).catch(err => {
                        console.log('Speech optional, continuing:', err);
                    });

                } catch (error) {
                    showLoading(false);
                    console.error('Goal creation error:', error);
                }
            }

            // Proceed to next phase immediately
            nextPhase();
        }

        /**
         * Voice & Personality Selection Functions
         */
        let voiceOnboardingInstance = null;

        async function initVoiceOnboarding() {
            console.log('üé≠ Initializing voice onboarding...');

            if (!voiceOnboardingInstance) {
                voiceOnboardingInstance = new VoiceOnboarding();
                const container = document.getElementById('voice-onboarding-container');
                await voiceOnboardingInstance.render(container);
                console.log('‚úÖ Voice onboarding initialized');
            }
        }

        function saveVoiceAndContinue() {
            if (voiceOnboardingInstance) {
                voiceOnboardingInstance.saveAndContinue();
            }

            // Continue to next phase
            nextPhase();
        }

        function skipVoiceSetup() {
            console.log('‚è≠Ô∏è  Skipping voice setup - using default (Friendly Helper)');

            // Set default voice settings
            const defaultSettings = {
                personality: 'friendly_helpful',
                language: 'en-US',
                voiceName: 'Samantha',
                voiceURI: 'com.apple.ttsbundle.Samantha-compact'
            };
            localStorage.setItem('phoenixVoiceSettings', JSON.stringify(defaultSettings));

            nextPhase();
        }

        /**
         * Launch App
         */
        function launchApp() {
            const welcomeMessages = {
                'en': "Initialization complete. You are now connected to Phoenix. Welcome to a new era of existence.",
                'es': 'Inicializaci√≥n completa. Ahora est√°s conectado a Phoenix. Bienvenido a una nueva era de existencia.',
                'fr': 'Initialisation termin√©e. Vous √™tes maintenant connect√© √† Phoenix. Bienvenue dans une nouvelle √®re d\'existence.',
                'de': 'Initialisierung abgeschlossen. Sie sind jetzt mit Phoenix verbunden. Willkommen in einer neuen √Ñra der Existenz.',
                'it': 'Inizializzazione completa. Ora sei connesso a Phoenix. Benvenuto in una nuova era di esistenza.',
                'pt': 'Inicializa√ß√£o completa. Voc√™ est√° conectado ao Phoenix. Bem-vindo a uma nova era de exist√™ncia.',
                'nl': 'Initialisatie voltooid. Je bent nu verbonden met Phoenix. Welkom in een nieuw tijdperk van bestaan.',
                'pl': 'Inicjalizacja zako≈Ñczona. Jeste≈õ teraz po≈ÇƒÖczony z Phoenix. Witaj w nowej erze istnienia.',
                'ru': '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í—ã —Ç–µ–ø–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ Phoenix. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–æ–≤—É—é —ç—Ä—É —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è.',
                'ja': 'ÂàùÊúüÂåñÂÆå‰∫Ü„ÄÇPhoenix„Å´Êé•Á∂ö„Åï„Çå„Åæ„Åó„Åü„ÄÇÂ≠òÂú®„ÅÆÊñ∞ÊôÇ‰ª£„Å∏„Çà„ÅÜ„Åì„Åù„ÄÇ',
                'zh': 'ÂàùÂßãÂåñÂÆåÊàê„ÄÇÊÇ®Áé∞Âú®Â∑≤ËøûÊé•Âà∞Phoenix„ÄÇÊ¨¢ËøéÊù•Âà∞Â≠òÂú®ÁöÑÊñ∞Êó∂‰ª£„ÄÇ'
            };

            // Redirect immediately
            localStorage.setItem('phoenixOnboardingComplete', 'true');
            localStorage.setItem('phoenixLanguage', userData.language);
            localStorage.setItem('phoenixVoice', userData.voice);

            // Try to speak but don't block the redirect
            phoenixSpeak(welcomeMessages[userData.language] || welcomeMessages['en'], 7).catch(err => {
                console.log('Speech optional, continuing:', err);
            });

            // Small delay for UX, then redirect to dashboard
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1500);
        }

        /**
         * Navigation
         */
        function nextPhase() {
            if (currentPhase < 8) {
                // Handle special phase IDs
                let currentPhaseId = currentPhase === 2 ? 'phase2' :
                                    currentPhase === 3 ? 'phase3persona' :
                                    `phase${currentPhase}`;

                const currentEl = document.getElementById(currentPhaseId);
                if (currentEl) currentEl.classList.remove('active');

                currentPhase++;

                let nextPhaseId = currentPhase === 3 ? 'phase3persona' :
                                 `phase${currentPhase}`;

                const nextEl = document.getElementById(nextPhaseId);
                if (nextEl) nextEl.classList.add('active');

                updateProgress();

                // Load iOS voices when entering Phase 2 (Voice Selection)
                if (currentPhase === 2) {
                    setTimeout(() => {
                        loadIOSVoices();
                    }, 500);
                }

                // Show phone verification screen when reaching Phase 4
                if (currentPhase === 4) {
                    // Automatically show phone verification (no choice, phone is required)
                    setTimeout(() => {
                        verifyViaPhone();
                    }, 500);
                }

                // Initialize voice & personality onboarding when entering Phase 7
                if (currentPhase === 7) {
                    setTimeout(() => {
                        initVoiceOnboarding();
                    }, 300);
                }

                // Set welcome name on final phase
                if (currentPhase === 8 && userData.profile.name) {
                    document.getElementById('welcomeName').textContent = userData.profile.name.split(' ')[0].toUpperCase();
                }
            }
        }

        function previousPhase() {
            // Block going back from Phase 4b (phone verification code entry)
            if (currentPhase === 4 && document.getElementById('phase4b').classList.contains('active')) {
                console.warn('[Onboarding] Cannot go back from phone verification');
                alert('Please verify your phone number to continue. This prevents multiple accounts.');
                return;
            }

            if (currentPhase > 1) {
                let currentPhaseId = currentPhase === 3 ? 'phase3persona' : `phase${currentPhase}`;
                const currentEl = document.getElementById(currentPhaseId);
                if (currentEl) currentEl.classList.remove('active');

                currentPhase--;

                let prevPhaseId = currentPhase === 3 ? 'phase3persona' : `phase${currentPhase}`;
                const prevEl = document.getElementById(prevPhaseId);
                if (prevEl) prevEl.classList.add('active');

                updateProgress();
            }
        }

        function goToPhase(phaseNumber) {
            if (phaseNumber >= 0 && phaseNumber <= 8) {
                document.getElementById(`phase${currentPhase}`).classList.remove('active');
                currentPhase = phaseNumber;
                document.getElementById(`phase${currentPhase}`).classList.add('active');
                updateProgress();

                // Handle special phases
                if (currentPhase === 4 && userData.profile.phone) {
                    document.getElementById('userPhone').textContent = userData.profile.phone;
                }

                if (currentPhase === 7 && userData.profile.name) {
                    document.getElementById('welcomeName').textContent = userData.profile.name.split(' ')[0].toUpperCase();
                }
            }
        }

        function updateProgress() {
            const progress = (currentPhase / 7) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;

            document.querySelectorAll('.progress-step').forEach((step, index) => {
                if (index < currentPhase) {
                    step.classList.add('completed');
                    step.classList.remove('active');
                } else if (index === currentPhase) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                } else {
                    step.classList.remove('active', 'completed');
                }
            });
        }

        /**
         * Loading State
         */
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        /**
         * Toast Notifications
         */
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = `[ ${message} ]`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        /**
         * Constellation Background Animation
         */
        (function initConstellations() {
            const canvas = document.getElementById('constellation-canvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            let stars = [];
            let connections = [];

            // Set canvas size
            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resize();
            window.addEventListener('resize', resize);

            // Create stars
            function createStars() {
                stars = [];
                const starCount = Math.floor((canvas.width * canvas.height) / 8000);

                for (let i = 0; i < starCount; i++) {
                    stars.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        size: Math.random() * 2 + 0.5,
                        vx: (Math.random() - 0.5) * 0.3,
                        vy: (Math.random() - 0.5) * 0.3,
                        alpha: Math.random() * 0.5 + 0.3
                    });
                }
            }
            createStars();

            // Draw stars and connections
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Draw connections first
                ctx.strokeStyle = 'rgba(0, 255, 255, 0.15)';
                ctx.lineWidth = 0.5;

                for (let i = 0; i < stars.length; i++) {
                    for (let j = i + 1; j < stars.length; j++) {
                        const dx = stars[i].x - stars[j].x;
                        const dy = stars[i].y - stars[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance < 150) {
                            const opacity = (1 - distance / 150) * 0.15;
                            ctx.strokeStyle = `rgba(0, 255, 255, ${opacity})`;
                            ctx.beginPath();
                            ctx.moveTo(stars[i].x, stars[i].y);
                            ctx.lineTo(stars[j].x, stars[j].y);
                            ctx.stroke();
                        }
                    }
                }

                // Draw stars
                stars.forEach(star => {
                    ctx.fillStyle = `rgba(0, 255, 255, ${star.alpha})`;
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                    ctx.fill();

                    // Add glow effect
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = 'rgba(0, 255, 255, 0.5)';
                    ctx.fill();
                    ctx.shadowBlur = 0;
                });
            }

            // Update star positions
            function update() {
                stars.forEach(star => {
                    star.x += star.vx;
                    star.y += star.vy;

                    // Wrap around edges
                    if (star.x < 0) star.x = canvas.width;
                    if (star.x > canvas.width) star.x = 0;
                    if (star.y < 0) star.y = canvas.height;
                    if (star.y > canvas.height) star.y = 0;

                    // Twinkle effect
                    star.alpha += (Math.random() - 0.5) * 0.02;
                    star.alpha = Math.max(0.2, Math.min(0.8, star.alpha));
                });
            }

            // Animation loop
            function animate() {
                update();
                draw();
                requestAnimationFrame(animate);
            }
            animate();
        })();
    </script>

    <!-- Voice System Integration (150+ voices, 12 personalities, 37+ languages) -->
    <script src="src/capacitor-platform.js"></script>
    <script src="src/voice-tts.js"></script>
    <script src="src/voice-enumerator.js"></script>
    <script src="src/voice-onboarding.js"></script>
    <script src="src/i18n.js"></script>
    <script>
    // Switch language and update UI instantly
    function switchLanguage(langCode) {
        console.log('üåç Switching language to:', langCode);

        // Update i18n system
        PhoenixI18n.setLanguage(langCode);

        // Remove selected class from all language cards
        document.querySelectorAll('.selection-card').forEach(card => {
            card.classList.remove('selected');
        });

        // Add selected class to clicked language
        const selectedCard = document.querySelector(`[data-lang="${langCode}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }

        // Enable continue button
        const continueBtn = document.getElementById('nextPhase1');
        if (continueBtn) {
            continueBtn.disabled = false;
        }

        console.log('‚úÖ Language switched to', langCode, '- UI updated!');
    }

    </script>
    <script>
        // Initialize i18n on page load
        document.addEventListener('DOMContentLoaded', () => {
            PhoenixI18n.updateAllTranslations();
        });

    // ========================================
    // iOS VOICE SELECTION (Phase 2)
    // ========================================
    async function loadIOSVoices() {
        console.log('üé§ Loading iOS voices for selected language...');

        const selectedLang = localStorage.getItem('phoenixLanguage') || 'en';
        console.log('Selected language:', selectedLang);

        // Map our language codes to iOS voice language codes (37 languages)
        const langMap = {
            'en': 'en-US', 'es': 'es-ES', 'fr': 'fr-FR', 'de': 'de-DE',
            'it': 'it-IT', 'pt': 'pt-PT', 'nl': 'nl-NL', 'pl': 'pl-PL',
            'ru': 'ru-RU', 'ja': 'ja-JP', 'zh': 'zh-CN',
            'ar': 'ar-SA', 'cs': 'cs-CZ', 'da': 'da-DK', 'el': 'el-GR',
            'fi': 'fi-FI', 'he': 'he-IL', 'hi': 'hi-IN', 'hu': 'hu-HU',
            'id': 'id-ID', 'ko': 'ko-KR', 'ms': 'ms-MY', 'no': 'no-NO',
            'ro': 'ro-RO', 'sk': 'sk-SK', 'sv': 'sv-SE', 'th': 'th-TH',
            'tr': 'tr-TR', 'uk': 'uk-UA', 'vi': 'vi-VN',
            'ca': 'ca-ES', 'hr': 'hr-HR',
            'en-AU': 'en-AU', 'en-IN': 'en-IN', 'en-IE': 'en-IE', 'en-ZA': 'en-ZA',
            'pt-BR': 'pt-BR'
        };

        const iosLangCode = langMap[selectedLang] || 'en-US';

        // Wait for voices to load
        let voices = speechSynthesis.getVoices();
        if (voices.length === 0) {
            await new Promise(resolve => {
                speechSynthesis.onvoiceschanged = resolve;
            });
            voices = speechSynthesis.getVoices();
        }

        // Filter voices by language
        const filteredVoices = voices.filter(voice =>
            voice.lang.startsWith(iosLangCode.split('-')[0])
        );

        console.log(`Found ${filteredVoices.length} voices for ${iosLangCode}:`,
                   filteredVoices.map(v => v.name));

        // Hide loading, show grid
        document.getElementById('iosVoiceLoading').style.display = 'none';
        document.getElementById('iosVoiceGrid').style.display = 'grid';

        // Populate voice grid
        const grid = document.getElementById('iosVoiceGrid');
        grid.innerHTML = '';

        filteredVoices.forEach((voice, index) => {
            const card = document.createElement('div');
            card.className = 'selection-card';
            card.setAttribute('data-voice-name', voice.name);
            card.setAttribute('data-voice-uri', voice.voiceURI);
            card.setAttribute('data-voice-lang', voice.lang);

            const quality = voice.localService ? '‚≠ê' : '‚òÅÔ∏è';

            card.innerHTML = `
                <div class="icon">üé§</div>
                <div class="title">${voice.name.split(' ')[0].toUpperCase()}</div>
                <div class="subtitle">${quality} ${voice.lang}</div>
                <button class="voice-preview-btn" onclick="previewIOSVoice('${voice.name}', event)">‚ñ∂ PREVIEW</button>
            `;

            card.onclick = function() {
                selectIOSVoice(voice.name, voice.voiceURI, voice.lang);
            };

            grid.appendChild(card);
        });

        console.log('‚úÖ iOS voice grid populated');
    }

    function selectIOSVoice(name, uri, lang) {
        console.log('Selected voice:', name, uri, lang);

        // Remove selected class from all cards
        document.querySelectorAll('#iosVoiceGrid .selection-card').forEach(card => {
            card.classList.remove('selected');
        });

        // Add selected to clicked card
        const card = document.querySelector(`[data-voice-name="${name}"]`);
        if (card) {
            card.classList.add('selected');
        }

        // Save to localStorage
        localStorage.setItem('phoenixVoiceName', name);
        localStorage.setItem('phoenixVoiceURI', uri);
        localStorage.setItem('phoenixVoiceLang', lang);

        // Enable continue button
        const continueBtn = document.getElementById('nextPhase2');
        if (continueBtn) {
            continueBtn.disabled = false;
        }

        console.log('‚úÖ Voice selected:', name);
    }

    function previewIOSVoice(voiceName, event) {
        if (event) event.stopPropagation();

        const utterance = new SpeechSynthesisUtterance('Hello! This is how I sound. I am your Phoenix AI assistant.');
        const voices = speechSynthesis.getVoices();
        const voice = voices.find(v => v.name === voiceName);

        if (voice) {
            utterance.voice = voice;
            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
            console.log('üé§ Playing voice preview:', voiceName);
        }
    }

    // ========================================
    // PERSONALITY SELECTION (Phase 3)
    // ========================================
    function selectPersona(persona) {
        console.log('Selected persona:', persona);

        // Remove selected class from all cards
        document.querySelectorAll('#personaGrid .selection-card').forEach(card => {
            card.classList.remove('selected');
        });

        // Add selected to clicked card
        const card = document.querySelector(`[data-persona="${persona}"]`);
        if (card) {
            card.classList.add('selected');
        }

        // Save to localStorage
        localStorage.setItem('phoenixPersonality', persona);

        // Enable continue button
        const continueBtn = document.getElementById('nextPhase3persona');
        if (continueBtn) {
            continueBtn.disabled = false;
        }

        console.log('‚úÖ Persona selected:', persona);
    }

    function testVoicePersona(persona, event) {
        if (event) event.stopPropagation();

        const voiceName = localStorage.getItem('phoenixVoiceName');
        if (!voiceName) {
            alert('Please select a voice in the previous step first!');
            return;
        }

        // Sample phrases for each persona
        const phrases = {
            friendly_helpful: "Hey there! I'm here to help you achieve your goals. Let's make today amazing!",
            professional_serious: "Good day. I'm ready to assist you with your objectives. Let's proceed efficiently.",
            british_refined: "Good afternoon. It would be my pleasure to assist you today. Shall we begin?",
            whimsical_storyteller: "Ah, welcome dear friend! Your journey to greatness begins with a single step...",
            gentle_nurturing: "Hello there. I'm here for you, every step of the way. Take your time.",
            neutral_efficient: "System ready. Awaiting your input. How may I assist you today?",
            motivational_coach: "Let's GO! You've got this! Time to crush those goals! Are you ready?!",
            zen_master: "Breathe. Center yourself. Together, we shall find harmony in your path.",
            tech_genius: "Systems online. All parameters optimized. Ready to compute your success.",
            comedian: "Hey! Did you hear the one about the AI who walked into a bar? Just kidding, let's get to work!",
            therapist: "I'm here to listen and support you. How are you feeling today? Let's talk.",
            commander: "Attention! Mission objectives are clear. We will succeed. Let's execute the plan."
        };

        const utterance = new SpeechSynthesisUtterance(phrases[persona] || 'Hello! This is a test.');
        const voices = speechSynthesis.getVoices();
        const voice = voices.find(v => v.name === voiceName);

        if (voice) {
            utterance.voice = voice;
            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
            console.log('üé§ Testing voice + persona:', voiceName, persona);
        }
    }


    // ========================================
    // OPEN TEXT GOALS (Phase 6)
    // ========================================
    async function saveOpenGoals() {
        const goalsText = document.getElementById('openGoalsText').value.trim();

        if (!goalsText) {
            alert('Please enter your goals before continuing.');
            return;
        }

        console.log('üíæ Saving open text goals:', goalsText);

        // Save to localStorage
        localStorage.setItem('phoenixGoalsText', goalsText);

        // TODO: Send to backend for AI processing
        try {
            const token = localStorage.getItem('phoenixToken');
            if (token) {
                const response = await fetch(`${CONFIG.API_BASE_URL}/users/goals`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        goalsText: goalsText,
                        language: localStorage.getItem('phoenixLanguage') || 'en'
                    })
                });

                if (response.ok) {
                    console.log('‚úÖ Goals saved to backend');
                } else {
                    console.warn('‚ö†Ô∏è  Could not save goals to backend');
                }
            }
        } catch (error) {
            console.error('Error saving goals:', error);
            // Continue anyway - we have it in localStorage
        }

        nextPhase();
    }

    </script>
</body>
</html>
