# Phoenix iOS Development Workflow

## Quick Reference

```bash
# Development (auto-sync www/ → iOS)
npm run watch:ios

# Manual sync
npm run cap:copy

# Open iOS project in Xcode
npm run cap:open:ios

# Full sync (web + plugins)
npm run cap:sync

# Production build
npm run build:ios
```

---

## Project Structure

```
/phoenix-fe/
├── www/                    # WEB FRONTEND (Master - Source of Truth)
│   ├── index.html
│   ├── dashboard.html
│   ├── consciousness-client.js
│   ├── src/
│   └── widgets/
│
├── ios/                    # iOS NATIVE BUNDLE
│   └── App/
│       └── App/
│           ├── AppDelegate.swift
│           ├── Info.plist
│           ├── public/     # Auto-synced from www/
│           └── src/        # iOS native code
│
├── tests/                  # All test files
├── docs/                   # Documentation
└── scripts/                # Build & sync scripts
```

---

## Sync Configuration

### Critical Files

1. **capacitor.config.ts** (PRIMARY)
   ```typescript
   webDir: 'www'  // Must be 'www'
   ```

2. **package.json**
   ```json
   "capacitor": {
     "webDir": "www"  // Must match above
   }
   ```

3. **ios/App/App/capacitor.config.json** (AUTO-GENERATED)
   - Generated by Capacitor
   - Don't edit manually

---

## Development Workflows

### 1. Web Development (Browser)

```bash
# Start local server
npm run dev

# Open browser
open http://localhost:8000
```

**Changes auto-reflect in browser with page refresh.**

### 2. iOS Development (Simulator/Device)

#### Terminal 1: Watch & Sync
```bash
npm run watch:ios
```
This automatically:
- Watches `www/` for file changes
- Syncs to `ios/App/App/public/` on change
- Debounced to 1 second

#### Terminal 2: Xcode
```bash
npm run cap:open:ios
```
Then in Xcode:
- Select simulator/device
- Press Cmd+R to run
- Changes from Terminal 1 auto-reload on rebuild

### 3. Parallel Web + iOS Development

**Recommended setup:**
- Terminal 1: `npm run dev` (web server)
- Terminal 2: `npm run watch:ios` (auto-sync)
- Browser: `localhost:8000` (web testing)
- Xcode: iOS app (mobile testing)

**Workflow:**
1. Edit files in `www/`
2. Refresh browser → see web changes
3. Watch script syncs → rebuild in Xcode → see iOS changes

---

## Sync Commands Explained

| Command | What it does | When to use |
|---------|--------------|-------------|
| `npm run cap:copy` | Copy www/ → iOS only | Development (fast) |
| `npm run cap:sync` | Copy + update plugins | After plugin install |
| `npm run watch:ios` | Auto-sync on file change | Active development |
| `npm run build:ios` | Full production build | Before App Store |

---

## Consciousness Integration

The 20,000 lines of consciousness code works identically in web and iOS:

### Backend (pal-backend)
```
/api/consciousness/
├── /brain              # Cognition, memory, affect
├── /soul               # Qualia, wellbeing, bonds
├── /spirit             # Meaning, will, devotion
└── /integration        # Workspace, pipeline
```

### Frontend (www/)
```javascript
// consciousness-client.js is auto-synced to iOS
const consciousness = new ConsciousnessClient();
await consciousness.initProactive();
```

### iOS Bundle (ios/App/App/public/)
- All www/ files synced automatically
- consciousness-client.js included
- Works identically to web version

---

## Troubleshooting

### Files not syncing to iOS?

1. **Check webDir setting:**
   ```bash
   grep webDir capacitor.config.ts
   grep webDir package.json
   ```
   Both should say `"www"`

2. **Manual sync:**
   ```bash
   npm run cap:copy
   ```

3. **Verify sync worked:**
   ```bash
   ls ios/App/App/public/ | grep consciousness
   ```

### iOS app shows old version?

1. **Clean build in Xcode:**
   - Product → Clean Build Folder (Cmd+Shift+K)
   - Product → Build (Cmd+B)

2. **Delete derived data:**
   - Xcode → Preferences → Locations
   - Click arrow next to Derived Data path
   - Delete DerivedData folder

3. **Fresh sync:**
   ```bash
   rm -rf ios/App/App/public/*
   npm run cap:copy
   ```

### Watch script not auto-syncing?

1. **Check if running:**
   ```bash
   ps aux | grep watch-sync
   ```

2. **Restart watch:**
   ```bash
   # Kill existing
   pkill -f watch-sync

   # Start fresh
   npm run watch:ios
   ```

3. **Manual sync for now:**
   ```bash
   npm run cap:copy
   ```

---

## Production Build Checklist

Before submitting to App Store:

- [ ] All changes committed to git
- [ ] `npm run cap:sync` (full sync)
- [ ] Test in Xcode simulator
- [ ] Test on physical device
- [ ] `npm run build:ios` (production build)
- [ ] Archive in Xcode (Product → Archive)
- [ ] Submit to App Store Connect

---

## File Sync Exclusions

The following are automatically excluded from iOS sync:

- `.DS_Store`
- `node_modules/`
- `.git/`
- `*.map` (source maps)
- Development config files

---

## Best Practices

1. **Always edit in `www/`** - Never edit `ios/App/App/public/` directly
2. **www/ is source of truth** - iOS bundle is a copy
3. **Commit before major syncs** - Easy rollback if needed
4. **Test web first** - Faster iteration cycle
5. **Use watch script** - Don't manually sync repeatedly
6. **Clean builds** - When in doubt, clean and rebuild

---

## Questions?

- Sync issues: Check this guide's Troubleshooting section
- Consciousness API: See `docs/CONSCIOUSNESS-API.md`
- General Phoenix: See main `README.md`
